---
title: Flujo de descarga de documentos legales
slug: descarga-de-documentos-legales
tags:
    [
        auth,
        flutter,
        riverpod,
        dio,
        formz,
        go_router,
        freezed,
        json_annotation,
        pdf,
    ]
description: Flujo de descarga de documentos legales. GestiÃ³n completa del proceso de acceso y descarga de documentos legales.
---

## DescripciÃ³n General

La funcionalidad de **Descarga de Documentos Legales** (`documents_repository`) es el servicio centralizado responsable de gestionar el acceso seguro a todos los documentos legales y contractuales de la plataforma Pisto. Este repositorio proporciona una interfaz unificada para obtener URLs temporales y seguras de documentos, incluyendo contratos de prÃ©stamo, pagarÃ©s, solicitudes y polÃ­ticas legales, garantizando que solo los usuarios autorizados puedan acceder a la documentaciÃ³n correspondiente.

### ğŸ“Š Estructura del Flujo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MÃ³dulo          â”‚â”€â”€â”€â”€â–¶â”‚ DocumentsRepo    â”‚â”€â”€â”€â”€â–¶â”‚ API Segura       â”‚â”€â”€â”€â”€â–¶â”‚ URL Temporal     â”‚â”€â”€â”€â”€â–¶â”‚ Visor/Descarga   â”‚
â”‚ Solicitante     â”‚     â”‚ (ValidaciÃ³n)     â”‚     â”‚ (AutenticaciÃ³n)  â”‚     â”‚ (Firmada)        â”‚     â”‚ (PDF/Nativo)     â”‚
â”‚ (History/Other) â”‚     â”‚                     â”‚     â”‚                     â”‚     â”‚                     â”‚     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ PeticiÃ³n            âœ“ VerificaciÃ³n        âœ“ GeneraciÃ³n         âœ“ Acceso            âœ“ VisualizaciÃ³n
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **Acceso centralizado**: Ãšnico punto de acceso para todos los documentos
-   âœ… **URLs seguras temporales**: URLs firmadas con expiraciÃ³n controlada
-   âœ… **ValidaciÃ³n de permisos**: VerificaciÃ³n automÃ¡tica de acceso autorizado
-   âœ… **Manejo robusto de errores**: RecuperaciÃ³n ante fallos de red o permisos
-   âœ… **Flexibilidad de respuesta**: Soporta mÃºltiples formatos de API
-   âœ… **Logging detallado**: Trazabilidad completa de accesos a documentos
-   âœ… **IntegraciÃ³n mÃºltiple**: Utilizado por varios mÃ³dulos del sistema
-   âœ… **Seguridad financiera**: Cumplimiento con estÃ¡ndares de documentos legales

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

El repositorio de documentos te permite acceder de forma segura a:

-   **Contratos de prÃ©stamo**: Acuerdos legales de tus prÃ©stamos
-   **PagarÃ©s firmados**: Documentos de compromiso de pago
-   **Solicitudes originales**: Tu solicitud inicial de prÃ©stamo
-   **PolÃ­ticas de privacidad**: CÃ³mo manejamos tus datos personales
-   **TÃ©rminos de servicio**: Condiciones de uso de la plataforma

### ğŸ“± CÃ³mo funciona el acceso a documentos

#### Paso 1: Acceso desde diferentes mÃ³dulos

Puedes acceder a documentos desde varias Ã¡reas de la app:

**Desde Historial de PrÃ©stamos:**

1. ğŸ“‹ **Ve a "Historial de PrÃ©stamos"** - En el menÃº lateral
2. ğŸ‘† **Selecciona un prÃ©stamo** - Toca cualquier prÃ©stamo completado
3. ğŸ“„ **Busca "Documentos"** - Encuentra la secciÃ³n de documentos legales
4. ğŸ‘ï¸ **Toca el documento deseado** - Contrato, pagarÃ© o solicitud

**Desde Proceso de PrÃ©stamo:**

1. ğŸ  **Durante la solicitud** - Se te mostrarÃ¡n tÃ©rminos y condiciones
2. ğŸ“‹ **Al completar pasos** - PodrÃ¡s revisar tu solicitud firmada
3. ğŸ“„ **Al aprobar prÃ©stamo** - Acceso al contrato final

#### Paso 2: VerificaciÃ³n de acceso

Cuando solicitas un documento:

**ValidaciÃ³n automÃ¡tica:**

-   ğŸ” **VerificaciÃ³n de identidad**: Confirmamos que eres tÃº
-   ğŸ“‹ **ValidaciÃ³n de permisos**: Comprobamos que puedes acceder
-   ğŸ¦ **Propiedad del prÃ©stamo**: Aseguramos que el documento es tuyo
-   â° **Estado del prÃ©stamo**: Algunos documentos requieren estados especÃ­ficos

**Si todo es vÃ¡lido:**

-   âœ… **URL generada**: Creamos un enlace seguro temporal
-   ğŸ”— **Acceso directo**: Te llevamos al documento
-   ğŸ“± **Visor integrado**: Se abre automÃ¡ticamente

#### Paso 3: VisualizaciÃ³n y descarga

Una vez accedes al documento:

**Opciones disponibles:**

-   ğŸ“– **VisualizaciÃ³n online**: Lee el documento directamente
-   ğŸ” **Zoom y navegaciÃ³n**: Usa gestos para explorar el contenido
-   ğŸ“¤ **Compartir**: EnvÃ­a por email, WhatsApp u otras apps
-   ğŸ’¾ **Descargar**: Guarda una copia en tu dispositivo
-   ğŸ–¨ï¸ **Imprimir**: EnvÃ­a a impresora si es necesario

**Contenido del documento:**

-   ğŸ“„ **Formato PDF**: VisualizaciÃ³n profesional
-   ğŸ·ï¸ **Marca de agua**: IdentificaciÃ³n segura
-   ğŸ“… **Fecha y hora**: CuÃ¡ndo se generÃ³ el documento
-   ğŸ”’ **ProtecciÃ³n**: Documento seguro y validado

#### Paso 4: Seguridad y privacidad

**ProtecciÃ³n de tus documentos:**

-   ğŸ” **Solo tÃº puedes acceder**: VerificaciÃ³n estricta de identidad
-   â° **URLs temporales**: Los enlaces expiran rÃ¡pidamente
-   ğŸ“± **No almacenamiento local**: No guardamos copias sensibles
-   ğŸ” **AuditorÃ­a completa**: Registro de cada acceso

**Buenas prÃ¡cticas:**

-   ğŸ’¾ **Guarda copias importantes**: Descarga documentos que necesites
-   ğŸš« **No compartas con terceros**: Los documentos son confidenciales
-   ğŸ“ **Reporta problemas**: Si no puedes acceder, contacta soporte
-   ğŸ”’ **Cierra sesiÃ³n**: Protege tu cuenta en dispositivos compartidos

### âš ï¸ InformaciÃ³n importante

**Disponibilidad de documentos:**

-   ğŸ“„ Los contratos firmados estÃ¡n disponibles para prÃ©stamos completados
-   â³ Puede haber un pequeÃ±o delay para documentos recientes
-   ğŸ¦ Los pagarÃ©s requieren que el prÃ©stamo estÃ© en estado especÃ­fico

**Consideraciones tÃ©cnicas:**

-   ğŸ“± Necesitas conexiÃ³n a internet para acceder a los documentos
-   ğŸ”— Las URLs tienen tiempo limitado (generalmente 1-24 horas)
-   ğŸ“Š Algunos documentos grandes pueden tardar en cargar
-   ğŸ”„ Si falla la carga, intenta nuevamente o contacta soporte

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ Estructura del Repositorio

El repositorio sigue un patrÃ³n centralizado con manejo robusto de errores:

```
documents_repository/
â”œâ”€â”€ documents_repository.dart       # Repositorio principal
â”œâ”€â”€ models/
â”‚   â””â”€â”€ document_url_response.dart  # Modelo de respuesta URL
â””â”€â”€ exceptions/
    â””â”€â”€ document_exception.dart     # Manejo especÃ­fico de errores
```

### ğŸ“Š Modelo de Datos

#### **DocumentUrlResponse**

Modelo para manejar diferentes formatos de respuesta de la API:

```dart
@freezed
class DocumentUrlResponse with _$DocumentUrlResponse {
  const factory DocumentUrlResponse({
    required String url,                    // URL del documento
  }) = _DocumentUrlResponse;

  factory DocumentUrlResponse.fromJson(Map<String, dynamic> json) =>
      _$DocumentUrlResponseFromJson(json);
}
```

### ğŸ¯ Repositorio Principal

#### **DocumentsRepository**

Clase centralizada con manejo unificado de documentos:

```dart
@riverpod
DocumentsRepository documentsRepository(Ref ref) {
  final httpClient = ref.watch(httpClientProvider);
  return DocumentsRepository(httpClient);
}

class DocumentsRepository {
  final HttpClient _httpClient;

  // MÃ©todos principales:
  // - Future<String> getLoanContract(int loanId)
  // - Future<String> getLoanRequest(int loanId)
  // - Future<String> getLoanContractSigned(int loanId)
  // - Future<String> getPromissoryNoteSigned(int loanId)
  // - Future<String> getPersonalDataPolicy()
  // - Future<String> getTermsOfService()
  // - String _extractUrl(dynamic responseData)
  // - DocumentException _handleDioError(DioException dioError)
}
```

### ğŸŒ Manejo de Errores EspecÃ­fico

#### **DocumentException**

ExcepciÃ³n personalizada para manejo de errores de documentos:

```dart
class DocumentException implements Exception {
  final String message;
  final DocumentExceptionType type;
  final int? statusCode;

  const DocumentException({
    required this.message,
    required this.type,
    this.statusCode,
  });
}

enum DocumentExceptionType {
  networkError,      // Problemas de conectividad
  unauthorizedError, // No autenticado
  notFoundError,     // Documento no encontrado
  timeoutError,      // Tiempo de espera agotado
  serverError,       // Error del servidor
  unknown,           // Error desconocido
}
```

---

## Flujo Completo de Datos

### ğŸ”„ Flujo de Solicitudes

```
MÃ³dulo Solicitante (LoansHistory/OneShot)
  â†“
DocumentsRepository (ValidaciÃ³n y preparaciÃ³n)
  â†“
HTTP Client (Headers de autenticaciÃ³n)
  â†“
API Backend (/client/download-*)
  â”œâ”€â†’ ValidaciÃ³n de permisos
  â”œâ”€â†’ GeneraciÃ³n de URL firmada
  â””â”€â†’ Respuesta con URL temporal
  â†“
_extractUrl() (Procesamiento de respuesta)
  â†“
URL segura devuelta al mÃ³dulo solicitante
  â†“
Visor PDF / Descarga / Compartir
```

### ğŸ“Š Diagrama de Estado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DocumentsRepository                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: Stateless (Cada llamada es independiente)              â”‚
â”‚                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Flujo por solicitud:                                           â”‚
â”‚  1. Validar parÃ¡metros (loanId, autenticaciÃ³n)                 â”‚
â”‚  2. Construir request HTTP con headers seguros                 â”‚
â”‚  3. Llamar endpoint especÃ­fico del documento                   â”‚
â”‚  4. Procesar respuesta (String | JSON)                          â”‚
â”‚  5. Extraer URL y devolver al solicitante                       â”‚
â”‚  6. Manejar errores especÃ­ficos de documentos                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Documentos soportados:                                         â”‚
â”‚  - Contratos de prÃ©stamo (firmados/no firmados)                 â”‚
â”‚  - PagarÃ©s firmados                                             â”‚
â”‚  - Solicitudes originales                                       â”‚
â”‚  - PolÃ­ticas y tÃ©rminos generales                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ Ciclo de Vida de una Solicitud

1. **Solicitud del mÃ³dulo**: LoansHistory solicita contrato firmado
2. **ValidaciÃ³n en repository**: Verifica parÃ¡metros y autenticaciÃ³n
3. **ConstrucciÃ³n de request**: HTTP GET con headers de seguridad
4. **Llamada a API**: `/client/download-loan-contract-signed/{loanId}`
5. **Procesamiento de respuesta**: Extrae URL (String o JSON)
6. **Retorno de URL**: URL temporal firmada al solicitante
7. **Acceso al documento**: MÃ³dulo abre URL en visor o descarga

---

## Componentes y Pasos

### ğŸ”§ MÃ©todos del Repositorio

#### 1. ğŸ“„ getLoanContract(int loanId)

-   **Endpoint**: `/client/download-loan-contract/{loanId}`
-   **PropÃ³sito**: Obtener contrato de prÃ©stamo no firmado
-   **Uso**: Durante proceso de solicitud o revisiÃ³n
-   **ValidaciÃ³n**: Usuario debe ser propietario del prÃ©stamo

#### 2. ğŸ“‹ getLoanRequest(int loanId)

-   **Endpoint**: `/client/download-loan-request/{loanId}`
-   **PropÃ³sito**: Obtener solicitud original de prÃ©stamo
-   **Uso**: DocumentaciÃ³n completa del proceso
-   **ValidaciÃ³n**: Acceso segÃºn estado del prÃ©stamo

#### 3. âœ… getLoanContractSigned(int loanId)

-   **Endpoint**: `/client/download-loan-contract-signed/{loanId}`
-   **PropÃ³sito**: Obtener contrato firmado y ejecutable
-   **Uso**: PrÃ©stamos completados o activos
-   **ValidaciÃ³n**: Estado especÃ­fico requerido

#### 4. ğŸ¦ getPromissoryNoteSigned(int loanId)

-   **Endpoint**: `/client/download-promissory-note-signed/{loanId}`
-   **PropÃ³sito**: Obtener pagarÃ© firmado
-   **Uso**: Documento legal de compromiso de pago
-   **ValidaciÃ³n**: Solo para prÃ©stamos con estados especÃ­ficos

#### 5. ğŸ”’ getPersonalDataPolicy()

-   **Endpoint**: `/client/download-personal-data-policy`
-   **PropÃ³sito**: PolÃ­tica de protecciÃ³n de datos personales
-   **Uso**: InformaciÃ³n legal sobre manejo de datos
-   **ValidaciÃ³n**: Acceso pÃºblico para usuarios autenticados

#### 6. ğŸ“‹ getTermsOfService()

-   **Endpoint**: `/client/download-terms-of-service`
-   **PropÃ³sito**: TÃ©rminos y condiciones de la plataforma
-   **Uso**: Acuerdo de uso del servicio
-   **ValidaciÃ³n**: Acceso pÃºblico para usuarios autenticados

### ğŸ§© Componentes Internos

#### **\_extractUrl(dynamic responseData)**

MÃ©todo auxiliar para manejar diferentes formatos de respuesta:

```dart
String _extractUrl(dynamic responseData) {
  if (responseData is String) {
    // API devuelve String directamente
    return responseData;
  } else if (responseData is Map<String, dynamic>) {
    // API devuelve objeto JSON
    final urlResponse = DocumentUrlResponse.fromJson(responseData);
    return urlResponse.url;
  } else {
    throw DocumentException(
      message: 'Formato de respuesta invÃ¡lido',
      type: DocumentExceptionType.unknown,
    );
  }
}
```

#### **\_handleDioError(DioException dioError)**

Manejo especÃ­fico de errores de red para documentos:

```dart
DocumentException _handleDioError(DioException dioError) {
  // Mapeo detallado de errores HTTP a excepciones de documentos
  // Incluye: timeout, 401 unauthorized, 404 not found, 500 server error
  // Proporciona mensajes especÃ­ficos para cada tipo de error
}
```

---

## APIs Utilizadas

### ğŸ“¡ Endpoints de Documentos

#### **Documentos de PrÃ©stamo**

**GET** `/client/download-loan-contract/{loanId}`

```json
// Response (String directo)
"https://storage.pisto.co/contracts/loan-123-contract.pdf?signature=abc123"

// Response (JSON)
{
  "url": "https://storage.pisto.co/contracts/loan-123-contract.pdf?signature=abc123"
}
```

**GET** `/client/download-loan-request/{loanId}`

```json
// URL temporal para solicitud original
"https://storage.pisto.co/requests/loan-123-request.pdf?signature=def456"
```

**GET** `/client/download-loan-contract-signed/{loanId}`

```json
// URL para contrato firmado
"https://storage.pisto.co/contracts/loan-123-signed.pdf?signature=ghi789"
```

**GET** `/client/download-promissory-note-signed/{loanId}`

```json
// URL para pagarÃ© firmado
"https://storage.pisto.co/notes/loan-123-note.pdf?signature=jkl012"
```

#### **Documentos Generales**

**GET** `/client/download-personal-data-policy`

```json
// URL para polÃ­tica de datos
"https://storage.pisto.co/policies/personal-data.pdf?signature=mno345"
```

**GET** `/client/download-terms-of-service`

```json
// URL para tÃ©rminos de servicio
"https://storage.pisto.co/policies/terms-of-service.pdf?signature=pqr678"
```

### ğŸ”’ Headers de Seguridad

```http
GET /client/download-loan-contract-signed/123 HTTP/1.1
Host: api.pisto.co
Authorization: Bearer {jwt_token}
Content-Type: application/json
X-Client-Version: 1.0.0
X-Device-ID: {device_identifier}
```

### ğŸŒ CaracterÃ­sticas de las URLs

-   **Firmadas digitalmente**: Incluyen signature temporal
-   **ExpiraciÃ³n controlada**: Generalmente 1-24 horas
-   **Acceso Ãºnico**: Cada URL es para una sesiÃ³n especÃ­fica
-   **HTTPS obligatorio**: Solo transporte seguro
-   **Dominio restringido**: Solo desde storage.pisto.co

---

## Manejo de Errores

### âš ï¸ Tipos de Errores

#### **1. Errores de Conectividad**

```dart
// Error de red
NetworkException {
  message: "Error de conexiÃ³n. Verifique su conectividad.",
  canRetry: true,
  retryCallback: () => ref.refresh(documentsRepositoryProvider),
}

// Timeout
TimeoutException {
  message: "Tiempo de espera agotado. Intente nuevamente.",
  canRetry: true,
  retryDelay: Duration(seconds: 5),
}
```

#### **2. Errores de AutorizaciÃ³n**

```dart
// No autenticado
UnauthorizedException {
  message: "No autorizado. Inicie sesiÃ³n nuevamente.",
  action: "redirect_to_login",
}

// Sin permisos
ForbiddenException {
  message: "No tienes permiso para acceder a este documento.",
  reason: "loan_ownership_required",
}
```

#### **3. Errores de Recursos**

```dart
// Documento no encontrado
DocumentNotFoundException {
  message: "El documento solicitado no existe.",
  suggestion: "Verifique el ID del prÃ©stamo",
}

// Documento no disponible
DocumentNotAvailableException {
  message: "Este documento aÃºn no estÃ¡ disponible.",
  reason: "loan_status_incomplete",
  expectedStatus: "completed",
}
```

#### **4. Errores del Servidor**

```dart
// Error interno
ServerException {
  message: "Error temporal del servidor. Intente mÃ¡s tarde.",
  canRetry: true,
  retryAfter: 300, // 5 minutos
}

// Error de generaciÃ³n
DocumentGenerationException {
  message: "Error al generar el documento.",
  action: "contact_support",
}
```

### ğŸ”„ Estrategias de RecuperaciÃ³n

#### **Reintentos AutomÃ¡ticos**

```dart
class DocumentRetryStrategy {
  static const int maxRetries = 3;
  static const Duration baseDelay = Duration(seconds: 2);

  static Future<String> retryWithBackoff(
    Future<String> Function() documentCall,
  ) async {
    for (int attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await documentCall();
      } catch (e) {
        if (attempt == maxRetries) rethrow;

        // Backoff exponencial
        final delay = baseDelay * math.pow(2, attempt - 1);
        await Future.delayed(delay);
      }
    }
    throw DocumentException(
      message: 'No se pudo obtener el documento despuÃ©s de $maxRetries intentos',
      type: DocumentExceptionType.unknown,
    );
  }
}
```

#### **Fallback para Usuario**

-   **OpciÃ³n de reintentar manual** la descarga
-   **Contactar soporte** con diagnÃ³stico automÃ¡tico
-   **Acceso alternativo** por email si falla la app
-   **Modo offline** con documentos previamente cacheados

---

## Validaciones

### âœ… Validaciones Implementadas

1. **ValidaciÃ³n de AutenticaciÃ³n**

    - VerificaciÃ³n de token JWT vÃ¡lido
    - ConfirmaciÃ³n de sesiÃ³n activa
    - ValidaciÃ³n de permisos de usuario

2. **ValidaciÃ³n de Acceso**

    - Propiedad del prÃ©stamo (solo dueÃ±o puede acceder)
    - Estado del prÃ©stamo (algunos documentos requieren estados especÃ­ficos)
    - Disponibilidad del documento (generado y firmado)

3. **ValidaciÃ³n de ParÃ¡metros**
    - Formato vÃ¡lido de loanId (entero positivo)
    - Headers requeridos presentes
    - LÃ­mites de rate limiting

### ğŸ” LÃ³gica de ValidaciÃ³n

#### **ValidaciÃ³n de Disponibilidad de Documentos**

```dart
class DocumentAvailabilityValidator {
  static bool canDownloadContract(int loanStatus) {
    // Contrato disponible para prÃ©stamos aprobados o completados
    return [3, 7, 8, 12].contains(loanStatus);
  }

  static bool canDownloadSignedDocuments(int loanStatus) {
    // Documentos firmados solo para estados finales
    return [7, 8, 12].contains(loanStatus);
  }

  static ValidationResult validateDocumentAccess(
    int loanId,
    int userId,
    int loanStatus,
    DocumentType documentType,
  ) {
    // Validar propiedad del prÃ©stamo
    if (!_isLoanOwner(loanId, userId)) {
      return ValidationResult.invalid(
        'No tienes permiso para acceder a este documento',
      );
    }

    // Validar disponibilidad segÃºn tipo
    switch (documentType) {
      case DocumentType.contractSigned:
        if (!canDownloadSignedDocuments(loanStatus)) {
          return ValidationResult.invalid(
            'El contrato firmado aÃºn no estÃ¡ disponible',
          );
        }
        break;
      case DocumentType.promissoryNote:
        if (!canDownloadSignedDocuments(loanStatus)) {
          return ValidationResult.invalid(
            'El pagarÃ© aÃºn no estÃ¡ disponible',
          );
        }
        break;
      default:
        // Otros documentos tienen validaciones especÃ­ficas
        break;
    }

    return ValidationResult.valid();
  }
}
```

#### **ValidaciÃ³n de URLs Seguras**

```dart
class SecureUrlValidator {
  static bool isValidDocumentUrl(String url) {
    // Validar dominio permitido
    if (!url.startsWith('https://storage.pisto.co/')) {
      return false;
    }

    // Validar presencia de firma
    if (!url.contains('signature=')) {
      return false;
    }

    // Validar formato de PDF
    if (!url.endsWith('.pdf')) {
      return false;
    }

    return true;
  }

  static DateTime extractExpiryFromUrl(String url) {
    // Extraer timestamp de la URL si estÃ¡ disponible
    // Validar que no estÃ© expirada
  }
}
```

### ğŸ›¡ï¸ Consideraciones de Privacidad

-   Las URLs tienen expiraciÃ³n temporal automÃ¡tica
-   No se almacenan URLs localmente en el dispositivo
-   AuditorÃ­a completa de cada acceso a documentos
-   Rate limiting para prevenir accesos abusivos
-   EncriptaciÃ³n en trÃ¡nsito obligatoria

---

## Testing

### ğŸ§ª Estrategia de Testing

#### **1. Unit Tests**

```dart
// test/unit/documents_repository_test.dart
void main() {
  group('DocumentsRepository', () {
    test('debe obtener URL de contrato correctamente', () {
      // Test de obtenciÃ³n de contrato
    });

    test('debe manejar respuesta JSON y String', () {
      // Test de _extractUrl con diferentes formatos
    });

    test('debe lanzar excepciÃ³n para documento no encontrado', () {
      // Test de manejo de 404
    });
  });
}
```

#### **2. Integration Tests**

```dart
// test/integration/documents_flow_test.dart
void main() {
  integrationTest('flujo completo de acceso a documentos', () async {
    // Simular: historial â†’ detalle â†’ documento â†’ visor
  });

  integrationTest('manejo de errores de red', () async {
    // Test de recuperaciÃ³n ante fallos de conectividad
  });
}
```

### ğŸ“‹ Casos de Prueba CrÃ­ticos

#### **Flujos de Usuario**

-   âœ… Usuario accede a contrato firmado desde historial
-   âœ… Usuario descarga polÃ­tica de datos desde onboarding
-   âœ… Usuario maneja error de documento no disponible
-   âœ… Usuario reintenta despuÃ©s de error de red
-   âœ… Usuario comparte documento por email

#### **Casos LÃ­mite**

-   ğŸ”„ URL expirada durante acceso
-   ğŸ”„ Documento muy grande que causa timeout
-   ğŸ”„ Token expirado durante descarga
-   ğŸ”„ PrÃ©stamo sin documentos generados
-   ğŸ”„ Rate limiting activado

### ğŸ“Š MÃ©tricas de Testing

-   **Cobertura mÃ­nima**: 90% para cÃ³digo crÃ­tico de seguridad
-   **Tests de API**: Todos los endpoints cubiertos
-   **Tests de error**: Todos los tipos de error cubiertos
-   **Tests de seguridad**: ValidaciÃ³n de acceso y permisos

---

## Seguridad

### ğŸ”’ CaracterÃ­sticas de Seguridad

#### **1. ProtecciÃ³n de Acceso**

-   âœ… **AutenticaciÃ³n obligatoria**: Token JWT requerido
-   âœ… **ValidaciÃ³n de propiedad**: Solo dueÃ±o del prÃ©stamo
-   âœ… **Control por estado**: Documentos segÃºn estado del prÃ©stamo
-   âœ… **URLs temporales**: ExpiraciÃ³n automÃ¡tica de enlaces

#### **2. Seguridad en TrÃ¡nsito**

-   âœ… **HTTPS obligatorio**: Todo encriptado en trÃ¡nsito
-   âœ… **URLs firmadas**: Firmas digitales previenen manipulaciÃ³n
-   âœ… **Headers seguros**: ValidaciÃ³n de cliente y dispositivo
-   âœ… **Rate limiting**: ProtecciÃ³n contra accesos abusivos

#### **3. AuditorÃ­a y Logging**

```dart
class DocumentSecurityLogger {
  static void logDocumentAccess(
    int userId,
    int loanId,
    DocumentType documentType,
    String ipAddress,
    bool success,
  ) {
    // Registro completo para auditorÃ­a
    // Incluye: timestamp, user, document, IP, resultado
  }

  static void detectSuspiciousAccess(
    int userId,
    int accessCount,
    Duration timeWindow,
  ) {
    // DetecciÃ³n de patrones anÃ³malos
    // Alertas de seguridad si es necesario
  }
}
```

### ğŸ›¡ï¸ Consideraciones de Privacidad

#### **Datos Sensibles**

-   âŒ **No almacenamiento local**: URLs no persisten en dispositivo
-   âŒ **No cachÃ© de documentos**: Siempre se obtienen del servidor
-   âœ… **Memoria volÃ¡til**: URLs solo durante la sesiÃ³n
-   âœ… **EliminaciÃ³n garantizada**: Clean up explÃ­cito en todos los casos

#### **Cumplimiento Normativo**

-   ğŸ“‹ **ProtecciÃ³n financiera**: Cumplimiento con regulaciones de documentos
-   ğŸ” **Audit trail**: Registro completo de accesos a documentos legales
-   ğŸ“Š **RetenciÃ³n controlada**: PolÃ­ticas de retenciÃ³n segÃºn normativa
-   ğŸ¦ **Banking compliance**: EstÃ¡ndares de manejo de documentos financieros

### ğŸ” Best Practices Implementadas

```dart
// Ejemplo de implementaciÃ³n segura
class SecureDocumentAccess {
  Future<String> getSecureDocumentUrl(
    int loanId,
    DocumentType type,
    UserContext user,
  ) async {
    try {
      // 1. Validar autenticaciÃ³n y permisos
      await _validateDocumentAccess(loanId, type, user);

      // 2. Obtener URL firmada temporal
      final secureUrl = await _documentsRepository.getDocumentUrl(loanId, type);

      // 3. Validar seguridad de la URL
      if (!_securityValidator.isValidDocumentUrl(secureUrl)) {
        throw SecurityException('URL de documento invÃ¡lida');
      }

      // 4. Registrar acceso para auditorÃ­a
      _securityLogger.logDocumentAccess(user.id, loanId, type, true);

      return secureUrl;
    } catch (e) {
      _securityLogger.logDocumentAccess(user.id, loanId, type, false);
      throw SecureDocumentException.fromError(e);
    }
  }
}
```

---

## ğŸš€ ImplementaciÃ³n y Mantenimiento

### ğŸ“¦ Dependencias Clave

```yaml
dependencies:
    flutter_riverpod: ^2.4.0 # GestiÃ³n de estado
    dio: ^5.3.0 # Cliente HTTP
    freezed_annotation: ^2.4.0 # Modelos inmutables
    json_annotation: ^4.8.0 # SerializaciÃ³n JSON

dev_dependencies:
    riverpod_generator: ^2.3.0 # Code generation
    freezed: ^2.4.0 # GeneraciÃ³n de modelos
    json_serializable: ^6.7.0 # GeneraciÃ³n JSON
    build_runner: ^2.4.0 # Herramienta de generaciÃ³n
```

### ğŸ”§ Comandos de Desarrollo

```bash
# Generar cÃ³digo (requerido despuÃ©s de cambios)
dart run build_runner build --delete-conflicting-outputs

# Modo watch durante desarrollo
dart run build_runner watch -d

# Ejecutar pruebas
flutter test test/shared/repositories/documents_repository_test.dart

# AnÃ¡lisis estÃ¡tico
flutter analyze lib/shared/repositories/documents_repository.dart
```

### ğŸ“ Mejores PrÃ¡cticas

1. **Code Generation**: Siempre ejecutar `build_runner` despuÃ©s de modificar modelos
2. **Error Handling**: Manejar especÃ­ficamente cada tipo de error de documento
3. **Security**: Nunca almacenar URLs de documentos localmente
4. **Testing**: Mantener cobertura >90% para cÃ³digo de seguridad
5. **Logging**: Registrar todos los accesos para auditorÃ­a
6. **Performance**: Usar timeouts apropiados para documentos grandes

---

## ğŸ”— Integraciones

### ğŸ“„ MÃ³dulos que utilizan DocumentsRepository

#### **Loans History**

-   Acceso a contratos firmados y pagarÃ©s
-   Documentos de prÃ©stamos completados
-   URLs para visor PDF integrado

#### **One Shot (Proceso de PrÃ©stamo)**

-   Contratos durante proceso de solicitud
-   TÃ©rminos y condiciones durante onboarding
-   PolÃ­ticas de privacidad en registro

#### **Auth (Potencialmente)**

-   TÃ©rminos de servicio al aceptar registro
-   PolÃ­ticas de privacidad al crear cuenta

### ğŸ”„ Flujo de Datos

```
MÃ³dulo Solicitante
  â†“
DocumentsRepository (ValidaciÃ³n + API)
  â†“
Storage Seguro (URLs temporales)
  â†“
Visor PDF / Descarga
```
