---
title: Flujo de cÃ³digos promocionales
slug: codigos-promocionales
tags: [auth, flutter, riverpod, dio, formz, go_router, freezed, json_annotation]
description: Flujo de cÃ³digos promocionales. GestiÃ³n completa del proceso de generaciÃ³n y aplicaciÃ³n de cÃ³digos promocionales.
---

## DescripciÃ³n General

La funcionalidad de **CÃ³digos Promocionales** (`promo_code`) es el sistema completo que gestiona el programa de referidos y descuentos de la plataforma Pisto. Este mÃ³dulo permite a los usuarios generar su propio cÃ³digo promocional, aplicar cÃ³digos de otros usuarios para obtener descuentos, y llevar un registro completo de su historial de cÃ³digos utilizados y descuentos obtenidos. El sistema fomenta el crecimiento orgÃ¡nico de la plataforma mediante incentivos econÃ³micos para usuarios nuevos y existentes.

### ğŸ“Š Estructura del Flujo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mi PrÃ©stamo      â”‚â”€â”€â”€â”€â–¶â”‚ AplicaciÃ³n de    â”‚â”€â”€â”€â”€â–¶â”‚ ValidaciÃ³n      â”‚â”€â”€â”€â”€â–¶â”‚ Descuento        â”‚â”€â”€â”€â”€â–¶â”‚ Historial        â”‚
â”‚ (Solicitud)     â”‚     â”‚ CÃ³digo Promocionalâ”‚     â”‚ (API Backend)   â”‚     â”‚ Aplicado         â”‚     â”‚ (Registro)       â”‚
â”‚                 â”‚     â”‚ (Formulario)     â”‚     â”‚                     â”‚     â”‚                     â”‚     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ Ingreso manual      âœ“ ValidaciÃ³n          âœ“ Descuento         âœ“ ActualizaciÃ³n      âœ“ Seguimiento
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **GeneraciÃ³n automÃ¡tica**: Cada usuario tiene su propio cÃ³digo promocional
-   âœ… **ValidaciÃ³n en tiempo real**: VerificaciÃ³n instantÃ¡nea de cÃ³digos
-   âœ… **Descuentos automÃ¡ticos**: AplicaciÃ³n directa al monto del prÃ©stamo
-   âœ… **Historial completo**: Registro de todos los cÃ³digos utilizados
-   âœ… **Sistema de referidos**: Beneficios para both referente y referido
-   âœ… **Control de uso**: PrevenciÃ³n de uso mÃºltiple del mismo cÃ³digo
-   âœ… **Interfaz intuitiva**: Formulario simple y claro para aplicar cÃ³digos
-   âœ… **EstadÃ­sticas de uso**: MÃ©tricas de rendimiento del programa

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirven los cÃ³digos promocionales?

Los cÃ³digos promocionales te permiten:

-   **Obtener descuentos**: Reduce el interÃ©s o comisiones de tu prÃ©stamo
-   **Referir amigos**: Comparte tu cÃ³digo y gana beneficios
-   **Ahorrar dinero**: Menores costos en tus prÃ©stamos
-   **Ayudar a otros**: Tus amigos obtienen descuentos con tu cÃ³digo
-   **Llevar control**: Revisa tu historial de cÃ³digos utilizados

### ğŸ“± CÃ³mo usar cÃ³digos promocionales

#### Paso 1: Obtener tu cÃ³digo promocional

Tu cÃ³digo se genera automÃ¡ticamente:

**Desde el historial de cÃ³digos:**

1. ğŸ  **Abre el menÃº lateral** - Toca el Ã­cono de hamburguesa (â˜°)
2. ğŸ“‹ **Busca "CÃ³digo Promocional"** - Encuentra la opciÃ³n en el menÃº
3. ğŸ‘ï¸ **Ver tu cÃ³digo** - Tu cÃ³digo personal aparecerÃ¡ destacado
4. ğŸ“¤ **Compartirlo** - Toca "Compartir" para enviarlo a amigos

**CaracterÃ­sticas de tu cÃ³digo:**

-   ğŸ”¤ **Formato Ãºnico**: Generalmente 6-8 caracteres alfanumÃ©ricos
-   ğŸ”„ **Siempre activo**: Tu cÃ³digo no expira mientras estÃ©s activo
-   ğŸ“Š **Sin lÃ­mite de uso**: Varios amigos pueden usar tu cÃ³digo
-   ğŸ’° **Beneficios automÃ¡ticos**: Ganas descuentos cuando lo usan

#### Paso 2: Aplicar un cÃ³digo promocional

Cuando solicitas un prÃ©stamo:

**Durante el proceso de solicitud:**

1. ğŸ  **Inicia solicitud de prÃ©stamo** - Ve a "Mi PrÃ©stamo" o "Solicitar"
2. ğŸ“‹ **Busca "CÃ³digo Promocional"** - Encuentra el campo en el formulario
3. âŒ¨ï¸ **Ingresa el cÃ³digo** - Escribe el cÃ³digo que recibiste
4. âœ… **ValidaciÃ³n automÃ¡tica** - El sistema verificarÃ¡ el cÃ³digo
5. ğŸ’° **Descuento aplicado** - VerÃ¡s el descuento en el cÃ¡lculo

**ValidaciÃ³n del cÃ³digo:**

-   âœ… **CÃ³digo vÃ¡lido**: El descuento se aplica automÃ¡ticamente
-   âŒ **CÃ³digo invÃ¡lido**: Mensaje claro de por quÃ© no funciona
-   âš ï¸ **Ya utilizado**: No puedes usar el mismo cÃ³digo dos veces
-   ğŸš« **Tu propio cÃ³digo**: No puedes aplicar tu propio cÃ³digo

#### Paso 3: Verificar el descuento aplicado

Una vez aplicado el cÃ³digo:

**ConfirmaciÃ³n visual:**

-   ğŸ’° **Monto original**: VerÃ¡s el monto sin descuento
-   ğŸ“‰ **Descuento aplicado**: Cantidad descontada automÃ¡ticamente
-   ğŸ’µ **Nuevo total**: Monto final con el descuento incluido
-   âœ… **ConfirmaciÃ³n verde**: Indicador de que se aplicÃ³ correctamente

**Detalles del descuento:**

-   ğŸ“Š **Porcentaje o monto fijo**: SegÃºn el tipo de promociÃ³n
-   ğŸ·ï¸ **CÃ³digo usado**: Referencia del cÃ³digo aplicado
-   ğŸ“… **Fecha de aplicaciÃ³n**: CuÃ¡ndo se utilizÃ³ el cÃ³digo
-   ğŸ”„ **No reversible**: El cÃ³digo aplicado no se puede cambiar

#### Paso 4: Consultar tu historial

Revisa toda tu actividad de cÃ³digos:

**Desde la pantalla de cÃ³digos:**

1. ğŸ“‹ **Accede a "CÃ³digo Promocional"** - En el menÃº lateral
2. ğŸ“Š **SecciÃ³n "Historial"** - Lista completa de actividad
3. ğŸ‘ï¸ **CÃ³digos usados por ti** - Los que has aplicado a tus prÃ©stamos
4. ğŸ¯ **CÃ³digos usados por otros** - Quienes usaron tu cÃ³digo

**InformaciÃ³n disponible:**

-   ğŸ“… **Fechas de uso**: CuÃ¡ndo se aplicaron los cÃ³digos
-   ğŸ’° **Descuentos obtenidos**: CuÃ¡nto ahorraste
-   ğŸ‘¥ **Referidos exitosos**: Quienes usaron tu cÃ³digo
-   ğŸ“ˆ **EstadÃ­sticas generales**: Tu impacto en el programa

### âš ï¸ InformaciÃ³n importante

**Reglas de uso:**

-   ğŸš« **Un cÃ³digo por prÃ©stamo**: Solo puedes aplicar un cÃ³digo cada vez
-   ğŸ”„ **No se puede cambiar**: Una vez aplicado, no hay modificaciones
-   ğŸ‘¤ **CÃ³digos de otros**: Solo puedes usar cÃ³digos de otros usuarios
-   â° **ValidaciÃ³n instantÃ¡nea**: El cÃ³digo se valida al momento de ingresarlo

**Beneficios del programa:**

-   ğŸ’° **Para el referido**: Descuento en su primer prÃ©stamo
-   ğŸ **Para el referente**: Bonificaciones o descuentos futuros
-   ğŸ“Š **Sin lÃ­mites**: Puedes referir a tantos amigos como quieras
-   ğŸ”„ **Beneficios acumulables**: Ganas mÃ¡s entre mÃ¡s referidos tengas

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ Estructura del MÃ³dulo

El mÃ³dulo de cÃ³digos promocionales sigue una arquitectura dual con separaciÃ³n clara de responsabilidades:

```
promo_code/
â”œâ”€â”€ entities/                    # Entidades de dominio
â”‚   â”œâ”€â”€ promo_code_history_entity.dart     # Historial completo
â”‚   â”œâ”€â”€ used_foreign_promo_code_entity.dart # CÃ³digos usados por el usuario
â”‚   â””â”€â”€ times_used_own_code_entity.dart    # Uso del cÃ³digo propio
â”œâ”€â”€ models/                      # DTOs para API
â”‚   â”œâ”€â”€ promo_code_history_response_dto.dart # Respuesta del historial
â”‚   â”œâ”€â”€ times_used_own_code_dto.dart       # DTO de uso propio
â”‚   â””â”€â”€ used_foreign_promo_code_dto.dart   # DTO de uso externo
â”œâ”€â”€ providers/                   # GestiÃ³n de estado
â”‚   â””â”€â”€ promo_code_history_provider.dart   # Estado del historial
â”œâ”€â”€ repositories/               # Acceso a datos
â”‚   â””â”€â”€ promo_code_history_repository.dart # API del historial
â””â”€â”€ screens/                    # Interfaces de usuario
    â””â”€â”€ promo_code_history_screen.dart     # Pantalla principal

my_loan/ (integraciÃ³n)
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ promo_code_entity.dart             # Entidad de validaciÃ³n
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ promo_code_request_dto.dart        # Request de validaciÃ³n
â”‚   â””â”€â”€ promo_code_response_dto.dart       # Response de validaciÃ³n
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ promo_code_provider.dart           # Estado de validaciÃ³n
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ promo_code_repository.dart         # API de validaciÃ³n
â””â”€â”€ widgets/
    â””â”€â”€ promo_code_widget.dart             # UI de aplicaciÃ³n
```

### ğŸ“Š Entities (Entidades de Dominio)

#### **PromoCodeHistoryEntity**

Entidad principal que contiene toda la informaciÃ³n del cÃ³digo promocional:

```dart
@freezed
class PromoCodeHistoryEntity with _$PromoCodeHistoryEntity {
  const factory PromoCodeHistoryEntity({
    required String promoCode,                    // CÃ³digo del usuario
    required List<TimesUsedOwnCodeEntity> timesUsedOwnCode,    // Uso propio
    required int referralDiscounts,               // Descuentos de referidos
    required List<UsedForeignPromoCodeEntity> usedForeignPromoCodes, // CÃ³digos usados
  }) = _PromoCodeHistoryEntity;
}
```

#### **TimesUsedOwnCodeEntity**

Registro de cuÃ¡ntas veces se ha usado el cÃ³digo propio:

```dart
@freezed
class TimesUsedOwnCodeEntity with _$TimesUsedOwnCodeEntity {
  const factory TimesUsedOwnCodeEntity({
    required String code,                         // CÃ³digo promocional
    required int quantity,                        // Veces usado
    required bool active,                         // Si estÃ¡ activo
  }) = _TimesUsedOwnCodeEntity;
}
```

#### **UsedForeignPromoCodeEntity**

Registro de cÃ³digos de otros usuarios utilizados:

```dart
@freezed
class UsedForeignPromoCodeEntity with _$UsedForeignPromoCodeEntity {
  const factory UsedForeignPromoCodeEntity({
    required String code,                         // CÃ³digo usado
    required DateTime date,                       // Fecha de uso
  }) = _UsedForeignPromoCodeEntity;
}
```

### ğŸ¯ Providers (GestiÃ³n de Estado)

#### **PromoCodeHistoryNotifier**

StateNotifier para el historial de cÃ³digos:

```dart
@Riverpod(keepAlive: true)
class PromoCodeHistoryNotifier extends _$PromoCodeHistoryNotifier {
  @override
  PromoCodeHistoryState build() {
    return const PromoCodeHistoryState();
  }

  // MÃ©todos principales:
  // - Future<void> loadPromoCodeHistory()
  // - Future<void> refresh()
  // - void clearError()
  // - void reset()
}

@freezed
class PromoCodeHistoryState with _$PromoCodeHistoryState {
  const factory PromoCodeHistoryState({
    @Default(PromoCodeHistoryStatus.initial) PromoCodeHistoryStatus status,
    PromoCodeHistoryEntity? data,
    String? errorMessage,
  }) = _PromoCodeHistoryState;
}

enum PromoCodeHistoryStatus { initial, loading, loaded, error }
```

#### **PromoCodeFormNotifier** (en my_loan)

StateNotifier para validaciÃ³n de cÃ³digos:

```dart
@riverpod
class PromoCodeFormNotifier extends _$PromoCodeFormNotifier {
  @override
  PromoCodeFormState build() {
    return const PromoCodeFormState();
  }

  // MÃ©todos principales:
  // - void onPromoCodeChange(String value)
  // - Future<void> validatePromoCode()
  // - void clearPromoCode()
}

@freezed
class PromoCodeFormState with _$PromoCodeFormState {
  const factory PromoCodeFormState({
    @Default(PromoCodeInput.pure()) PromoCodeInput promoCode,
    @Default(FormzSubmissionStatus.initial) FormzSubmissionStatus status,
    @Default(false) bool isValid,
    String? errorMessage,
    @Default(false) bool isLoading,
    @Default(false) bool isApplied,
  }) = _PromoCodeFormState;
}
```

### ğŸŒ Repositories (Acceso a Datos)

#### **PromoCodeHistoryRepository**

Repository para consulta de historial:

```dart
class PromoCodeHistoryRepository {
  Future<PromoCodeHistoryEntity> getPromoCodeHistory() async {
    // GET /client/promo-code
    // Retorna historial completo del usuario
  }
}
```

#### **PromoCodeRepository** (en my_loan)

Repository para validaciÃ³n de cÃ³digos:

```dart
abstract class IPromoCodeRepository {
  Future<PromoCodeValidationResult> validatePromoCode(String promoCode);
}

class PromoCodeRepository implements IPromoCodeRepository {
  @override
  Future<PromoCodeValidationResult> validatePromoCode(String promoCode) async {
    // POST /client/validate-promo-code
    // Valida y aplica cÃ³digo promocional
  }
}
```

---

## Flujo Completo de Datos

### ğŸ”„ Flujo de ValidaciÃ³n y AplicaciÃ³n

```
Formulario de PrÃ©stamo (MyLoan)
  â†“
PromoCodeFormNotifier (ValidaciÃ³n local)
  â†“
PromoCodeRepository (POST /client/validate-promo-code)
  â”œâ”€â†’ ValidaciÃ³n backend
  â”œâ”€â†’ VerificaciÃ³n de disponibilidad
  â”œâ”€â†’ CÃ¡lculo de descuento
  â””â”€â†’ Respuesta con resultado
  â†“
PromoCodeValidationResult (Success/Error/AlreadyUsed/OwnCode)
  â†“
ActualizaciÃ³n de UI (Descuento aplicado o mensaje de error)
  â†“
LoanCalculator (RecÃ¡lculo con descuento)
```

### ğŸ”„ Flujo de Consulta de Historial

```
MenÃº Principal
  â†“
PromoCodeHistoryScreen
  â†“
PromoCodeHistoryNotifier (loadPromoCodeHistory)
  â†“
PromoCodeHistoryRepository (GET /client/promo-code)
  â”œâ”€â†’ Obtener cÃ³digo propio
  â”œâ”€â†’ Cargar uso del cÃ³digo propio
  â”œâ”€â†’ Listar cÃ³digos externos usados
  â””â”€â†’ Calcular descuentos de referidos
  â†“
PromoCodeHistoryEntity (Datos completos)
  â†“
UI renderizada con estadÃ­sticas e historial
```

### ğŸ“Š Diagrama de Estados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PromoCodeFormNotifier                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: initial â†’ validating â†’ success/error â†’ applied         â”‚
â”‚                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Datos:                                                        â”‚
â”‚  - promoCode: PromoCodeInput (validaciÃ³n local)                â”‚
â”‚  - status: FormzSubmissionStatus (estado del formulario)       â”‚
â”‚  - isValid: bool (formulario vÃ¡lido)                           â”‚
â”‚  - isApplied: bool (cÃ³digo aplicado al prÃ©stamo)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Acciones:                                                     â”‚
â”‚  - onPromoCodeChange(): ValidaciÃ³n en tiempo real              â”‚
â”‚  - validatePromoCode(): ValidaciÃ³n backend y aplicaciÃ³n        â”‚
â”‚  - clearPromoCode(): Reset del formulario                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PromoCodeHistoryNotifier                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: initial â†’ loading â†’ loaded â†’ error                      â”‚
â”‚                                                               â†‘ refresh â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Datos:                                                        â”‚
â”‚  - data: PromoCodeHistoryEntity? (historial completo)          â”‚
â”‚  - status: PromoCodeHistoryStatus (estado de carga)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Acciones:                                                     â”‚
â”‚  - loadPromoCodeHistory(): Carga desde API                      â”‚
â”‚  - refresh(): Recarga manual                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Componentes y Pasos

### ğŸ“± Pantallas del Flujo

#### 1. ğŸ’³ PromoCodeWidget (integrado en MyLoan)

-   **UbicaciÃ³n**: Dentro del formulario de prÃ©stamo
-   **PropÃ³sito**: Aplicar cÃ³digos promocionales durante solicitud
-   **Funcionalidad**:
    -   Campo de texto para ingreso de cÃ³digo
    -   ValidaciÃ³n en tiempo real mientras se escribe
    -   BotÃ³n de "Aplicar" con estado de loading
    -   Indicador visual de Ã©xito o error
    -   Mostrar descuento aplicado con cÃ¡lculo

#### 2. ğŸ“Š PromoCodeHistoryScreen

-   **Ruta**: `/promo-code-history`
-   **PropÃ³sito**: Vista completa del historial y estadÃ­sticas
-   **Funcionalidad**:
    -   CÃ³digo promocional propio destacado
    -   BotÃ³n de compartir cÃ³digo propio
    -   SecciÃ³n de historial de cÃ³digos usados
    -   EstadÃ­sticas de referidos y descuentos
    -   Pull-to-refresh para actualizar datos
    -   Manejo de estados loading/error/empty

### ğŸ§© Componentes Reutilizables

#### **PromoCodeInput**

Input personalizado para cÃ³digos promocionales:

```dart
class PromoCodeInput extends FormzInput<String, PromoCodeValidationError> {
  // ValidaciÃ³n de formato de cÃ³digo
  // Reglas de longitud y caracteres permitidos
}
```

#### **PromoCodeCard**

Componente visual para mostrar informaciÃ³n de cÃ³digo:

```dart
class PromoCodeCard extends StatelessWidget {
  final String code;
  final double discount;
  final DateTime date;
  final bool isOwnCode;

  // Muestra: cÃ³digo, descuento, fecha, tipo
}
```

---

## APIs Utilizadas

### ğŸ“¡ Endpoints de API

#### **POST** `/client/validate-promo-code`

**PropÃ³sito**: Validar y aplicar un cÃ³digo promocional

**Request Body**:

```json
{
    "promoCode": "REF12345"
}
```

**Response Exitoso (200)**:

```json
{
    "validatePromoCode": 50.0
}
```

**Errores de ValidaciÃ³n (422)**:

```json
{
  "errors": [
    {
      "message": "Este cÃ³digo ya ha sido utilizado"
    }
  ]
}
{
  "errors": [
    {
      "message": "No puedes usar tu propio cÃ³digo promocional"
    }
  ]
}
{
  "errors": [
    {
      "message": "El cÃ³digo promocional no es vÃ¡lido"
    }
  ]
}
```

#### **GET** `/client/promo-code`

**PropÃ³sito**: Obtener historial completo de cÃ³digos promocionales

**Headers Requeridos**:

```
Authorization: Bearer {token}
Content-Type: application/json
```

**Response Exitoso (200)**:

```json
{
    "promoCode": "USER67890",
    "timesUsedOwnCode": [
        {
            "code": "USER67890",
            "quantity": 5,
            "active": true
        }
    ],
    "referralDiscounts": 250.0,
    "usedForeignPromoCodes": [
        {
            "code": "REF12345",
            "date": "2025-11-01T10:30:00Z"
        },
        {
            "code": "REF67890",
            "date": "2025-10-15T14:20:00Z"
        }
    ]
}
```

**Error 401 (Unauthorized)**:

```json
{
    "message": "Usuario no autenticado"
}
```

### ğŸ”’ Headers de Seguridad

```http
POST /client/validate-promo-code HTTP/1.1
Host: api.pisto.co
Authorization: Bearer {jwt_token}
Content-Type: application/json
X-Client-Version: 1.0.0
X-Device-ID: {device_identifier}
```

---

## Manejo de Errores

### âš ï¸ Tipos de Errores

#### **1. Errores de ValidaciÃ³n**

```dart
// CÃ³digo ya utilizado
AlreadyUsedException {
  message: "Este cÃ³digo ya ha sido utilizado",
  suggestion: "Usa un cÃ³digo diferente",
}

// Propio cÃ³digo
OwnCodeException {
  message: "No puedes usar tu propio cÃ³digo promocional",
  suggestion: "Pide el cÃ³digo de un amigo",
}

// CÃ³digo invÃ¡lido
InvalidCodeException {
  message: "El cÃ³digo promocional no es vÃ¡lido",
  suggestion: "Verifica el cÃ³digo e intenta nuevamente",
}
```

#### **2. Errores de Conectividad**

```dart
// Error de red
NetworkException {
  message: "Error de conexiÃ³n. Verifica tu conectividad.",
  canRetry: true,
  retryCallback: () => ref.refresh(promoCodeFormProvider),
}

// Timeout
TimeoutException {
  message: "Tiempo de espera agotado. Intente nuevamente.",
  canRetry: true,
  retryDelay: Duration(seconds: 3),
}
```

#### **3. Errores de AutenticaciÃ³n**

```dart
// No autenticado
UnauthorizedException {
  message: "Usuario no autenticado",
  action: "redirect_to_login",
}

// SesiÃ³n expirada
SessionExpiredException {
  message: "Tu sesiÃ³n ha expirado. Inicia sesiÃ³n nuevamente.",
  action: "force_logout",
}
```

#### **4. Errores del Servidor**

```dart
// Error interno
ServerException {
  message: "Error temporal del servidor. Intente mÃ¡s tarde.",
  canRetry: true,
  retryAfter: 300, // 5 minutos
}

// Error de validaciÃ³n backend
ValidationException {
  message: "Error al validar el cÃ³digo",
  details: "Contacta soporte si el problema persiste",
}
```

### ğŸ”„ Estrategias de RecuperaciÃ³n

#### **Reintentos AutomÃ¡ticos**

```dart
class PromoCodeRetryStrategy {
  static const int maxRetries = 3;
  static const Duration baseDelay = Duration(seconds: 2);

  static Future<PromoCodeValidationResult> retryValidation(
    String promoCode,
    IPromoCodeRepository repository,
  ) async {
    for (int attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await repository.validatePromoCode(promoCode);
      } catch (e) {
        if (attempt == maxRetries) rethrow;

        final delay = baseDelay * math.pow(2, attempt - 1);
        await Future.delayed(delay);
      }
    }
    throw PromoCodeException(
      'No se pudo validar el cÃ³digo despuÃ©s de $maxRetries intentos',
    );
  }
}
```

#### **Fallback para Usuario**

-   **OpciÃ³n de reintentar** la validaciÃ³n manualmente
-   **Continuar sin cÃ³digo** si la validaciÃ³n falla
-   **Contactar soporte** con diagnÃ³stico automÃ¡tico
-   **Guardar cÃ³digo** para intentar mÃ¡s tarde

---

## Validaciones

### âœ… Validaciones Implementadas

1. **ValidaciÃ³n de Formato**

    - Longitud mÃ­nima y mÃ¡xima del cÃ³digo
    - Caracteres alfanumÃ©ricos permitidos
    - Sin espacios ni caracteres especiales

2. **ValidaciÃ³n de Negocio**

    - El cÃ³digo no puede ser del propio usuario
    - El cÃ³digo no debe haber sido usado previamente
    - El cÃ³digo debe estar activo y vigente
    - El usuario debe estar autenticado

3. **ValidaciÃ³n de Estado**
    - Un solo cÃ³digo por prÃ©stamo
    - El cÃ³digo se aplica antes de finalizar la solicitud
    - No se puede modificar un cÃ³digo ya aplicado

### ğŸ” LÃ³gica de ValidaciÃ³n

#### **ValidaciÃ³n Local**

```dart
class PromoCodeValidator {
  static PromoCodeValidationError? validate(String value) {
    if (value.isEmpty) {
      return PromoCodeValidationError.empty;
    }

    if (value.length < 4) {
      return PromoCodeValidationError.tooShort;
    }

    if (value.length > 12) {
      return PromoCodeValidationError.tooLong;
    }

    if (!RegExp(r'^[A-Z0-9]+$').hasMatch(value.toUpperCase())) {
      return PromoCodeValidationError.invalidFormat;
    }

    return null; // VÃ¡lido
  }
}
```

#### **ValidaciÃ³n Backend**

```dart
class BackendPromoCodeValidator {
  static Future<PromoCodeValidationResult> validateBackend(
    String promoCode,
    int userId,
  ) async {
    // 1. Verificar que el cÃ³digo existe
    // 2. Confirmar que no es del propio usuario
    // 3. Verificar que no ha sido usado por este usuario
    // 4. Confirmar que el cÃ³digo estÃ¡ activo
    // 5. Calcular descuento aplicable
    // 6. Registrar uso del cÃ³digo
  }
}
```

### ğŸ›¡ï¸ Consideraciones de Seguridad

-   Los cÃ³digos son Ãºnicos por usuario
-   PrevenciÃ³n de uso mÃºltiple del mismo cÃ³digo
-   ValidaciÃ³n de autenticaciÃ³n obligatoria
-   Rate limiting para prevenir abusos
-   AuditorÃ­a completa de usos de cÃ³digos

---

## Testing

### ğŸ§ª Estrategia de Testing

#### **1. Unit Tests**

```dart
// test/unit/promo_code_test.dart
void main() {
  group('PromoCodeFormNotifier', () {
    test('debe validar cÃ³digo correctamente', () {
      // Test de validaciÃ³n local
    });

    test('debe manejar cÃ³digo ya utilizado', () {
      // Test de respuesta alreadyUsed
    });

    test('debe rechazar propio cÃ³digo', () {
      // Test de respuesta ownCode
    });
  });
}
```

#### **2. Widget Tests**

```dart
// test/widget/promo_code_widget_test.dart
void main() {
  testWidgets('debe mostrar descuento al aplicar cÃ³digo vÃ¡lido', (tester) async {
    // Test de UI de aplicaciÃ³n exitosa
  });

  testWidgets('debe mostrar error al aplicar cÃ³digo invÃ¡lido', (tester) async {
    // Test de UI de manejo de errores
  });
}
```

#### **3. Integration Tests**

```dart
// test/integration/promo_code_flow_test.dart
void main() {
  integrationTest('flujo completo de cÃ³digo promocional', () async {
    // Simular: formulario â†’ validaciÃ³n â†’ descuento â†’ prÃ©stamo
  });

  integrationTest('manejo de errores de red', () async {
    // Test de recuperaciÃ³n ante fallos
  });
}
```

### ğŸ“‹ Casos de Prueba CrÃ­ticos

#### **Flujos de Usuario**

-   âœ… Usuario aplica cÃ³digo vÃ¡lido y obtiene descuento
-   âœ… Usuario intenta usar su propio cÃ³digo (rechazado)
-   âœ… Usuario intenta usar cÃ³digo ya utilizado (rechazado)
-   âœ… Usuario consulta su historial completo
-   âœ… Usuario comparte su cÃ³digo con amigos

#### **Casos LÃ­mite**

-   ğŸ”„ CÃ³digo con formato invÃ¡lido
-   ğŸ”„ PÃ©rdida de conexiÃ³n durante validaciÃ³n
-   ğŸ”„ Token expirado durante aplicaciÃ³n
-   ğŸ”„ MÃºltiples intentos de validaciÃ³n fallidos
-   ğŸ”„ CÃ³digo aplicado y luego cancelado

### ğŸ“Š MÃ©tricas de Testing

-   **Cobertura mÃ­nima**: 85% para lÃ³gica de negocio
-   **Tests de validaciÃ³n**: 100% de reglas de negocio
-   **Tests de error**: Todos los tipos de error cubiertos
-   **Tests de UI**: Interacciones crÃ­ticas del usuario

---

## Seguridad

### ğŸ”’ CaracterÃ­sticas de Seguridad

#### **1. ProtecciÃ³n contra Abusos**

-   âœ… **Un uso por usuario**: PrevenciÃ³n de uso mÃºltiple
-   âœ… **ValidaciÃ³n de propiedad**: No usar propio cÃ³digo
-   âœ… **Rate limiting**: LÃ­mite de intentos por tiempo
-   âœ… **AutenticaciÃ³n obligatoria**: Solo usuarios validados

#### **2. Seguridad en Transacciones**

-   âœ… **ValidaciÃ³n backend**: VerificaciÃ³n centralizada
-   âœ… **AuditorÃ­a completa**: Registro de todos los usos
-   âœ… **Tokens seguros**: PrevenciÃ³n de manipulaciÃ³n
-   âœ… **EncriptaciÃ³n en trÃ¡nsito**: HTTPS obligatorio

#### **3. Control de Acceso**

```dart
class PromoCodeSecurityValidator {
  static bool canUsePromoCode(
    String promoCode,
    int userId,
    List<String> usedCodes,
  ) {
    // Validar que no es propio cÃ³digo
    if (_isOwnCode(promoCode, userId)) return false;

    // Validar que no ha sido usado
    if (usedCodes.contains(promoCode)) return false;

    // Validar formato y vigencia
    return _isValidFormat(promoCode) && _isActive(promoCode);
  }
}
```

### ğŸ›¡ï¸ Consideraciones de Privacidad

-   Los cÃ³digos promocionales son pÃºblicos pero vinculados a usuarios
-   El historial de uso es privado y solo visible por el propietario
-   Las estadÃ­sticas de referidos son informaciÃ³n sensible
-   AuditorÃ­a completa para cumplimiento normativo

### ğŸ” Best Practices Implementadas

```dart
// Ejemplo de implementaciÃ³n segura
class SecurePromoCodeService {
  Future<PromoCodeValidationResult> validateAndApplyCode(
    String promoCode,
    UserContext user,
  ) async {
    try {
      // 1. Validar autenticaciÃ³n
      await _validateAuthentication(user);

      // 2. Validar reglas de negocio
      if (!_securityValidator.canUsePromoCode(promoCode, user.id, user.usedCodes)) {
        return PromoCodeValidationResult.invalid(
          message: 'No puedes usar este cÃ³digo promocional',
        );
      }

      // 3. Validar en backend con seguridad
      final result = await _repository.validatePromoCode(promoCode);

      // 4. Registrar para auditorÃ­a
      _auditLogger.logPromoCodeUsage(user.id, promoCode, result);

      return result;
    } catch (e) {
      _auditLogger.logPromoCodeError(user.id, promoCode, e);
      throw SecurePromoCodeException.fromError(e);
    }
  }
}
```

---

## ğŸš€ ImplementaciÃ³n y Mantenimiento

### ğŸ“¦ Dependencias Clave

```yaml
dependencies:
    flutter_riverpod: ^2.4.0 # GestiÃ³n de estado
    formz: ^0.6.0 # ValidaciÃ³n de formularios
    freezed_annotation: ^2.4.0 # Modelos inmutables
    json_annotation: ^4.8.0 # SerializaciÃ³n JSON
    dio: ^5.3.0 # Cliente HTTP

dev_dependencies:
    riverpod_generator: ^2.3.0 # Code generation
    freezed: ^2.4.0 # GeneraciÃ³n de modelos
    json_serializable: ^6.7.0 # GeneraciÃ³n JSON
    build_runner: ^2.4.0 # Herramienta de generaciÃ³n
```

### ğŸ”§ Comandos de Desarrollo

```bash
# Generar cÃ³digo (requerido despuÃ©s de cambios)
dart run build_runner build --delete-conflicting-outputs

# Modo watch durante desarrollo
dart run build_runner watch -d

# Ejecutar pruebas
flutter test test/features/promo_code/
flutter test test/features/my_loan/test/promo_code/

# AnÃ¡lisis estÃ¡tico
flutter analyze lib/features/promo_code/
flutter analyze lib/features/my_loan/providers/promo_code_provider.dart
```

### ğŸ“ Mejores PrÃ¡cticas

1. **Code Generation**: Siempre ejecutar `build_runner` despuÃ©s de modificar modelos o providers
2. **State Management**: Usar `keepAlive: true` para persistencia durante navegaciÃ³n
3. **Validation**: ValidaciÃ³n local y backend para mejor UX
4. **Error Handling**: Manejo especÃ­fico para cada tipo de error de validaciÃ³n
5. **Testing**: Mantener cobertura >85% para lÃ³gica de negocio
6. **Security**: ValidaciÃ³n estricta para prevenir abusos

---

## ğŸ”— Integraciones

### ğŸ“„ MÃ³dulos que utilizan CÃ³digos Promocionales

#### **My Loan (PrÃ©stamo Actual)**

-   AplicaciÃ³n de cÃ³digos durante solicitud
-   ValidaciÃ³n en tiempo real del formulario
-   CÃ¡lculo automÃ¡tico de descuentos
-   IntegraciÃ³n con calculadora de prÃ©stamos

#### **First Loan (Primer PrÃ©stamo)**

-   AplicaciÃ³n de cÃ³digos para nuevos usuarios
-   Descuentos especiales para primer prÃ©stamo
-   ValidaciÃ³n de referidos

#### **Subsequent Loan (PrÃ©stamos Subsecuentes)**

-   AplicaciÃ³n de cÃ³digos en prÃ©stamos adicionales
-   Descuentos por lealtad o referencias
-   Historial de cÃ³digos utilizados

### ğŸ”„ Flujo de Datos

```
Formulario de PrÃ©stamo (MyLoan/FirstLoan/SubsequentLoan)
  â†“
PromoCodeFormNotifier (ValidaciÃ³n local)
  â†“
PromoCodeRepository (ValidaciÃ³n backend)
  â†“
LoanCalculator (RecÃ¡lculo con descuento)
  â†“
PromoCodeHistory (Registro de uso)
```
