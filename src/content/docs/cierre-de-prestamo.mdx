---
title: Flujo de cierre de PrÃ©stamo
slug: cierre-de-prestamo
tags: [auth, flutter, riverpod, dio, formz, go_router, freezed, json_annotation]
description: Flujo de cierre de PrÃ©stamos. GestiÃ³n completa del proceso de cierre, desde la solicitud hasta la confirmaciÃ³n visual.
---

## DescripciÃ³n General

La funcionalidad de **Cierre de PrÃ©stamo** (`loan_close`) permite a los usuarios cerrar su prÃ©stamo activo de forma segura y definitiva. Este proceso realiza una solicitud al backend para cerrar el prÃ©stamo y muestra el resultado con una interfaz visual clara que informa al usuario si la operaciÃ³n fue exitosa o si ocurriÃ³ algÃºn error.

### ğŸ“Š Estructura del Flujo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario inicia   â”‚â”€â”€â”€â”€â–¶â”‚ Solicitud API     â”‚â”€â”€â”€â”€â–¶â”‚ Procesamiento     â”‚â”€â”€â”€â”€â–¶â”‚ Respuesta del     â”‚â”€â”€â”€â”€â–¶â”‚ Pantalla de      â”‚
â”‚ cierre de prÃ©stamoâ”‚     â”‚ GET /close-loan  â”‚     â”‚ Backend          â”‚     â”‚ Servidor         â”‚     â”‚ Resultado        â”‚
â”‚                 â”‚     â”‚                     â”‚     â”‚                   â”‚     â”‚                     â”‚     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ Acceso desde Mi      âœ“ AutenticaciÃ³n     âœ“ ValidaciÃ³n de      âœ“ Ã‰xito o error     âœ“ UI adaptativa
       PrÃ©stamo              requerida           permisos             con mensaje         con botÃ³n
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **Cierre seguro**: Proceso autenticado que cierra el prÃ©stamo definitivamente
-   âœ… **Feedback inmediato**: Muestra resultado claro con mensaje especÃ­fico
-   âœ… **Manejo de errores**: DiferenciaciÃ³n entre tipos de errores con mensajes apropiados
-   âœ… **NavegaciÃ³n controlada**: Previene retroceso accidental durante el proceso
-   âœ… **ActualizaciÃ³n automÃ¡tica**: Refresca datos del usuario y prÃ©stamo despuÃ©s del cierre
-   âœ… **Logging completo**: Registro detallado para auditorÃ­a y debugging
-   âœ… **UI adaptativa**: Interfaz diferente para Ã©xito y error

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve el cierre de prÃ©stamo?

El cierre de prÃ©stamo te permite:

-   **Finalizar tu prÃ©stamo**: Cerrar definitivamente tu prÃ©stamo activo
-   **Liberar compromisos**: Terminar tus obligaciones de pago
-   **Obtener confirmaciÃ³n**: Recibir verificaciÃ³n oficial del cierre
-   **Actualizar tu estado**: Cambiar tu estatus en el sistema

### ğŸ“± CÃ³mo cerrar tu prÃ©stamo

#### Paso 1: Acceder a la opciÃ³n de cierre

**Desde la pantalla "Mi PrÃ©stamo":**

1. ğŸ  **Abre la aplicaciÃ³n** - Inicia sesiÃ³n en Pisto
2. ğŸ’° **Ve a "Mi PrÃ©stamo"** - Encuentra esta opciÃ³n en el menÃº
3. ğŸ”š **Busca la opciÃ³n "Cerrar PrÃ©stamo"** - Generalmente disponible cuando el prÃ©stamo estÃ¡ en estado apropiado
4. ğŸ‘† **Presiona la opciÃ³n** - Inicia el proceso de cierre

**CaracterÃ­sticas de acceso:**

-   âš¡ **Proceso rÃ¡pido** - El cierre se procesa en segundos
-   ğŸ”’ **Seguro** - Requiere autenticaciÃ³n vÃ¡lida
-   ğŸ“Š **ConfirmaciÃ³n** - RecibirÃ¡s confirmaciÃ³n inmediata

#### Paso 2: Procesamiento del cierre

**Durante el proceso:**

1. ğŸ“¡ **Se envÃ­a la solicitud** - La app contacta al servidor
2. â³ **Espera el procesamiento** - El sistema cierra tu prÃ©stamo
3. âœ… **Recibe confirmaciÃ³n** - Se muestra el resultado

**Indicadores visuales:**

-   ğŸ”„ **Indicador de carga** - Mientras se procesa la solicitud
-   ğŸ“± **Pantalla de resultado** - Muestra Ã©xito o error
-   ğŸ”” **NotificaciÃ³n** - ConfirmaciÃ³n del estado final

#### Paso 3: Verificar el resultado

**Pantalla de resultado:**

**En caso de Ã©xito:**

-   âœ… **CÃ­rculo verde** - Con Ã­cono de check
-   ğŸ“ **Mensaje "PrÃ©stamo cerrado"** - ConfirmaciÃ³n clara
-   ğŸ’¬ **Mensaje descriptivo** - "PrÃ©stamo cerrado exitosamente"
-   ğŸ”˜ **BotÃ³n "Continuar"** - Para regresar a Mi PrÃ©stamo

**En caso de error:**

-   âŒ **CÃ­rculo rojo** - Con Ã­cono de error
-   ğŸ“ **Mensaje "Error"** - IndicaciÃ³n del problema
-   ğŸ’¬ **Mensaje especÃ­fico** - DescripciÃ³n del error ocurrido
-   ğŸ”˜ **BotÃ³n "Reintentar"** - Para intentar nuevamente

#### Paso 4: Continuar despuÃ©s del cierre

**DespuÃ©s de un cierre exitoso:**

1. ğŸ”„ **Datos actualizados** - Tu estado de prÃ©stamo se actualiza
2. ğŸ“Š **Nueva vista** - VerÃ¡s tu nuevo estado en Mi PrÃ©stamo
3. âœ… **ConfirmaciÃ³n final** - El prÃ©stamo aparecerÃ¡ como cerrado

### âš ï¸ InformaciÃ³n importante

**Consideraciones antes de cerrar:**

-   ğŸ“‹ **Revisa tu estado** - AsegÃºrate de que el prÃ©stamo puede cerrarse
-   ğŸ’° **Verifica pagos** - Confirma que no hay pagos pendientes
-   ğŸ“ **Contacta soporte** - Si tienes dudas, consulta antes de cerrar

**DespuÃ©s del cierre:**

-   ğŸ”’ **El cierre es definitivo** - No se puede deshacer
-   ğŸ“Š **Estado actualizado** - Tu historial reflejarÃ¡ el cierre
-   ğŸ“„ **Recibe confirmaciÃ³n** - Guarda el comprobante del cierre

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ Estructura del MÃ³dulo

El mÃ³dulo de cierre de prÃ©stamo sigue una arquitectura limpia basada en capas con separaciÃ³n clara de responsabilidades:

```
loan_close/
â”œâ”€â”€ exceptions/                 # Manejo de errores personalizados
â”‚   â””â”€â”€ loan_close_exception.dart          # Tipos de excepciÃ³n
â”œâ”€â”€ models/                      # DTOs para API
â”‚   â”œâ”€â”€ loan_close_response.dart             # Respuesta del endpoint
â”‚   â””â”€â”€ models.dart                          # Export de modelos
â”œâ”€â”€ providers/                   # GestiÃ³n de estado
â”‚   â”œâ”€â”€ loan_close_provider.dart              # Provider principal
â”‚   â””â”€â”€ providers.dart                       # Export de providers
â”œâ”€â”€ repositories/               # Acceso a datos
â”‚   â”œâ”€â”€ loan_close_repository.dart            # API de cierre
â”‚   â””â”€â”€ repositories.dart                     # Export de repositories
â””â”€â”€ screens/                    # Interfaces de usuario
    â”œâ”€â”€ loan_close_success_screen.dart         # Pantalla de resultado
    â””â”€â”€ screens.dart                          # Export de screens
```

### ğŸ“Š Entities y Models

#### **LoanCloseResponse**

Modelo para la respuesta del servidor:

```dart
@freezed
abstract class LoanCloseResponse with _$LoanCloseResponse {
  const factory LoanCloseResponse({
    required String message,        // Mensaje de respuesta
    int? loanStatus,             // Nuevo estado del prÃ©stamo (opcional)
  }) = _LoanCloseResponse;

  factory LoanCloseResponse.fromJson(Map<String, dynamic> json) =>
      _$LoanCloseResponseFromJson(json);
}
```

#### **LoanCloseException**

ExcepciÃ³n personalizada para manejo de errores:

```dart
enum LoanCloseExceptionType {
  network,        // Errores de conectividad
  validation,     // Errores de validaciÃ³n
  unauthorized,   // Usuario no autenticado
  unknown,        // Errores desconocidos
}

class LoanCloseException implements Exception {
  final String message;              // Mensaje de error
  final int? statusCode;           // CÃ³digo HTTP
  final LoanCloseExceptionType type; // Tipo de error
  final Map<String, dynamic>? data; // Datos adicionales
}
```

### ğŸ¯ Providers (GestiÃ³n de Estado)

#### **LoanCloseNotifier**

Provider principal que gestiona el estado del cierre:

```dart
@Riverpod(keepAlive: true)
class LoanCloseNotifier extends _$LoanCloseNotifier {
  @override
  LoanCloseState build() {
    return const LoanCloseState();
  }

  /// Cierra el prÃ©stamo del usuario
  Future<void> closeLoan() async {
    try {
      // 1. Activar estado de carga
      state = state.copyWith(status: RequestStatus.loading);

      // 2. Llamar al repositorio
      final repository = ref.read(loanCloseRepositoryProvider);
      final response = await repository.closeLoan();

      // 3. Actualizar estado de Ã©xito
      state = state.copyWith(
        status: RequestStatus.success,
        response: response,
      );
    } catch (e) {
      // 4. Manejar errores
      state = state.copyWith(
        status: RequestStatus.error,
        errorMessage: e.toString(),
      );
    }
  }

  /// Reset del estado
  void reset() {
    state = const LoanCloseState();
  }
}
```

**Estados del Provider:**

-   `idle`: Estado inicial, sin actividad
-   `loading`: Procesando solicitud de cierre
-   `success`: Cierre completado exitosamente
-   `error`: Error durante el proceso de cierre

### ğŸŒ Repository (Acceso a Datos)

#### **LoanCloseRepository**

Clase responsable de la comunicaciÃ³n con la API:

```dart
class LoanCloseRepository {
  final HttpClient _httpClient;

  LoanCloseRepository(this._httpClient);

  /// Cierra el prÃ©stamo del usuario autenticado
  Future<LoanCloseResponse> closeLoan() async {
    try {
      final response = await _httpClient.get('/client/close-loan');
      return LoanCloseResponse.fromJson(response.data);
    } on DioException catch (e) {
      // Categorizar el tipo de error
      LoanCloseExceptionType exceptionType;
      if (e.response?.statusCode == 401) {
        exceptionType = LoanCloseExceptionType.unauthorized;
      } else if (e.response?.statusCode == 422) {
        exceptionType = LoanCloseExceptionType.validation;
      } else if (e.type == DioExceptionType.connectionTimeout) {
        exceptionType = LoanCloseExceptionType.network;
      } else {
        exceptionType = LoanCloseExceptionType.unknown;
      }

      throw LoanCloseException(
        message: _extractErrorMessage(e),
        statusCode: e.response?.statusCode,
        type: exceptionType,
        data: e.response?.data,
      );
    }
  }
}
```

---

## Flujo Completo de Datos

### ğŸ”„ Flujo de Cierre de PrÃ©stamo

```
Usuario en MyLoanScreen
  â†“
Presiona "Cerrar PrÃ©stamo"
  â†“
LoanCloseNotifier.closeLoan()
  â†“
LoanCloseRepository.closeLoan()
  â†“
HttpClient.get('/client/close-loan')
  â”œâ”€â†’ AutenticaciÃ³n (token JWT)
  â”œâ”€â†’ VerificaciÃ³n de permisos
  â””â”€â†’ Procesamiento de cierre
  â†“
Respuesta del servidor
  â”œâ”€â†’ Ã‰xito: LoanCloseResponse con mensaje
  â””â”€â†’ Error: LoanCloseException con detalles
  â†“
ActualizaciÃ³n de estado
  â”œâ”€â†’ Success: state = success + response
  â””â”€â†’ Error: state = error + errorMessage
  â†“
NavegaciÃ³n a LoanCloseSuccessScreen
  â†“
UI adaptativa segÃºn resultado
  â”œâ”€â†’ Ã‰xito: Verde + "Continuar"
  â””â”€â†’ Error: Rojo + "Reintentar"
```

### ğŸ”„ Flujo de ActualizaciÃ³n Post-Cierre

```
Usuario presiona "Continuar" en pantalla de Ã©xito
  â†“
LoanCloseSuccessScreen._handleContinue()
  â†“
Reset del estado (loanCloseProvider.reset())
  â†“
ActualizaciÃ³n de datos del usuario (authProvider.getUser())
  â†“
Recarga de datos del prÃ©stamo (myLoanProvider.loadLoanData())
  â†“
NavegaciÃ³n a /my-loan con datos actualizados
  â†“
UI refleja nuevo estado del prÃ©stamo (cerrado)
```

### ğŸ“Š Diagrama de Estados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LoanCloseNotifier                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: RequestStatus + Response + ErrorMessage            â”‚
â”‚                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estados automÃ¡ticos:                                         â”‚
â”‚  - idle: Estado inicial sin actividad                           â”‚
â”‚  - loading: Procesando solicitud (mostrar indicador)          â”‚
â”‚  - success: Cierre exitoso (mostrar pantalla verde)           â”‚
â”‚  - error: Error en proceso (mostrar pantalla roja)           â”‚
â”‚                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Datos:                                                      â”‚
â”‚  - LoanCloseResponse?: Respuesta del servidor                  â”‚
â”‚  - errorMessage: Mensaje de error si existe                     â”‚
â”‚  - status: Estado actual del proceso                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Acciones:                                                   â”‚
â”‚  - closeLoan(): Iniciar proceso de cierre                      â”‚
â”‚  - reset(): Limpiar estado para nueva operaciÃ³n                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Componentes y Pasos

### ğŸ“± Pantallas del Flujo

#### 1. ğŸ”š LoanCloseSuccessScreen

-   **Ruta**: `/loan-close/success`
-   **PropÃ³sito**: Pantalla de resultado del cierre de prÃ©stamo
-   **Funcionalidad**:
    -   UI adaptativa segÃºn Ã©xito o error
    -   PrevenciÃ³n de navegaciÃ³n hacia atrÃ¡s
    -   BotÃ³n de acciÃ³n contextual (Continuar/Reintentar)
    -   ActualizaciÃ³n automÃ¡tica de datos despuÃ©s del Ã©xito

**Componentes principales:**

```dart
class LoanCloseSuccessScreen extends ConsumerStatefulWidget {
  @override
  Widget build(BuildContext context) {
    return PopScope(
      canPop: false,  // Previene navegaciÃ³n hacia atrÃ¡s
      child: AppLayout(
        child: Column(
          children: [
            _buildStatusIcon(),    // Ãcono verde/rojo
            _buildStatusTitle(),   // "PrÃ©stamo cerrado" / "Error"
            _buildMessage(),      // Mensaje descriptivo
            _buildActionButton(), // "Continuar" / "Reintentar"
          ],
        ),
      ),
    );
  }
}
```

#### **\_buildStatusIcon()**

Ãcono visual que indica el resultado:

```dart
Widget _buildStatusIcon() {
  return Container(
    width: 120,
    height: 120,
    decoration: BoxDecoration(
      color: (isSuccess ? AppTheme.correct : AppTheme.negative)
          .withValues(alpha: 0.1),
      shape: BoxShape.circle,
    ),
    child: Icon(
      isSuccess ? Icons.check_circle : Icons.error_outline,
      size: 80,
      color: isSuccess ? AppTheme.correct : AppTheme.negative,
    ),
  );
}
```

#### **\_buildActionButton()**

BotÃ³n contextual segÃºn el resultado:

```dart
Widget _buildActionButton() {
  return PrimaryBtn(
    text: isReloading ? 'Redirigiendo...' : 'Continuar',
    onPressed: isReloading ? null : () async {
      setState(() => isReloading = true);

      try {
        // Reset del estado
        ref.read(loanCloseProvider.notifier).reset();

        // Recargar datos
        await ref.read(authProvider.notifier).getUser();
        await ref.read(myLoanProvider.notifier).loadLoanData();

        // Navegar con datos actualizados
        if (mounted && context.mounted) {
          context.go('/my-loan');
        }
      } catch (e) {
        // AÃºn asÃ­ navegar
        if (mounted) {
          context.go('/my-loan');
        }
      }
    },
  );
}
```

### ğŸ§© Componentes Reutilizables

#### **PopScope con canPop: false**

Componente que previene navegaciÃ³n hacia atrÃ¡s:

```dart
PopScope(
  canPop: false,  // Bloquea botÃ³n back y gestos
  onPopInvokedWithResult: (didPop, result) {
    if (didPop) {
      context.go('/my-loan');  // RedirecciÃ³n forzada
    }
  },
  child: /* contenido */,
)
```

#### **Indicador de Estado Visual**

Componente para mostrar Ã©xito o error:

```dart
Container(
  decoration: BoxDecoration(
    color: statusColor.withValues(alpha: 0.1),
    shape: BoxShape.circle,
  ),
  child: Icon(
    statusIcon,
    size: 80,
    color: statusColor,
  ),
)
```

---

## APIs Utilizadas

### ğŸ“¡ Endpoints de API

#### **GET** `/client/close-loan`

**PropÃ³sito**: Cerrar el prÃ©stamo del usuario autenticado

**Headers Requeridos:**

```http
GET /client/close-loan HTTP/1.1
Host: api.pisto.co
Authorization: Bearer {jwt_token}
Content-Type: application/json
X-Client-Version: 1.0.0
X-Device-ID: {device_identifier}
```

**Response Exitosa (200)**:

```json
{
    "message": "PrÃ©stamo cerrado exitosamente",
    "loanStatus": 8
}
```

**Error 401 (Unauthorized)**:

```json
{
    "errors": [
        {
            "message": "Usuario no autenticado"
        }
    ]
}
```

**Error 422 (Validation)**:

```json
{
    "errors": [
        {
            "message": "El prÃ©stamo no puede ser cerrado en este estado"
        }
    ]
}
```

### ğŸ”’ CaracterÃ­sticas de la API

-   **AutenticaciÃ³n requerida**: Solo usuarios autenticados pueden cerrar prÃ©stamos
-   **VerificaciÃ³n de estado**: El backend valida si el prÃ©stamo puede cerrarse
-   **Respuesta inmediata**: El proceso es sÃ­ncrono y rÃ¡pido
-   **Logging completo**: Todas las operaciones se registran para auditorÃ­a

---

## Manejo de Errores

### âš ï¸ Tipos de Errores

#### **1. Errores de AutenticaciÃ³n**

```dart
// Usuario no autenticado
UnauthorizedException {
  message: "Usuario no autenticado",
  statusCode: 401,
  type: LoanCloseExceptionType.unauthorized,
}
```

#### **2. Errores de ValidaciÃ³n**

```dart
// PrÃ©stamo no puede cerrarse
ValidationException {
  message: "El prÃ©stamo no puede ser cerrado en este estado",
  statusCode: 422,
  type: LoanCloseExceptionType.validation,
}
```

#### **3. Errores de Conectividad**

```dart
// Timeout de conexiÃ³n
NetworkException {
  message: "Tiempo de conexiÃ³n agotado. Verifica tu internet.",
  type: LoanCloseExceptionType.network,
}
```

#### **4. Errores Desconocidos**

```dart
// Error inesperado
UnknownException {
  message: "Error inesperado al cerrar el prÃ©stamo",
  type: LoanCloseExceptionType.unknown,
}
```

### ğŸ”„ Estrategias de RecuperaciÃ³n

#### **Reintentos AutomÃ¡ticos**

```dart
class LoanCloseRetryStrategy {
  static const int maxRetries = 3;
  static const Duration baseDelay = Duration(seconds: 2);

  static Future<LoanCloseResponse> retryWithBackoff(
    Future<LoanCloseResponse> Function() closeCall,
  ) async {
    for (int attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await closeCall();
      } catch (e) {
        if (attempt == maxRetries) rethrow;

        final delay = baseDelay * math.pow(2, attempt - 1);
        await Future.delayed(delay);
      }
    }
    throw LoanCloseException(
      'No se pudo cerrar el prÃ©stamo despuÃ©s de $maxRetries intentos',
      type: LoanCloseExceptionType.unknown,
    );
  }
}
```

#### **Fallback para Usuario**

-   **BotÃ³n de reintentar manual** en pantalla de error
-   **Mensajes especÃ­ficos** segÃºn el tipo de error
-   **NavegaciÃ³n segura** siempre regresa a Mi PrÃ©stamo
-   **PreservaciÃ³n de estado** para anÃ¡lisis del problema

---

## Validaciones

### âœ… Validaciones Implementadas

1. **ValidaciÃ³n de AutenticaciÃ³n**

    - VerificaciÃ³n de token JWT vÃ¡lido
    - ConfirmaciÃ³n de sesiÃ³n activa
    - Manejo de tokens expirados

2. **ValidaciÃ³n de Estado del PrÃ©stamo**

    - VerificaciÃ³n de que el prÃ©stamo puede cerrarse
    - ValidaciÃ³n de estado actual del prÃ©stamo
    - ConfirmaciÃ³n de que no hay pagos pendientes

3. **ValidaciÃ³n de Permisos**
    - VerificaciÃ³n de que el usuario tiene permisos para cerrar
    - ValidaciÃ³n de propiedad del prÃ©stamo
    - ConfirmaciÃ³n de autorizaciÃ³n

### ğŸ” LÃ³gica de ValidaciÃ³n

#### **ValidaciÃ³n de AutenticaciÃ³n**

```dart
class LoanCloseValidator {
  static bool canCloseLoan(UserEntity user) {
    // Validar que el usuario estÃ¡ autenticado
    if (user.id == null) return false;

    // Validar que la sesiÃ³n estÃ¡ activa
    if (!_isSessionActive(user)) return false;

    return true;
  }

  static bool _isSessionActive(UserEntity user) {
    // Verificar token y fecha de expiraciÃ³n
    return user.token != null && !_isTokenExpired(user.token!);
  }
}
```

#### **ValidaciÃ³n de Estado del PrÃ©stamo**

```dart
class LoanStatusValidator {
  static bool isClosable(int loanStatus) {
    // Estados en los que se puede cerrar el prÃ©stamo
    const closableStatuses = [4, 5, 6, 7]; // Ejemplo: pagado, vencido, etc.

    return closableStatuses.contains(loanStatus);
  }

  static String getClosureMessage(int loanStatus) {
    switch (loanStatus) {
      case 1:
        return 'El prÃ©stamo estÃ¡ en proceso y no puede cerrarse';
      case 2:
        return 'El prÃ©stamo estÃ¡ siendo considerado y no puede cerrarse';
      case 3:
        return 'El prÃ©stamo estÃ¡ activo y no puede cerrarse';
      default:
        return 'El prÃ©stamo puede ser cerrado';
    }
  }
}
```

### ğŸ›¡ï¸ Consideraciones de Seguridad

-   ValidaciÃ³n de autenticaciÃ³n en cada solicitud
-   VerificaciÃ³n de permisos de usuario
-   Logging completo para auditorÃ­a
-   PrevenciÃ³n de cierres no autorizados

---

## Testing

### ğŸ§ª Estrategia de Testing

#### **1. Unit Tests**

```dart
// test/unit/loan_close_test.dart
void main() {
  group('LoanCloseNotifier', () {
    test('debe cerrar prÃ©stamo correctamente', () {
      // Test de cierre exitoso
    });

    test('debe manejar error de autenticaciÃ³n', () {
      // Test de manejo de 401
    });

    test('debe manejar error de validaciÃ³n', () {
      // Test de manejo de 422
    });
  });

  group('LoanCloseRepository', () {
    test('debe llamar endpoint correctamente', () {
      // Test de llamada a API
    });

    test('debe manejar timeout de conexiÃ³n', () {
      // Test de manejo de timeout
    });
  });
}
```

#### **2. Widget Tests**

```dart
// test/widget/loan_close_success_screen_test.dart
void main() {
  testWidgets('debe mostrar pantalla de Ã©xito', (tester) async {
    // Test de UI exitosa
  });

  testWidgets('debe mostrar pantalla de error', (tester) async {
    // Test de UI de error
  });

  testWidgets('debe prevenir navegaciÃ³n hacia atrÃ¡s', (tester) async {
    // Test de PopScope
  });
}
```

#### **3. Integration Tests**

```dart
// test/integration/loan_close_flow_test.dart
void main() {
  integrationTest('flujo completo de cierre de prÃ©stamo', () async {
    // Simular: Mi PrÃ©stamo â†’ Cerrar â†’ Resultado â†’ Continuar
  });

  integrationTest('manejo de errores de red', () async {
    // Test de recuperaciÃ³n ante fallos
  });
}
```

### ğŸ“‹ Casos de Prueba CrÃ­ticos

#### **Flujos de Usuario**

-   âœ… Usuario cierra prÃ©stamo exitosamente
-   âœ… Usuario maneja error de autenticaciÃ³n
-   âœ… Usuario reintenta despuÃ©s de error
-   âœ… Usuario navega correctamente despuÃ©s del cierre

#### **Casos LÃ­mite**

-   ğŸ”„ PrÃ©stamo en estado no cerrable
-   ğŸ”„ Token expirado durante el proceso
-   ğŸ”„ PÃ©rdida de conexiÃ³n durante el cierre
-   ğŸ”„ MÃºltiples intentos de cierre fallidos

### ğŸ“Š MÃ©tricas de Testing

-   **Cobertura mÃ­nima**: 90% para lÃ³gica de negocio
-   **Tests de seguridad**: 100% de validaciones crÃ­ticas
-   **Tests de error**: Todos los tipos de error cubiertos
-   **Tests de UI**: Interacciones crÃ­ticas del usuario

---

## Seguridad

### ğŸ”’ CaracterÃ­sticas de Seguridad

#### **1. ProtecciÃ³n de Acceso**

-   âœ… **AutenticaciÃ³n obligatoria**: Solo usuarios validados pueden cerrar prÃ©stamos
-   âœ… **Token JWT requerido**: VerificaciÃ³n de identidad en cada solicitud
-   âœ… **SesiÃ³n activa**: ConfirmaciÃ³n de usuario logueado

#### **2. Validaciones de Seguridad**

-   âœ… **VerificaciÃ³n de estado**: El prÃ©stamo debe estar en estado cerrable
-   âœ… **ValidaciÃ³n de permisos**: Solo el propietario puede cerrar su prÃ©stamo
-   âœ… **Logging completo**: Registro de auditorÃ­a para cada cierre

#### **3. ProtecciÃ³n de Datos**

```dart
class LoanCloseSecurityValidator {
  static bool canCloseLoan(
    UserEntity user,
    int loanStatus,
    int loanId,
  ) {
    // Validar autenticaciÃ³n
    if (user.id == null) return false;

    // Validar estado del prÃ©stamo
    if (!LoanStatusValidator.isClosable(loanStatus)) return false;

    // Validar propiedad (implementar segÃºn lÃ³gica de negocio)
    if (!_userOwnsLoan(user.id!, loanId)) return false;

    return true;
  }

  static bool _userOwnsLoan(int userId, int loanId) {
    // Implementar verificaciÃ³n de propiedad del prÃ©stamo
    return true; // Placeholder
  }
}
```

### ğŸ›¡ï¸ Consideraciones de Privacidad

-   Los cierres de prÃ©stamo son operaciones sensibles que requieren auditorÃ­a
-   Cada cierre se registra con timestamp y datos del usuario
-   Los datos se almacenan de forma segura en el backend
-   El acceso a la informaciÃ³n de cierre estÃ¡ restringido

### ğŸ” Best Practices Implementadas

```dart
// Ejemplo de implementaciÃ³n segura
class SecureLoanCloseService {
  Future<LoanCloseResult> closeLoanSecurely(
    UserContext user,
    int loanId,
  ) async {
    try {
      // 1. Validar autenticaciÃ³n
      if (!_securityValidator.canCloseLoan(user.user, user.loanStatus, loanId)) {
        throw UnauthorizedException('Usuario no autorizado para cerrar este prÃ©stamo');
      }

      // 2. Validar estado del prÃ©stamo
      final loanData = await _repository.getLoanData(loanId);
      if (!LoanStatusValidator.isClosable(loanData.status)) {
        throw ValidationException('El prÃ©stamo no puede ser cerrado en su estado actual');
      }

      // 3. Ejecutar cierre de forma segura
      final result = await _repository.closeLoan(loanId);

      // 4. Registrar para auditorÃ­a
      _auditLogger.logLoanClose(user.user.id, loanId, result);

      return LoanCloseResult.success(result);
    } catch (e) {
      _auditLogger.logLoanCloseError(user.user.id, loanId, e);
      throw SecureLoanCloseException.fromError(e);
    }
  }
}
```

---

## ğŸš€ ImplementaciÃ³n y Mantenimiento

### ğŸ“¦ Dependencias Clave

```yaml
dependencies:
    flutter_riverpod: ^2.4.0 # GestiÃ³n de estado
    dio: ^5.3.0 # Cliente HTTP
    go_router: ^12.0.0 # NavegaciÃ³n
    freezed_annotation: ^2.4.0 # Modelos inmutables

dev_dependencies:
    riverpod_generator: ^2.3.0 # Code generation
    freezed: ^2.4.0 # GeneraciÃ³n de modelos
    build_runner: ^2.4.0 # Herramienta de generaciÃ³n
```

### ğŸ”§ Comandos de Desarrollo

```bash
# Generar cÃ³digo (requerido despuÃ©s de cambios)
dart run build_runner build --delete-conflicting-outputs

# Modo watch durante desarrollo
dart run build_runner watch -d

# Ejecutar pruebas
flutter test test/features/loan_close/

# AnÃ¡lisis estÃ¡tico
flutter analyze lib/features/loan_close/
```

### ğŸ“ Mejores PrÃ¡cticas

1. **Code Generation**: Siempre ejecutar `build_runner` despuÃ©s de modificar modelos
2. **State Management**: Usar `keepAlive: true` para persistencia crÃ­tica
3. **Error Handling**: Manejo especÃ­fico para cada tipo de error
4. **Testing**: Mantener cobertura >90% para lÃ³gica de negocio
5. **Security**: Validaciones mÃºltiples antes de ejecutar cierre
6. **Logging**: Registro completo para auditorÃ­a y debugging

---

## ğŸ”— Integraciones

### ğŸ“„ MÃ³dulos que utilizan Loan Close

#### **My Loan**

-   Acceso desde la pantalla principal de prÃ©stamos
-   ActualizaciÃ³n de estado despuÃ©s del cierre
-   NavegaciÃ³n a la pantalla de cierre

#### **Auth**

-   VerificaciÃ³n de autenticaciÃ³n requerida
-   ActualizaciÃ³n de datos del usuario despuÃ©s del cierre
-   Manejo de tokens y sesiones

#### **App Router**

-   Ruta `/loan-close/success` registrada en el sistema
-   NavegaciÃ³n controlada con prevenciÃ³n de retroceso
-   Transiciones personalizadas para mejor UX

### ğŸ”„ Flujo de Datos

```
MyLoanScreen
  â†“
LoanCloseNotifier.closeLoan()
  â†“
LoanCloseRepository.closeLoan()
  â†“
HttpClient.get('/client/close-loan')
  â†“
API Backend
  â†“
LoanCloseResponse
  â†“
LoanCloseSuccessScreen
  â†“
ActualizaciÃ³n de Auth y MyLoan providers
  â†“
NavegaciÃ³n a /my-loan con datos actualizados
```
