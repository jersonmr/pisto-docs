---
title: Flujo de Solicitud de prÃ©stamo posterior
slug: solicitud-de-prestamo-posterior
tags: [auth, subsequent-loan, image-upload, flutter, riverpod, dio, formz]
description: Flujo de solicitud de prÃ©stamo posterior en la aplicaciÃ³n Pisto, incluyendo carga de imÃ¡genes, manejo de errores y estados del proceso.
---

## DescripciÃ³n General

El **flujo de solicitud de prÃ©stamo posterior** permite a usuarios que ya tienen un prÃ©stamo activo solicitar un nuevo prÃ©stamo adicional (refinanciamiento o segundo prÃ©stamo). Este flujo es mÃ¡s **Ã¡gil que el primer prÃ©stamo** ya que reutiliza informaciÃ³n verificada.

### ğŸ“Š Estructura de Pasos (3 pasos vs 7 en primer prÃ©stamo)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Welcome    â”‚â”€â”€â”€â”€â–¶â”‚   Step 1   â”‚â”€â”€â”€â”€â–¶â”‚   Step 2     â”‚â”€â”€â”€â”€â–¶â”‚ Completion  â”‚
â”‚  (Intro)    â”‚     â”‚ (Financiero)     â”‚(Referencias) â”‚     â”‚ (Confirm)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚+ ImÃ¡genes   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ Auto           âœ“ Actua.          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     âœ“ Auto/Manual
     (Inicio)         (Datos)           âœ“ Manual            (ConfirmaciÃ³n)
                                        (RecopilaciÃ³n)
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **Proceso rÃ¡pido**: Solo 3 pasos vs 7 en primer prÃ©stamo
-   âœ… **Datos pre-cargados**: InformaciÃ³n laboral reutilizada
-   âœ… **ExpiraciÃ³n de DUI**: Verifica vigencia del documento
-   âœ… **ImÃ¡genes opcionales**: Puede reutilizar de primer prÃ©stamo
-   âœ… **ValidaciÃ³n rÃ¡pida**: Menos campos de entrada
-   âœ… **DecisiÃ³n acelerada**: AprobaciÃ³n mÃ¡s rÃ¡pida

---

## Diferencias vs Primer PrÃ©stamo

### ComparaciÃ³n Directa

| Aspecto                 | Primer PrÃ©stamo   | PrÃ©stamo Posterior   |
| ----------------------- | ----------------- | -------------------- |
| **Total de pasos**      | 7 (incl. intro)   | 4 (incl. intro)      |
| **Pasos de entrada**    | 5 pasos           | 1 + 1 paso           |
| **Datos personales**    | âœ… Requerido      | âŒ Ya verificado     |
| **DirecciÃ³n**           | âœ… Requerido      | âŒ Ya verificado     |
| **InformaciÃ³n laboral** | âœ… Requerido      | âš ï¸ Actualizar opciÃ³n |
| **Referencias**         | âœ… Requerido (2)  | âœ… Requerido (2)     |
| **ImÃ¡genes**            | âœ… 3 obligatorias | âœ… 3 obligatorias    |
| **VerificaciÃ³n DUI**    | âœ… Fecha nac      | âœ… ExpiraciÃ³n DUI    |
| **Tiempo estimado**     | 15-20 minutos     | 5-8 minutos          |

### Datos Reutilizados

```
Del Primer PrÃ©stamo (No se solicitan):
â”œâ”€ Nombre y Apellido
â”œâ”€ GÃ©nero
â”œâ”€ Fecha de Nacimiento
â”œâ”€ DUI
â”œâ”€ TelÃ©fono
â”œâ”€ DirecciÃ³n completa
â”‚  â”œâ”€ Departamento
â”‚  â”œâ”€ Distrito
â”‚  â”œâ”€ Municipio
â”‚  â”œâ”€ Calle
â”‚  â”œâ”€ NÃºmero
â”‚  â””â”€ Barrio
â”œâ”€ Historial de pagos âœ“
â””â”€ Score crediticio âœ“

Del Primer PrÃ©stamo (Opcionales actualizar):
â”œâ”€ Tipo de Empleo
â”œâ”€ Nombre Empresa
â”œâ”€ TelÃ©fono Empresa
â”œâ”€ Ingreso Neto
â”œâ”€ Ingreso Adicional
â”œâ”€ Otras Deudas
â””â”€ PropÃ³sito PrÃ©stamo
```

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

El prÃ©stamo posterior es para cuando ya tienes un prÃ©stamo con Pisto y necesitas dinero adicional. Es mÃ¡s rÃ¡pido porque ya verificamos tu identidad.

### ğŸ“ UbicaciÃ³n en la App

**Ruta**: `Mi PrÃ©stamo â†’ Solicitar Nuevo PrÃ©stamo` o `Dashboard â†’ + PrÃ©stamo`

**Requisitos previos:**

-   âœ… Primer prÃ©stamo activo o completado
-   âœ… Historial de pagos bueno (sin morosidad)
-   âœ… TelÃ©fono confirmado
-   âœ… DUI vigente (no expirado)

### ğŸš€ Flujo Paso a Paso

#### **Paso 0: Bienvenida (Welcome Screen)**

**QuÃ© se muestra:**

1. "Â¡Hola [nombre]! Solicita tu siguiente prÃ©stamo"
2. Monto y plazo preseleccionados en el calculador
3. Resumen de informaciÃ³n que reutilizamos
4. Nota: "Ya tenemos tus datos personales"
5. BotÃ³n "Comencemos"

**InformaciÃ³n mostrada:**

```
âœ… Datos Verificados Anteriormente:
  â€¢ Nombre: Juan PÃ©rez
  â€¢ DirecciÃ³n: Avenida Central, San Salvador
  â€¢ Ingreso: $800 - $1,000
  â€¢ Score: Bueno (95/100)

ğŸ’° Tu Nuevo PrÃ©stamo:
  â€¢ Monto: $500
  â€¢ Plazo: 30 dÃ­as
  â€¢ InterÃ©s estimado: 8.5%
  â€¢ RecibirÃ¡s: $458.50
```

**QuÃ© ocurre internamente:**

-   Sistema valida que usuario tenga primer prÃ©stamo activo
-   Se cargan datos del calculador
-   Se cargan datos personales del primer prÃ©stamo
-   Se valida que DUI no estÃ© expirado

---

#### **Paso 1: ActualizaciÃ³n de InformaciÃ³n Laboral/Financiera (Step 1)**

**Importante**: Este paso reutiliza datos del primer prÃ©stamo pero permite actualizar.

**Campos mostrados (con valores pre-llenados):**

| Campo                 | Tipo      | Obligatorio | Pre-llenado |
| --------------------- | --------- | ----------- | ----------- |
| Tipo de Empleo        | SelecciÃ³n | âœ… SÃ­       | âœ… SÃ­       |
| Nombre Empresa        | Texto     | âœ… SÃ­       | âœ… SÃ­       |
| TelÃ©fono Empresa      | TelÃ©fono  | âœ… SÃ­       | âœ… SÃ­       |
| Ingreso Neto          | SelecciÃ³n | âœ… SÃ­       | âœ… SÃ­       |
| Ingreso Adicional     | Cantidad  | âŒ Opcional | âœ… SÃ­       |
| Otras Deudas          | Cantidad  | âŒ Opcional | âœ… SÃ­       |
| **ExpiraciÃ³n DUI**    | Fecha     | âœ… SÃ­       | âŒ No       |
| PropÃ³sito PrÃ©stamo    | SelecciÃ³n | âœ… SÃ­       | âœ… SÃ­       |
| DescripciÃ³n PropÃ³sito | Texto     | âœ… SÃ­       | âœ… SÃ­       |

**QuÃ© es diferente:**

-   âœ… Todos los campos excepto "ExpiraciÃ³n DUI" vienen **pre-llenados**
-   âœ… Usuario puede **actualizar cualquier campo**
-   âœ… **ExpiraciÃ³n DUI**: Nuevo campo (no estaba en primer prÃ©stamo)
-   âœ… Menos fricciÃ³n visual

**Campo especial: ExpiraciÃ³n DUI**

```
Â¿CuÃ¡ndo expira tu DUI?
Formato: DD/MM/YYYY o selector de fecha

Validaciones:
  âœ“ No puede estar vencido
  âœ“ MÃ­nimo 90 dÃ­as para que venza
  âœ“ Si vence antes de desembolso: Aviso

Ejemplo:
  Hoy: 27/10/2025
  DUI expira: 15/06/2026 âœ… (8 meses)
  DUI expira: 05/10/2025 âŒ (ya expirÃ³)
```

**QuÃ© ocurre:**

1. Pantalla carga con datos pre-llenados del primer prÃ©stamo
2. Usuario revisa/actualiza datos si es necesario
3. Usuario ingresa fecha de expiraciÃ³n del DUI
4. Sistema valida todo
5. BotÃ³n "Continuar" se habilita

**Errores comunes:**

| Error                 | Causa                      | SoluciÃ³n                      |
| --------------------- | -------------------------- | ----------------------------- |
| DUI expirado          | Vencido o prÃ³ximo a vencer | Renovar DUI                   |
| Ingreso muy bajo      | CambiÃ³ situaciÃ³n laboral   | Actualizar ingresos           |
| Empresa no existe     | Datos desactualizados      | Verificar datos empresa       |
| Deudas muy altas      | SituaciÃ³n ha cambiado      | Revisar deudas                |
| DescripciÃ³n muy corta | < 10 caracteres            | Ampliar descripciÃ³n propÃ³sito |

---

#### **Paso 2: Referencias Personales + ImÃ¡genes (Step 2 + Step 3 combinados)**

**Este paso tiene 2 partes:**

##### Parte A: Referencias Personales

Igual que en primer prÃ©stamo:

| Campo          | Tipo     | ValidaciÃ³n          | Obligatorio |
| -------------- | -------- | ------------------- | ----------- |
| Nombre Ref 1   | Texto    | MÃ­nimo 2 caracteres | âœ… SÃ­       |
| Apellido Ref 1 | Texto    | MÃ­nimo 2 caracteres | âœ… SÃ­       |
| TelÃ©fono Ref 1 | TelÃ©fono | Formato vÃ¡lido      | âœ… SÃ­       |
| Nombre Ref 2   | Texto    | MÃ­nimo 2 caracteres | âœ… SÃ­       |
| Apellido Ref 2 | Texto    | MÃ­nimo 2 caracteres | âœ… SÃ­       |
| TelÃ©fono Ref 2 | TelÃ©fono | Formato vÃ¡lido      | âœ… SÃ­       |

##### Parte B: ImÃ¡genes

**Opciones:**

```
Â¿Usas las mismas imÃ¡genes del primer prÃ©stamo?

[ ] Usar las mismas
    â”œâ”€ Frente DUI: Ya cargada âœ…
    â”œâ”€ RevÃ©s DUI: Ya cargada âœ…
    â””â”€ Selfie: Ya cargada âœ…

[ ] Cargar nuevas imÃ¡genes
    â”œâ”€ Capturar frente DUI (nueva)
    â”œâ”€ Capturar revÃ©s DUI (nueva)
    â””â”€ Capturar selfie (nueva)

RecomendaciÃ³n: Si el DUI sigue siendo vÃ¡lido, puedes usar las mismas
```

**QuÃ© ocurre:**

1. Usuario ingresa referencias 1 y 2 (nuevas)
2. Usuario elige: Usar mismas imÃ¡genes o capturar nuevas
3. Si nuevas: Ejecutar flujo de carga (igual a #15-carga-de-imagenes.md)
4. Sistema valida todo
5. BotÃ³n "Continuar" se habilita

---

#### **Paso 3: ConfirmaciÃ³n (Completion Screen)**

**QuÃ© se muestra:**

1. Resumen de nueva informaciÃ³n ingresada (Step 1)
2. ConfirmaciÃ³n de referencias (Step 2)
3. Estado de imÃ¡genes (reutilizadas o nuevas)
4. Monto final del nuevo prÃ©stamo
5. Plazo seleccionado
6. CÃ¡lculo de intereses
7. Fecha estimada de recepciÃ³n
8. BotÃ³n "Confirmar y Enviar"

**Resumen mostrado:**

```
ğŸ“‹ RESUMEN DE TU NUEVA SOLICITUD

ğŸ’¼ InformaciÃ³n Laboral:
   â€¢ Empresa: TechCorp SRL
   â€¢ TelÃ©fono: +503 2111-1111
   â€¢ Ingreso: $800-$1,000
   â€¢ PropÃ³sito: Emergencia

ğŸ‘¥ Referencias:
   â€¢ Familiar: Carlos PÃ©rez
   â€¢ Amigo: Roberto LÃ³pez

ğŸ“¸ Documentos:
   â€¢ Frente DUI: Reutilizado âœ“
   â€¢ RevÃ©s DUI: Reutilizado âœ“
   â€¢ Selfie: Reutilizado âœ“

ğŸ’° TU NUEVO PRÃ‰STAMO:
   â€¢ Monto: $500
   â€¢ Plazo: 30 dÃ­as
   â€¢ InterÃ©s: $42.50
   â€¢ RecibirÃ¡s: $457.50
   â€¢ PrÃ³ximo pago: 26/11/2025
```

**Antes de enviar, se verifica:**

-   âœ… InformaciÃ³n laboral actualizada
-   âœ… Referencias ingresadas
-   âœ… ImÃ¡genes (reutilizadas o nuevas)
-   âœ… DUI vigente
-   âœ… Usuario confirma informaciÃ³n

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ PatrÃ³n ArquitectÃ³nico

Similar a first_loan pero **reducido a 3 pasos**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Presentation Layer (UI)                                    â”‚
â”‚                                                              â”‚
â”‚ â”œâ”€ SubsequentLoanWelcomeScreen        (Paso 0)            â”‚
â”‚ â”œâ”€ SubsequentLoanStepOneScreen        (Paso 1: Laboral)   â”‚
â”‚ â”œâ”€ SubsequentLoanStepTwoScreen        (Paso 2: Ref+Img)   â”‚
â”‚ â””â”€ SubsequentLoanCompletionScreen     (Paso 3: Confirm)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                          â”‚ (Riverpod Consumers)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State Mgmt   â”‚ â”‚ State Mgmt   â”‚ â”‚ State Mgmt      â”‚
â”‚              â”‚ â”‚              â”‚ â”‚                 â”‚
â”‚ Step1Notif.  â”‚ â”‚ Step2Notif.  â”‚ â”‚ Step3Notif.     â”‚
â”‚ Calculator   â”‚ â”‚ Geographic   â”‚ â”‚ Request Notif.  â”‚
â”‚ MyLoan Data  â”‚ â”‚ ImageUpload  â”‚ â”‚ LoanCalc Data   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Repository Layer                   â”‚
        â”‚                                    â”‚
        â”‚ SubsequentLoanRepository          â”‚
        â”‚ â”œâ”€ requestSubsequentLoan()        â”‚
        â”‚                                    â”‚
        â”‚ ImageUploadRepository             â”‚
        â”‚ â”œâ”€ uploadImage() (reutilizado)   â”‚
        â”‚                                    â”‚
        â”‚ MyLoanRepository                  â”‚
        â”‚ â”œâ”€ getMyLoan() (datos previos)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Data Layer (APIs & Services)       â”‚
        â”‚                                    â”‚
        â”‚ POST /client/request-loan         â”‚
        â”‚ POST /client/upload-images        â”‚
        â”‚ GET  /client/my-loans             â”‚
        â”‚ Bearer token authentication        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¦ ReutilizaciÃ³n de CÃ³digo

**Componentes compartidos:**

```
ImageUploadRepository (100% compartido)
â”œâ”€ Usado en: first_loan Step 5
â””â”€ Usado en: subsequent_loan Step 2

ImageType enum (100% compartido)
â”œâ”€ Usado en: first_loan
â””â”€ Usado en: subsequent_loan

Geographic data (100% compartido)
â”œâ”€ Departamentos
â”œâ”€ Distritos
â””â”€ Municipios

AdditionalDataRepository (100% compartido)
â”œâ”€ Job types
â”œâ”€ Purposes
â””â”€ Net income ranges
```

### ğŸ”„ Flujo de Datos Completo

```
Usuario Pre-cargado desde MyLoan
        â†“
Step1Notifier.loadMyLoanData()
        â”œâ”€ Cargar datos laborales del primer prÃ©stamo
        â”œâ”€ Cargar ingreso neto
        â””â”€ Cargar propÃ³sito anterior
        â†“
state = state.copyWith(
  jobType: TextInput.dirty(myLoan.jobType),
  companyName: CompanyNameInput.dirty(myLoan.companyName),
  // ... resto de campos
)
        â†“
Usuario ve formulario pre-llenado
        â†“
Usuario actualiza datos (ej: cambiar empresa)
        â†“
Step1Notifier.onCompanyNameChanged("NewCorp")
        â†“
state = state.copyWith(companyName: CompanyNameInput.dirty("NewCorp"))
        â†“
_updateValidation()
        â†“
isValid = true/false
        â†“
UI Re-renderiza
```

---

## Flujo Completo de Datos

### ğŸ”„ Secuencia Completa: De Welcome a Ã‰xito

```
INICIO: Usuario presiona "Solicitar Nuevo PrÃ©stamo"
    â†“
â”Œâ”€ WELCOME SCREEN
â”‚  â”œâ”€ Cargar datos del calculador
â”‚  â”œâ”€ Cargar datos del primer prÃ©stamo (MyLoan)
â”‚  â”œâ”€ Validar que DUI no estÃ© expirado
â”‚  â”œâ”€ Mostrar monto y plazo preseleccionados
â”‚  â””â”€ Presiona "Comencemos"
â”‚
â”œâ”€ STEP 1: ACTUALIZACIÃ“N DE INFORMACIÃ“N LABORAL
â”‚  â”œâ”€ Cargar datos del primer prÃ©stamo (pre-llenar)
â”‚  â”œâ”€ Usuario ingresa: ExpiraciÃ³n DUI
â”‚  â”œâ”€ Usuario puede actualizar: Empresa, Ingreso, PropÃ³sito, etc.
â”‚  â”œâ”€ Validaciones en tiempo real
â”‚  â””â”€ Presiona "Continuar" â†’ Datos guardados
â”‚
â”œâ”€ STEP 2: REFERENCIAS PERSONALES + IMÃGENES
â”‚  â”œâ”€ PARTE A: Referencias
â”‚  â”‚  â”œâ”€ Usuario ingresa Referencia 1
â”‚  â”‚  â”œâ”€ Usuario ingresa Referencia 2
â”‚  â”‚  â””â”€ Validar referencias diferentes
â”‚  â”‚
â”‚  â””â”€ PARTE B: ImÃ¡genes
â”‚     â”œâ”€ Â¿Reutilizar imÃ¡genes del primer prÃ©stamo?
â”‚     â”œâ”€ SI: Usar URLs existentes
â”‚     â””â”€ NO: Capturar nuevas imÃ¡genes
â”‚        â”œâ”€ Upload Frente DUI
â”‚        â”œâ”€ Upload RevÃ©s DUI
â”‚        â””â”€ Upload Selfie
â”‚
â”‚  â””â”€ Presiona "Continuar" â†’ Datos guardados
â”‚
â”œâ”€ COMPLETION SCREEN (Resumen)
â”‚  â”œâ”€ Mostrar resumen de NUEVA informaciÃ³n
â”‚  â”œâ”€ Mostrar referencias
â”‚  â”œâ”€ Mostrar estado de imÃ¡genes
â”‚  â”œâ”€ Mostrar monto final
â”‚  â”œâ”€ Mostrar plazo
â”‚  â”œâ”€ Mostrar cÃ¡lculos de interÃ©s
â”‚  â”œâ”€ Usuario revisa todo
â”‚  â””â”€ Presiona "Confirmar y Enviar"
â”‚
â”œâ”€ VALIDACIÃ“N FINAL
â”‚  â”œâ”€ Verificar que todos los steps estÃ©n completos
â”‚  â”œâ”€ Verificar que todas las validaciones pasen
â”‚  â”œâ”€ Verificar que DUI no estÃ© expirado
â”‚  â”œâ”€ Verificar que primer prÃ©stamo estÃ© activo
â”‚  â””â”€ Si TODO OK: Continuar, SI NO: Mostrar error
â”‚
â”œâ”€ CONSTRUCCIÃ“N DE PAYLOAD
â”‚  â””â”€ Recolectar datos â†’ SubsequentLoanRequest
â”‚
â”œâ”€ ENVÃO A API
â”‚  â”œâ”€ POST /client/request-loan (diferente al primero)
â”‚  â”œâ”€ Body: SubsequentLoanRequest.toJson()
â”‚  â”œâ”€ Headers: Authorization: Bearer <token>
â”‚  â””â”€ Response: SubsequentLoanResponse { message }
â”‚
â””â”€ FIN: PANTALLA DE Ã‰XITO
   â”œâ”€ "Tu solicitud fue enviada exitosamente"
   â”œâ”€ Mostrar monto aprobado
   â”œâ”€ Mostrar fecha de disponibilidad
   â””â”€ BotÃ³n "Volver a Mi PrÃ©stamo"
```

---

## Componentes y Pasos

### ğŸ“¦ State Models

#### SubsequentLoanStepOneState

```dart
@freezed
abstract class SubsequentLoanStepOneState
    with _$SubsequentLoanStepOneState {
  const factory SubsequentLoanStepOneState({
    @Default(DniExpiresAtInput.pure()) DniExpiresAtInput dniExpiresAt,
    @Default(TextInput.pure()) TextInput jobType,
    @Default(CompanyNameInput.pure()) CompanyNameInput companyName,
    @Default(PhoneInput.pure()) PhoneInput companyPhone,
    NetIncomeEntity? selectedNetIncome,
    @Default(AmountInput.pure()) AmountInput additionalIncome,
    @Default(AmountInput.pure()) AmountInput otherLoan,
    @Default(TextInput.pure()) TextInput purpose,
    @Default(TextInput.pure()) TextInput purposeDescription,
    @Default([]) List<String> jobTypes,
    @Default([]) List<String> purposes,
    @Default([]) List<NetIncomeEntity> netIncomes,
    @Default(false) bool isLoadingAdditionalData,
    @Default(false) bool isValid,
    String? errorMessage,
  }) = _SubsequentLoanStepOneState;
}
```

**Diferencia con first_loan Step 3:**

-   âœ… Agrega: `DniExpiresAtInput dniExpiresAt`
-   âœ… Todos los demÃ¡s campos iguales

#### SubsequentLoanStepTwoState

```dart
@freezed
abstract class SubsequentLoanStepTwoState
    with _$SubsequentLoanStepTwoState {
  const factory SubsequentLoanStepTwoState({
    @Default(false) bool isLoading,
    @Default('') String errorMessage,
    @Default(TextInput.pure()) TextInput familiarName,
    @Default(TextInput.pure()) TextInput familiarSurname,
    @Default(PhoneInput.pure()) PhoneInput familiarPhone,
    @Default(TextInput.pure()) TextInput friendName,
    @Default(TextInput.pure()) TextInput friendSurname,
    @Default(PhoneInput.pure()) PhoneInput friendPhone,
    @Default(false) bool isValid,
  }) = _SubsequentLoanStepTwoState;
}
```

#### SubsequentLoanStepThreeState

```dart
@freezed
abstract class SubsequentLoanStepThreeState
    with _$SubsequentLoanStepThreeState {
  const factory SubsequentLoanStepThreeState({
    @Default(false) bool isLoading,
    @Default('') String errorMessage,
    @Default(ImageUploadState()) ImageUploadState frontIdCard,
    @Default(ImageUploadState()) ImageUploadState backIdCard,
    @Default(ImageUploadState()) ImageUploadState selfie,
    @Default(false) bool isValid,
  }) = _SubsequentLoanStepThreeState;
}
```

#### SubsequentLoanRequestState

```dart
@freezed
abstract class SubsequentLoanRequestState
    with _$SubsequentLoanRequestState {
  const factory SubsequentLoanRequestState({
    @Default(RequestStatus.idle) RequestStatus status,
    @Default('') String errorMessage,
    SubsequentLoanResponse? response,
  }) = _SubsequentLoanRequestState;
}

enum RequestStatus { idle, loading, success, error }
```

### ğŸ”§ Notifiers

#### SubsequentLoanRequestNotifier (Orquestador)

```dart
@Riverpod(keepAlive: true)
class SubsequentLoanRequestNotifier
    extends _$SubsequentLoanRequestNotifier {
  @override
  SubsequentLoanRequestState build() {
    return const SubsequentLoanRequestState();
  }

  Future<void> sendSubsequentLoanRequest() async {
    try {
      LoggingService.info(
        'Starting subsequent loan request submission',
        tag: 'SUBSEQUENT_LOAN_REQUEST',
      );

      // 1. Validar todos los steps
      if (!_validateAllSteps()) {
        state = state.copyWith(
          status: RequestStatus.error,
          errorMessage: 'Por favor complete todos los pasos',
        );
        return;
      }

      // 2. Actualizar estado a loading
      state = state.copyWith(status: RequestStatus.loading);

      // 3. Construir payload
      final request = _buildSubsequentLoanRequest();

      // 4. Enviar a API
      final repository = ref.read(subsequentLoanRepositoryProvider);
      final response = await repository.requestSubsequentLoan(request);

      // 5. Guardar respuesta
      state = state.copyWith(
        status: RequestStatus.success,
        response: response,
      );
    } catch (e, stackTrace) {
      LoggingService.error(
        'Failed to send subsequent loan request',
        tag: 'SUBSEQUENT_LOAN_REQUEST',
        error: e,
        stackTrace: stackTrace,
      );

      state = state.copyWith(
        status: RequestStatus.error,
        errorMessage: e.toString(),
      );
    }
  }

  bool _validateAllSteps() {
    final step1 = ref.read(subsequentLoanStepOneProvider);
    final step2 = ref.read(subsequentLoanStepTwoProvider);
    final step3 = ref.read(subsequentLoanStepThreeProvider);
    final calculator = ref.read(loanCalculatorProvider);

    return step1.isValid &&
        step2.isValid &&
        step3.isValid &&
        calculator.selectedAmount > 0 &&
        calculator.selectedDays > 0;
  }

  SubsequentLoanRequest _buildSubsequentLoanRequest() {
    final myLoan = ref.read(myLoanProvider).loanData!;
    final step1 = ref.read(subsequentLoanStepOneProvider);
    final step2 = ref.read(subsequentLoanStepTwoProvider);
    final step3 = ref.read(subsequentLoanStepThreeProvider);
    final calculator = ref.read(loanCalculatorProvider);

    return SubsequentLoanRequest(
      // Del calculador
      amount: calculator.selectedAmount.toDouble(),
      deadline: calculator.selectedDays,
      promoCode: calculator.appliedPromoCode?.code,

      // Del paso 1: InformaciÃ³n actualizada
      dniExpiresAt: step1.dniExpiresAt.value,
      jobType: step1.jobType.value,
      companyName: step1.companyName.value,
      companyPhone: step1.companyPhone.value,
      netIncome: step1.selectedNetIncome?.value.toDouble() ?? 0.0,
      additionalIncome: step1.additionalIncome.doubleValue,
      otherLoan: step1.otherLoan.doubleValue,
      purpose: step1.purpose.value,
      purposeDescription: step1.purposeDescription.value,

      // Del paso 2: Referencias
      familiarName: step2.familiarName.value,
      familiarSurname: step2.familiarSurname.value,
      familiarPhone: step2.familiarPhone.value,
      friendName: step2.friendName.value,
      friendSurname: step2.friendSurname.value,
      friendPhone: step2.friendPhone.value,

      // Del paso 3: ImÃ¡genes
      imageFrontIdCard: step3.frontIdCard.imageUrl ?? "",
      imageBackIdCard: step3.backIdCard.imageUrl ?? "",
      imageSelfie: step3.selfie.imageUrl ?? "",
    );
  }
}
```

---

## APIs Utilizadas

### Endpoint Principal de Solicitud

#### `POST /client/request-loan`

**DescripciÃ³n**: EnvÃ­a solicitud de prÃ©stamo posterior. **DIFERENTE a `/client/request-first-loan`**

**Headers Requeridos**:

```
Content-Type: application/json
Authorization: Bearer <token_del_usuario>
Language: es
```

**Request Body (SubsequentLoanRequest)**:

```json
{
    "amount": 500.0,
    "deadline": 30,
    "promoCode": "LOYALTY2024",
    "dniExpiresAt": "2026-06-15",
    "jobType": "Empleado",
    "companyName": "TechCorp SRL",
    "companyPhone": "+503 2111-1111",
    "netIncome": 800.0,
    "additionalIncome": 200.0,
    "otherLoan": 0.0,
    "purpose": "Emergencia",
    "purposeDescription": "ReparaciÃ³n de vehÃ­culo para trabajo",
    "familiarName": "Carlos",
    "familiarSurname": "PÃ©rez",
    "familiarPhone": "+503 7888-8888",
    "friendName": "Roberto",
    "friendSurname": "LÃ³pez",
    "friendPhone": "+503 7999-9999",
    "imageFrontIdCard": "https://storage.example.com/images/uuid/frontIdCard.jpg",
    "imageBackIdCard": "https://storage.example.com/images/uuid/backIdCard.jpg",
    "imageSelfie": "https://storage.example.com/images/uuid/selfie.jpg"
}
```

**Diferencias con `/client/request-first-loan`:**

```
PRIMER PRÃ‰STAMO:
â”œâ”€ Endpoint: /client/request-first-loan
â”œâ”€ Campos: Nombre, Apellido, GÃ©nero, Fecha Nac., DUI, etc.
â””â”€ Total campos: 23

PRÃ‰STAMO POSTERIOR:
â”œâ”€ Endpoint: /client/request-loan
â”œâ”€ Campos: NO incluye datos personales (ya verificados)
â”œâ”€ AGREGA: dniExpiresAt (vigencia DUI)
â””â”€ Total campos: 19 (menos 4 campos personales)
```

**Response Exitosa (200 OK)**:

```json
{
    "status": 200,
    "message": "Solicitud enviada exitosamente"
}
```

**Respuestas de Error**:

| CÃ³digo | SituaciÃ³n           | Mensaje                                     |
| ------ | ------------------- | ------------------------------------------- |
| 400    | ValidaciÃ³n fallida  | "Campo [nombre] es invÃ¡lido"                |
| 401    | No autenticado      | "Usuario no autenticado"                    |
| 408    | Timeout             | "Tiempo de conexiÃ³n agotado"                |
| 422    | Solicitud rechazada | "DUI vencido" o "No tienes prÃ©stamo activo" |
| 429    | Rate limiting       | "Demasiadas solicitudes, intenta mÃ¡s tarde" |
| 500    | Error servidor      | "Error interno del servidor"                |

---

## Manejo de Errores

### ğŸš¨ Estrategia de Errores

#### Errores EspecÃ­ficos para PrÃ©stamo Posterior

```
Error: "DUI Vencido"
â”œâ”€ CÃ³digo: 422
â”œâ”€ Causa: dniExpiresAt < Hoy
â””â”€ AcciÃ³n: "Necesitas renovar tu DUI"

Error: "No tienes prÃ©stamo activo"
â”œâ”€ CÃ³digo: 422
â”œâ”€ Causa: Primer prÃ©stamo estÃ¡ completo/rechazado
â””â”€ AcciÃ³n: "Completa tu prÃ©stamo anterior primero"

Error: "Deuda pendiente"
â”œâ”€ CÃ³digo: 422
â”œâ”€ Causa: Pagos atrasados en prÃ©stamo actual
â””â”€ AcciÃ³n: "Ponerse al dÃ­a con pagos"

Error: "No elegible aÃºn"
â”œâ”€ CÃ³digo: 422
â”œâ”€ Causa: Menos de 30 dÃ­as desde Ãºltimo prÃ©stamo
â””â”€ AcciÃ³n: "Espera hasta [fecha] para solicitar"
```

### ğŸ“Š Ãrbol de DecisiÃ³n de Errores

```
Error en EnvÃ­o de PrÃ©stamo Posterior
    â”‚
    â”œâ”€ 400: ValidaciÃ³n
    â”‚   â””â”€ Resaltar campo invÃ¡lido
    â”‚
    â”œâ”€ 401: AutenticaciÃ³n
    â”‚   â””â”€ Redirigir a login
    â”‚
    â”œâ”€ 408: Timeout
    â”‚   â””â”€ BotÃ³n "Reintentar"
    â”‚
    â”œâ”€ 422: Rechazado
    â”‚   â”œâ”€ "DUI vencido"
    â”‚   â”‚   â””â”€ "Necesitas renovar tu DUI"
    â”‚   â”œâ”€ "No tienes prÃ©stamo activo"
    â”‚   â”‚   â””â”€ "Completa tu prÃ©stamo anterior"
    â”‚   â”œâ”€ "Deuda pendiente"
    â”‚   â”‚   â””â”€ "Pon al dÃ­a tus pagos"
    â”‚   â””â”€ "No elegible aÃºn"
    â”‚       â””â”€ "Espera hasta [fecha]"
    â”‚
    â”œâ”€ 429: Rate Limit
    â”‚   â””â”€ "Demasiadas solicitudes"
    â”‚
    â””â”€ 5xx: Servidor
        â””â”€ "Error del servidor, intenta mÃ¡s tarde"
```

---

## Validaciones

### ğŸ“‹ Validaciones por Paso

#### Paso 1: InformaciÃ³n Laboral Actualizada

```dart
- ExpiraciÃ³n DUI:
  - Formato: DD/MM/YYYY
  - Debe ser > hoy
  - Preferible > 90 dÃ­as
  - ValidaciÃ³n: RegExp y lÃ³gica de fechas

- Tipo de Empleo: Obligatorio (pre-llenado)
- Nombre Empresa: 3-100 caracteres
- TelÃ©fono Empresa: Formato vÃ¡lido
- Ingreso Neto: Obligatorio (pre-llenado)
- Ingreso Adicional: 0 - 99,999
- Otras Deudas: 0 - 99,999
- PropÃ³sito: Obligatorio (pre-llenado)
- DescripciÃ³n: 10-500 caracteres

Reglas:
  Ingreso Total = Ingreso Neto + Ingreso Adicional
  Monto MÃ¡ximo PrÃ©stamo = Ingreso Total * 0.3
```

#### Paso 2: Referencias

```dart
- Referencia 1 (Familiar):
  - Nombre: 2-50 caracteres
  - Apellido: 2-50 caracteres
  - TelÃ©fono: Formato vÃ¡lido

- Referencia 2 (Amigo):
  - Nombre: 2-50 caracteres
  - Apellido: 2-50 caracteres
  - TelÃ©fono: Formato vÃ¡lido

Regla:
  Los telÃ©fonos deben ser distintos (no iguales entre sÃ­)
```

#### Paso 3: ImÃ¡genes

```dart
OpciÃ³n 1: Reutilizar imÃ¡genes
- Todas las 3 ya cargadas âœ…
- URLs vÃ¡lidas del servidor

OpciÃ³n 2: Cargar nuevas
- Frente DUI: < 5MB, JPEG/PNG
- RevÃ©s DUI: < 5MB, JPEG/PNG
- Selfie: < 5MB, JPEG/PNG
```

---

## Testing

### ğŸ§ª Estrategia de Testing

#### 1. Unit Tests - ValidaciÃ³n DUI

```dart
group('DniExpiresAtInput Validation', () {
  test('valid future date should pass', () {
    final futureDate = DateTime.now().add(Duration(days: 100));
    final input = DniExpiresAtInput.dirty(
      futureDate.toString().split(' ').first,
    );

    expect(input.isValid, isTrue);
  });

  test('expired date should fail', () {
    final pastDate = DateTime.now().subtract(Duration(days: 10));
    final input = DniExpiresAtInput.dirty(
      pastDate.toString().split(' ').first,
    );

    expect(input.isValid, isFalse);
  });

  test('date expiring within 90 days should warn', () {
    final soonDate = DateTime.now().add(Duration(days: 30));
    final input = DniExpiresAtInput.dirty(
      soonDate.toString().split(' ').first,
    );

    // DUI is valid but should trigger warning
    expect(input.isValid, isTrue);
    expect(input.shouldWarn, isTrue);
  });
});
```

#### 2. State Management Tests

```dart
group('SubsequentLoanRequestNotifier', () {
  late ProviderContainer container;
  late MockSubsequentLoanRepository mockRepository;
  late MockMyLoanProvider mockMyLoan;

  setUp(() {
    mockRepository = MockSubsequentLoanRepository();
    mockMyLoan = MockMyLoanProvider();
    container = ProviderContainer(
      overrides: [
        subsequentLoanRepositoryProvider
          .overrideWithValue(mockRepository),
        myLoanProvider.overrideWithValue(mockMyLoan),
      ],
    );
  });

  test('validates all steps before sending', () async {
    // Setup: Incomplete steps

    final notifier =
        container.read(subsequentLoanRequestProvider.notifier);
    await notifier.sendSubsequentLoanRequest();

    final state = container.read(subsequentLoanRequestProvider);
    expect(state.status, equals(RequestStatus.error));
  });

  test('builds payload with all data', () async {
    // Setup: All steps complete

    when(mockRepository.requestSubsequentLoan(any))
      .thenAnswer((_) async => SubsequentLoanResponse(message: 'OK'));

    final notifier =
        container.read(subsequentLoanRequestProvider.notifier);
    await notifier.sendSubsequentLoanRequest();

    verify(
      mockRepository.requestSubsequentLoan(
        argThat(
          isA<SubsequentLoanRequest>()
            .having((r) => r.amount, 'amount', 500.0)
            .having((r) => r.deadline, 'deadline', 30),
        ),
      ),
    ).called(1);
  });
});
```

---

## Seguridad

### ğŸ” Consideraciones Importantes

#### 1. ValidaciÃ³n de Estado del Primer PrÃ©stamo

**Servidor debe validar:**

-   âœ… Usuario tiene primer prÃ©stamo activo
-   âœ… Primer prÃ©stamo estÃ¡ al dÃ­a (sin mora)
-   âœ… MÃ­nimo 30 dÃ­as desde Ãºltimo desembolso
-   âœ… Usuario no tiene otra solicitud en progreso

#### 2. ValidaciÃ³n de DUI

**Cliente:**

```dart
// Verificar que no estÃ© vencido
if (dniExpiresAt.isBefore(DateTime.now())) {
  return "DUI expirado";
}

// Advertencia si vence pronto
if (dniExpiresAt.isBefore(
  DateTime.now().add(Duration(days: 90)),
)) {
  return "DUI vence pronto";
}
```

**Servidor:**

-   Validar formato de fecha
-   Verificar que sea fecha razonable
-   Comparar con base de datos de DIUs

#### 3. Rate Limiting

**ProtecciÃ³n contra abuso:**

```
- MÃ¡ximo 3 solicitudes por usuario en 30 dÃ­as
- MÃ­nimo 30 dÃ­as entre solicitudes
- MÃ¡ximo 100 solicitudes por IP en 1 hora
```

#### 4. Cumplimiento Normativo

-   **KYC**: Datos ya verificados pero se validan de nuevo
-   **AML**: VerificaciÃ³n de cambios en informaciÃ³n
-   **GDPR**: Derecho al olvido para solicitudes rechazadas
-   **Regulaciones Locales**: Compliance con leyes de El Salvador

---

## ğŸ“ Resumen de Capas

| Capa           | Componente                      | Responsabilidad        |
| -------------- | ------------------------------- | ---------------------- |
| **UI**         | SubsequentLoanStepXScreen       | Mostrar UI actualizada |
| **State**      | SubsequentLoanStepXNotifier     | Validar y pre-llenar   |
| **State**      | SubsequentLoanRequestNotifier   | Orquestar, enviar      |
| **Repository** | SubsequentLoanRepository        | HTTP POST              |
| **Repository** | ImageUploadRepository (reutili) | Upload de imÃ¡genes     |
| **Data**       | HttpClient                      | HTTP client            |
| **Domain**     | SubsequentLoanRequest           | Modelo de datos        |

---

## ğŸš€ PrÃ³ximos Pasos

1. **PrÃ©stamos rÃ¡pidos**: AprobaciÃ³n en < 1 minuto para usuarios good-paying
2. **Refinanciamiento**: Consolidar mÃºltiples prÃ©stamos
3. **LÃ­nea de crÃ©dito**: Pre-aprobaciÃ³n automÃ¡tica
4. **Desembolso acelerado**: Transferencia en < 30 minutos
5. **Ofertas personalizadas**: Montos y plazos recomendados

---

**VersiÃ³n**: 1.0
**Ãšltima actualizaciÃ³n**: Octubre 2024
**Autor**: Equipo de Desarrollo Pisto
**Estado**: ProducciÃ³n âœ…
