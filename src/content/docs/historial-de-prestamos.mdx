---
title: Flujo de historial de prÃ©stamos
slug: historial-de-prestamos
tags: [auth, flutter, riverpod, dio, formz, go_router, freezed, json_annotation]
description: Flujo de historial de prÃ©stamos. GestiÃ³n completa del proceso de consulta y visualizaciÃ³n de prÃ©stamos.
---

## DescripciÃ³n General

La funcionalidad de **Historial de PrÃ©stamos** (`loans_history`) es el mÃ³dulo central que permite a los usuarios consultar y gestionar el historial completo de sus prÃ©stamos, incluyendo detalles de operaciones, estados del prÃ©stamo y acceso a documentos legales. Este mÃ³dulo proporciona una vista comprehensive de todas las transacciones pasadas y presentes, permitiendo a los usuarios tener control total sobre su historial financiero con Pisto.

### ğŸ“Š Estructura del Flujo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard       â”‚â”€â”€â”€â”€â–¶â”‚ Lista de         â”‚â”€â”€â”€â”€â–¶â”‚ Detalle del      â”‚â”€â”€â”€â”€â–¶â”‚ Documentos       â”‚â”€â”€â”€â”€â–¶â”‚ Visor de PDF     â”‚
â”‚ Principal       â”‚     â”‚ PrÃ©stamos        â”‚     â”‚ PrÃ©stamo         â”‚     â”‚ Legales          â”‚     â”‚ (Contrato/Nota)  â”‚
â”‚ (MenÃº)          â”‚     â”‚ (Historial)      â”‚     â”‚ (Operaciones)    â”‚     â”‚ (Descarga)       â”‚     â”‚ (VisualizaciÃ³n)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ Acceso directo      âœ“ DinÃ¡mica          âœ“ Detallado         âœ“ Seguro           âœ“ Integrado
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **Historial completo**: Lista de todos los prÃ©stamos del usuario
-   âœ… **Detalles por prÃ©stamo**: Operaciones, montos y estados
-   âœ… **Documentos legales**: Acceso a contratos y pagarÃ©s firmados
-   âœ… **Visor PDF integrado**: VisualizaciÃ³n nativa de documentos
-   âœ… **Estado en tiempo real**: InformaciÃ³n actualizada del prÃ©stamo
-   âœ… **NavegaciÃ³n intuitiva**: Flujo natural entre lista y detalles
-   âœ… **Manejo robusto de errores**: RecuperaciÃ³n ante fallos
-   âœ… **Carga diferida**: OptimizaciÃ³n de rendimiento con lazy loading

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

El historial de prÃ©stamos te permite:

-   **Ver todos tus prÃ©stamos**: Consulta prÃ©stamos pasados y presentes
-   **Revisar operaciones**: Detalles de pagos, intereses y movimientos
-   **Acceder a documentos legales**: Descarga tus contratos y pagarÃ©s
-   **Conocer el estado actual**: Verifica el estado de cada prÃ©stamo
-   **Tener control financiero**: MantÃ©n registro completo de tus transacciones

### ğŸ“± CÃ³mo acceder y usar el historial

#### Paso 1: Acceder al historial

Desde el menÃº principal de la app:

1. ğŸ  **Abre el menÃº lateral** - Toca el Ã­cono de hamburguesa (â˜°)
2. ğŸ“‹ **Busca "Historial de PrÃ©stamos"** - Encuentra la opciÃ³n en el menÃº
3. ğŸ‘† **Presiona la opciÃ³n** - AccederÃ¡s a tu historial completo
4. â³ **Espera la carga** - La app cargarÃ¡ tu historial automÃ¡ticamente

#### Paso 2: Explorar tu lista de prÃ©stamos

En la pantalla principal del historial:

**InformaciÃ³n disponible:**

-   ğŸ“… **Fecha del prÃ©stamo**: CuÃ¡ndo solicitaste cada prÃ©stamo
-   ğŸ’° **Monto total**: Cantidad que solicitaste
-   ğŸ“Š **Estado actual**: Pagado, activo, en proceso, etc.
-   ğŸ“„ **NÃºmero de contrato**: Identificador Ãºnico de cada prÃ©stamo
-   ğŸ“ˆ **InformaciÃ³n de pago**: Monto a pagar y fecha lÃ­mite

**Acciones disponibles:**

-   ğŸ‘ï¸ **Ver detalles** - Toca cualquier prÃ©stamo para ver mÃ¡s informaciÃ³n
-   ğŸ“± **NavegaciÃ³n fluida** - Desliza para ver todos tus prÃ©stamos
-   ğŸ”„ **Actualizar** - Tira hacia abajo para actualizar la lista

#### Paso 3: Ver detalles de un prÃ©stamo especÃ­fico

Al tocar un prÃ©stamo, accedes a informaciÃ³n detallada:

**InformaciÃ³n del prÃ©stamo:**

-   ğŸ“‹ **NÃºmero de contrato**: Identificador Ãºnico
-   ğŸ“… **Fechas importantes**: Solicitud, aprobaciÃ³n y vencimiento
-   ğŸ’° **Montos detallados**: Principal, intereses y total
-   ğŸ“Š **Estado actual**: SituaciÃ³n actual del prÃ©stamo

**Historial de operaciones:**

-   ğŸ“ˆ **CronologÃ­a completa**: Todas las operaciones en orden
-   ğŸ’¸ **Pagos realizados**: Montos y fechas de cada pago
-   ğŸ“Š **Saldos actualizados**: CÃ³mo cambia tu saldo con cada operaciÃ³n
-   ğŸ·ï¸ **Tipos de operaciÃ³n**: Desembolso, pago, interÃ©s, etc.

#### Paso 4: Acceder a documentos legales

Desde la pantalla de detalles del prÃ©stamo:

**Documentos disponibles:**

-   ğŸ“„ **Contrato firmado**: Acuerdo original del prÃ©stamo
-   ğŸ“‹ **PagarÃ© firmado**: Documento de pago
-   ğŸ“ **Solicitud original**: Tu solicitud inicial

**CÃ³mo acceder:**

1. ğŸ“„ **Busca "Documentos"** - SecciÃ³n en la pantalla de detalles
2. ğŸ‘† **Toca el documento** - Se abrirÃ¡ el visor de PDF
3. ğŸ“± **Visualiza el documento** - Usa gestos para navegar
4. ğŸ’¾ **OpciÃ³n de compartir** - Puedes enviar el documento por email o WhatsApp
5. ğŸ“¥ **Descarga local** - Guarda una copia en tu dispositivo

#### Paso 5: Usar el visor de PDF

El visor integrado te permite:

**NavegaciÃ³n del documento:**

-   ğŸ‘† **Scroll vertical** - Desliza para navegar pÃ¡ginas
-   ğŸ¤ **Pinch to zoom** - Acerca o aleja el contenido
-   ğŸ”„ **RotaciÃ³n** - Gira tu dispositivo para mejor visualizaciÃ³n
-   ğŸ“„ **Indicador de pÃ¡ginas** - Ve en quÃ© pÃ¡gina estÃ¡s

**Funciones adicionales:**

-   ğŸ“¤ **Compartir** - EnvÃ­a el documento por otras apps
-   ğŸ’¾ **Guardar** - Descarga copia local
-   ğŸ” **BÃºsqueda** - Busca texto dentro del documento
-   ğŸ“± **Modo pantalla completa** - Mejor experiencia de lectura

### âš ï¸ InformaciÃ³n importante

**Disponibilidad de documentos:**

-   ğŸ“„ Los documentos estÃ¡n disponibles segÃºn el estado del prÃ©stamo
-   â³ Puede haber un pequeÃ±o delay para documentos recientes
-   ğŸ”’ Algunos documentos requieren verificaciÃ³n de identidad

**Consideraciones de privacidad:**

-   ğŸ” Los documentos son sensibles y estÃ¡n protegidos
-   ğŸ“± Solo tÃº puedes acceder a tus documentos
-   ğŸ’¾ Las descargas locales son tu responsabilidad
-   ğŸš« No compartas documentos con terceros no autorizados

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ Estructura del MÃ³dulo

El mÃ³dulo sigue la arquitectura establecida en el proyecto Pisto con separaciÃ³n de responsabilidades clara:

```
loans_history/
â”œâ”€â”€ models/                      # DTOs y entidades de datos
â”‚   â”œâ”€â”€ loan_history.dart               # PrÃ©stamo individual en lista
â”‚   â”œâ”€â”€ loan_detail.dart                # Detalle completo del prÃ©stamo
â”‚   â”œâ”€â”€ loan_operation.dart             # OperaciÃ³n individual
â”‚   â””â”€â”€ loans_history_response.dart     # Respuesta de API
â”œâ”€â”€ providers/                   # GestiÃ³n de estado con Riverpod
â”‚   â”œâ”€â”€ loans_history_provider.dart     # Estado de lista de prÃ©stamos
â”‚   â””â”€â”€ loan_detail_provider.dart       # Estado de detalle individual
â”œâ”€â”€ repositories/               # Capa de acceso a datos
â”‚   â””â”€â”€ loans_history_repository.dart   # ComunicaciÃ³n con la API
â”œâ”€â”€ screens/                    # Interfaces de usuario
â”‚   â”œâ”€â”€ loans_history_screen.dart       # Lista principal de prÃ©stamos
â”‚   â”œâ”€â”€ loan_history_detail_screen.dart # Detalle de prÃ©stamo
â”‚   â””â”€â”€ loans_history_pdf_viewer_screen.dart # Visor de PDF
â””â”€â”€ widgets/                    # Componentes reutilizables
```

### ğŸ“Š Models (Entidades de Datos)

#### **LoanHistory**

Representa un prÃ©stamo en la lista del historial:

```dart
@freezed
class LoanHistory with _$LoanHistory {
  const factory LoanHistory({
    required int loanId,                    // ID Ãºnico del prÃ©stamo
    required String contractNumber,         // NÃºmero de contrato
    required int loanAmount,                // Monto del prÃ©stamo
    required DateTime returnDate,           // Fecha de vencimiento
    required double returnAmount,           // Monto total a pagar
  }) = _LoanHistory;

  factory LoanHistory.fromJson(Map<String, dynamic> json) =>
      _$LoanHistoryFromJson(json);
}
```

#### **LoanOperation**

Representa una operaciÃ³n individual del prÃ©stamo:

```dart
@freezed
class LoanOperation with _$LoanOperation {
  const factory LoanOperation({
    required int operationId,               // ID de la operaciÃ³n
    required DateTime date,                 // Fecha de la operaciÃ³n
    required String operation,              // Tipo de operaciÃ³n
    double? amount,                         // Monto de la operaciÃ³n
    double? balance,                        // Saldo despuÃ©s de operaciÃ³n
    required int loanStatus,                // Estado del prÃ©stamo
  }) = _LoanOperation;

  const LoanOperation._();

  // Determina si se pueden descargar documentos
  bool get canDownloadDocuments => [7, 8, 9, 10, 11, 12].contains(loanStatus);
}
```

#### **LoanDetail**

Contiene el detalle completo con todas las operaciones:

```dart
@freezed
class LoanDetail with _$LoanDetail {
  const factory LoanDetail({
    required List<LoanOperation> data,      // Lista de operaciones
  }) = _LoanDetail;

  const LoanDetail._();

  // MÃ©todos de conveniencia
  bool get isEmpty => data.isEmpty;
  bool get isNotEmpty => data.isNotEmpty;

  // Obtiene el estado mÃ¡s reciente
  int? get latestLoanStatus => data.isNotEmpty ? data.first.loanStatus : null;

  // Verifica disponibilidad de documentos
  bool get canDownloadDocuments =>
      latestLoanStatus != null &&
      [7, 8, 9, 10, 11, 12].contains(latestLoanStatus);
}
```

### ğŸ¯ Providers (GestiÃ³n de Estado)

#### **LoansHistoryNotifier**

StateNotifier para la lista de prÃ©stamos:

```dart
@freezed
class LoansHistoryState with _$LoansHistoryState {
  const factory LoansHistoryState({
    @Default(LoansHistoryStatus.initial) LoansHistoryStatus status,
    LoansHistoryResponse? loansHistory,     // Lista completa de prÃ©stamos
    String? personalDataPolicyUrl,          // URL de polÃ­tica de datos
    String? termsOfServiceUrl,              // URL de tÃ©rminos y condiciones
    String? errorMessage,                   // Error general
  }) = _LoansHistoryState;
}

@Riverpod(keepAlive: true)
class LoansHistoryNotifier extends _$LoansHistoryNotifier {
  @override
  LoansHistoryState build() {
    // Auto-inicializaciÃ³n al crear el provider
    Future.microtask(() => initialize());
    return const LoansHistoryState();
  }

  // MÃ©todos principales:
  // - Future<void> initialize()
  // - Future<void> fetchLoansHistory()
  // - Future<void> _loadDocumentUrls()
  // - void reset()
}

enum LoansHistoryStatus { initial, loading, loaded, error }
```

#### **LoanDetailNotifier**

StateNotifier para el detalle individual:

```dart
@freezed
class LoanDetailState with _$LoanDetailState {
  const factory LoanDetailState({
    @Default(LoanDetailStatus.initial) LoanDetailStatus status,
    LoanDetail? loanDetail,                 // Detalle del prÃ©stamo
    String? contractNumber,                 // NÃºmero de contrato
    String? loanContractSignedUrl,          // URL contrato firmado
    String? promissoryNoteSignedUrl,        // URL pagarÃ© firmado
    String? loanRequestUrl,                 // URL solicitud original
    String? errorMessage,                   // Error especÃ­fico
  }) = _LoanDetailState;
}

@Riverpod(keepAlive: true)
class LoanDetailNotifier extends _$LoanDetailNotifier {
  // MÃ©todos principales:
  // - Future<void> loadLoanDetail(int loanId, String contractNumber)
  // - void reset()
}

enum LoanDetailStatus { initial, loading, loaded, error }
```

### ğŸŒ Repository (Acceso a Datos)

#### **LoansHistoryRepository**

Clase responsable de la comunicaciÃ³n con la API:

```dart
class LoansHistoryRepository {
  // GET /client/loans-history
  Future<LoansHistoryResponse> fetchLoansHistory();

  // GET /client/loan-detail/{loanId}
  Future<LoanDetail> fetchLoanDetail(int loanId);
}

// Manejo especÃ­fico de errores
enum LoansHistoryExceptionType {
  networkError,      // Problemas de conectividad
  unauthorizedError, // No autenticado
  notFoundError,     // Recurso no encontrado
  timeoutError,      // Tiempo de espera agotado
  serverError,       // Error del servidor
  unknown,           // Error desconocido
}
```

---

## Flujo Completo de Datos

### ğŸ”„ Flujo de NavegaciÃ³n

```
MenÃº Principal
  â†“
/loans-history (Lista de prÃ©stamos)
  â”œâ”€â†’ [Seleccionar prÃ©stamo] â†’ /loans-history/detail/{loanId}
  â”‚   â”œâ”€â†’ [Ver operaciones] â†’ Timeline completo
  â”‚   â”œâ”€â†’ [Descargar documento] â†’ /loans-history/pdf-viewer
  â”‚   â””â”€â†’ [Compartir documento] â†’ Share sheet nativo
  â””â”€â†’ [Pull to refresh] â†’ Recargar lista
```

### ğŸ“Š Diagrama de Estado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  LoansHistoryNotifier                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: initial â†’ loading â†’ loaded â†’ error                      â”‚
â”‚                                                               â†‘ refresh â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Datos:                                                        â”‚
â”‚  - loansHistory: LoansHistoryResponse?                         â”‚
â”‚  - personalDataPolicyUrl: String?                              â”‚
â”‚  - termsOfServiceUrl: String?                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Acciones:                                                     â”‚
â”‚  - initialize(): Auto-carga datos y URLs                       â”‚
â”‚  - fetchLoansHistory(): Refresca lista manualmente             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LoanDetailNotifier                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: initial â†’ loading â†’ loaded â†’ error                      â”‚
â”‚                                                               â†‘ refresh â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Datos:                                                        â”‚
â”‚  - loanDetail: LoanDetail?                                     â”‚
â”‚  - contractNumber: String?                                     â”‚
â”‚  - loanContractSignedUrl: String?                              â”‚
â”‚  - promissoryNoteSignedUrl: String?                            â”‚
â”‚  - loanRequestUrl: String?                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Acciones:                                                     â”‚
â”‚  - loadLoanDetail(): Carga detalle y documentos en paralelo    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ Ciclo de Vida

1. **MenÃº â†’ Historial**: NavegaciÃ³n desde menÃº lateral
2. **Auto-inicializaciÃ³n**: Carga automÃ¡tica de datos al entrar
3. **Carga paralela**: Historial + URLs de documentos simultÃ¡neos
4. **SelecciÃ³n â†’ Detalle**: NavegaciÃ³n a prÃ©stamo especÃ­fico
5. **Carga de detalle**: Operaciones + URLs de documentos
6. **Visor de PDF**: NavegaciÃ³n a visor integrado
7. **NavegaciÃ³n back**: Retorno natural a lista o menÃº

---

## Componentes y Pasos

### ğŸ“± Pantallas del Flujo

#### 1. ğŸ“‹ LoansHistoryScreen

-   **Ruta**: `/loans-history`
-   **PropÃ³sito**: Lista principal de todos los prÃ©stamos del usuario
-   **Funcionalidad**:
    -   Auto-carga de historial al entrar
    -   Pull-to-refresh para actualizar manualmente
    -   Estados: loading, empty, error, loaded
    -   NavegaciÃ³n a detalles de cada prÃ©stamo
    -   Acceso rÃ¡pido a prÃ©stamo actual

#### 2. ğŸ“„ LoanHistoryDetailScreen

-   **Ruta**: `/loans-history/detail/{loanId}`
-   **PropÃ³sito**: Vista detallada de un prÃ©stamo especÃ­fico
-   **Funcionalidad**:
    -   Header con nÃºmero de contrato y navegaciÃ³n back
    -   Timeline de operaciones en orden cronolÃ³gico
    -   SecciÃ³n de documentos legales descargables
    -   Estados segÃºn disponibilidad de documentos
    -   Indicadores visuales de estado del prÃ©stamo

#### 3. ğŸ“± LoansHistoryPdfViewerScreen

-   **Ruta**: `/loans-history/pdf-viewer`
-   **PropÃ³sito**: Visor integrado para documentos PDF
-   **Funcionalidad**:
    -   VisualizaciÃ³n nativa de PDF
    -   Controles de zoom y navegaciÃ³n
    -   Opciones de compartir y guardar
    -   Indicador de pÃ¡ginas y progreso
    -   Manejo de errores de carga

### ğŸ§© Componentes Reutilizables

#### **LoanHistoryCard**

Componente para mostrar prÃ©stamo en lista:

```dart
class LoanHistoryCard extends StatelessWidget {
  final LoanHistory loan;
  final VoidCallback onTap;

  // Muestra: monto, fecha, estado, nÃºmero de contrato
}
```

#### **OperationTimelineItem**

Componente para operaciÃ³n en timeline:

```dart
class OperationTimelineItem extends StatelessWidget {
  final LoanOperation operation;
  final bool isFirst;
  final bool isLast;

  // Muestra: fecha, tipo, monto, saldo con indicadores visuales
}
```

#### **DocumentDownloadButton**

Componente para descarga de documentos:

```dart
class DocumentDownloadButton extends StatelessWidget {
  final String documentUrl;
  final String documentName;
  final bool isEnabled;

  // Maneja: descarga, visor PDF, compartir
}
```

---

## APIs Utilizadas

### ğŸ“¡ Endpoints de API

#### **GET** `/client/loans-history`

**PropÃ³sito**: Obtener lista completa de prÃ©stamos del usuario

**Headers Requeridos**:

```
Authorization: Bearer {token}
Content-Type: application/json
```

**Response Exitoso (200)**:

```json
{
    "data": [
        {
            "loanId": 123,
            "contractNumber": "PST-2025-001",
            "loanAmount": 50000,
            "returnDate": "2025-12-03T00:00:00Z",
            "returnAmount": 55000
        },
        {
            "loanId": 122,
            "contractNumber": "PST-2024-045",
            "loanAmount": 30000,
            "returnDate": "2024-10-15T00:00:00Z",
            "returnAmount": 33000
        }
    ]
}
```

**Error 401 (Unauthorized)**:

```json
{
    "message": "No autorizado. Token invÃ¡lido o expirado."
}
```

**Error 404 (Not Found)**:

```json
{
    "message": "Historial de prÃ©stamos no encontrado."
}
```

#### **GET** `/client/loan-detail/{loanId}`

**PropÃ³sito**: Obtener detalle completo de un prÃ©stamo especÃ­fico

**Path Parameters**:

-   `loanId`: ID del prÃ©stamo a consultar

**Response Exitoso (200)**:

```json
{
    "data": [
        {
            "operationId": 1001,
            "date": "2025-11-03T10:30:00Z",
            "operation": "Desembolso",
            "amount": 50000.0,
            "balance": 55000.0,
            "loanStatus": 7
        },
        {
            "operationId": 1002,
            "date": "2025-11-10T14:15:00Z",
            "operation": "Pago",
            "amount": -5000.0,
            "balance": 50000.0,
            "loanStatus": 7
        }
    ]
}
```

**Error 404 (Not Found)**:

```json
{
    "message": "PrÃ©stamo no encontrado."
}
```

### ğŸŒ IntegraciÃ³n con Document Repository

```dart
// URLs de documentos especÃ­ficos del prÃ©stamo
GET /client/documents/loan-contract-signed/{loanId}
GET /client/documents/promissory-note-signed/{loanId}
GET /client/documents/loan-request/{loanId}

// URLs de documentos generales
GET /client/documents/personal-data-policy
GET /client/documents/terms-of-service
```

---

## Manejo de Errores

### âš ï¸ Tipos de Errores

#### **1. Errores de Carga de Historial**

```dart
// Error de red
NetworkException {
  message: "Error de conexiÃ³n. Verifique su conectividad.",
  canRetry: true,
  retryCallback: () => ref.refresh(loansHistoryProvider),
}

// Timeout
TimeoutException {
  message: "Tiempo de espera agotado. Intente nuevamente.",
  canRetry: true,
}

// No autorizado
UnauthorizedException {
  message: "SesiÃ³n expirada. Por favor inicie sesiÃ³n nuevamente.",
  action: "redirect_to_login",
}
```

#### **2. Errores de Carga de Detalle**

```dart
// PrÃ©stamo no encontrado
LoanNotFoundException {
  message: "El prÃ©stamo solicitado no existe.",
  action: "redirect_to_history",
}

// Error del servidor
ServerException {
  message: "Error temporal del servidor. Intente mÃ¡s tarde.",
  canRetry: true,
  retryAfter: 300, // 5 minutos
}
```

#### **3. Errores de Documentos**

```dart
// Documento no disponible
DocumentNotAvailableException {
  message: "Este documento aÃºn no estÃ¡ disponible.",
  reason: "pending_approval",
}

// Error de carga de PDF
PDFLoadException {
  message: "No se pudo cargar el documento PDF.",
  canRetry: true,
  fallbackUrl: "download_alternative",
}
```

#### **4. Errores del Visor PDF**

```dart
// Archivo corrupto
CorruptFileException {
  message: "El archivo PDF estÃ¡ daÃ±ado o es invÃ¡lido.",
  action: "download_fresh_copy",
}

// Memoria insuficiente
MemoryException {
  message: "El documento es muy grande para visualizarlo.",
  action: "download_only",
}
```

### ğŸ”„ Estrategias de RecuperaciÃ³n

#### **Reintentos AutomÃ¡ticos**

```dart
@riverpod
class HistoryRetryNotifier extends _$HistoryRetryNotifier {
  int _retryCount = 0;
  static const int maxRetries = 3;

  Future<void> retryLoadHistory() async {
    if (_retryCount < maxRetries) {
      _retryCount++;
      await Future.delayed(Duration(seconds: _retryCount * 2));
      // Reintentar carga con backoff exponencial
    }
  }
}
```

#### **Fallback para Usuario**

-   **OpciÃ³n de reintentar manual** la carga
-   **Modo offline** con cachÃ© de datos bÃ¡sicos
-   **Descarga alternativa** para documentos problemÃ¡ticos
-   **Contactar soporte** con diagnÃ³stico automÃ¡tico

---

## Validaciones

### âœ… Validaciones Implementadas

1. **ValidaciÃ³n de Acceso**

    - VerificaciÃ³n de autenticaciÃ³n del usuario
    - ValidaciÃ³n de permisos para prÃ©stamos especÃ­ficos
    - Control de acceso a documentos segÃºn estado

2. **ValidaciÃ³n de Datos**

    - Formato correcto de IDs de prÃ©stamo
    - Estructura vÃ¡lida de respuestas JSON
    - Tipos de datos correctos (fechas, montos, estados)

3. **Validaciones de Negocio**
    - Usuario solo puede ver sus propios prÃ©stamos
    - Documentos disponibles segÃºn estado del prÃ©stamo
    - Operaciones en orden cronolÃ³gico vÃ¡lido

### ğŸ” LÃ³gica de ValidaciÃ³n

#### **ValidaciÃ³n de Acceso a Documentos**

```dart
class DocumentAccessValidator {
  static bool canDownloadDocument(int loanStatus) {
    // Estados que permiten descarga de documentos
    return [7, 8, 9, 10, 11, 12].contains(loanStatus);
  }

  static ValidationResult validateDocumentAccess(
    int loanId,
    int userId,
    int loanStatus,
  ) {
    if (!canDownloadDocument(loanStatus)) {
      return ValidationResult.invalid(
        'Los documentos aÃºn no estÃ¡n disponibles para este prÃ©stamo',
      );
    }

    // Validar propiedad del prÃ©stamo
    if (!_isLoanOwner(loanId, userId)) {
      return ValidationResult.invalid(
        'No tienes permiso para acceder a este documento',
      );
    }

    return ValidationResult.valid();
  }
}
```

#### **ValidaciÃ³n de Estados de PrÃ©stamo**

```dart
class LoanStatusValidator {
  static String getLoanStatusDescription(int status) {
    switch (status) {
      case 1:
        return 'Solicitado';
      case 2:
        return 'En revisiÃ³n';
      case 3:
        return 'Aprobado';
      case 7:
        return 'Activo';
      case 8:
        return 'Pagado';
      case 9:
        return 'Vencido';
      case 10:
        return 'En cobranza';
      case 11:
        return 'Castigado';
      case 12:
        return 'Liquidado';
      default:
        return 'Desconocido';
    }
  }

  static bool isLoanActive(int status) {
    return [3, 7].contains(status);
  }

  static bool isLoanCompleted(int status) {
    return [8, 12].contains(status);
  }
}
```

### ğŸ›¡ï¸ Consideraciones de Privacidad

-   Los datos del historial solo son accesibles por el propietario
-   Los documentos legales tienen control de acceso granular
-   Las URLs de documentos tienen expiraciÃ³n temporal
-   AuditorÃ­a completa de accesos a documentos sensibles

---

## Testing

### ğŸ§ª Estrategia de Testing

#### **1. Unit Tests**

```dart
// test/unit/loans_history_test.dart
void main() {
  group('LoansHistoryNotifier', () {
    test('debe cargar historial correctamente', () {
      // Test de carga de lista de prÃ©stamos
    });

    test('debe manejar error de red apropiadamente', () {
      // Test de manejo de excepciones de red
    });

    test('debe inicializar URLs de documentos', () {
      // Test de carga paralela de URLs
    });
  });
}
```

#### **2. Widget Tests**

```dart
// test/widget/loans_history_screen_test.dart
void main() {
  testWidgets('debe mostrar lista de prÃ©stamos correctamente', (tester) async {
    // Test de renderizado de lista
  });

  testWidgets('debe mostrar estado vacÃ­o cuando no hay prÃ©stamos', (tester) async {
    // Test de estado empty
  });

  testWidgets('debe navegar a detalles al tocar prÃ©stamo', (tester) async {
    // Test de navegaciÃ³n
  });
}
```

#### **3. Integration Tests**

```dart
// test/integration/loans_history_flow_test.dart
void main() {
  integrationTest('flujo completo de historial', () async {
    // Simular menÃº â†’ lista â†’ detalles â†’ documentos
  });

  integrationTest('manejo de errores de carga', () async {
    // Test de recuperaciÃ³n ante fallos
  });
}
```

### ğŸ“‹ Casos de Prueba CrÃ­ticos

#### **Flujos de Usuario**

-   âœ… Usuario carga historial con mÃºltiples prÃ©stamos
-   âœ… Usuario navega a detalles de prÃ©stamo especÃ­fico
-   âœ… Usuario descarga y visualiza documento PDF
-   âœ… Usuario maneja error de red durante carga
-   âœ… Usuario comparte documento por email

#### **Casos LÃ­mite**

-   ğŸ”„ Historial vacÃ­o (primer vez del usuario)
-   ğŸ”„ PrÃ©stamo sin documentos disponibles
-   ğŸ”„ Documento PDF muy grande o corrupto
-   ğŸ”„ PÃ©rdida de conexiÃ³n durante carga de detalles
-   ğŸ”„ Token expirado durante navegaciÃ³n

### ğŸ“Š MÃ©tricas de Testing

-   **Cobertura mÃ­nima**: 85% para cÃ³digo crÃ­tico
-   **Tests de flujos**: 100% de los caminos principales
-   **Tests de validaciÃ³n**: Todas las reglas de acceso
-   **Tests de error**: Todos los tipos de error cubiertos

---

## Seguridad

### ğŸ”’ CaracterÃ­sticas de Seguridad

#### **1. ProtecciÃ³n de Datos**

-   âœ… **Acceso restringido**: Solo propietario del prÃ©stamo
-   âœ… **URLs temporales**: Documentos con expiraciÃ³n limitada
-   âœ… **EncriptaciÃ³n en trÃ¡nsito**: Todos los datos viajan por HTTPS
-   âœ… **ValidaciÃ³n de token**: AutenticaciÃ³n en cada peticiÃ³n

#### **2. Validaciones de Seguridad**

```dart
// ValidaciÃ³n de acceso a prÃ©stamo
bool validateLoanAccess(int loanId, int userId) {
  // Verificar que el prÃ©stamo pertenezca al usuario
  // Validar token de autenticaciÃ³n
  // Comprobar permisos especÃ­ficos
}

// SanitizaciÃ³n de URLs de documentos
String sanitizeDocumentUrl(String url) {
  // Validar dominio permitido
  // Verificar firma temporal
  // Detectar manipulaciÃ³n
}
```

#### **3. Manejo de SesiÃ³n**

-   â° **Timeout de documentos**: URLs expiran despuÃ©s de tiempo lÃ­mite
-   ğŸ”„ **Refresh automÃ¡tico**: RenovaciÃ³n de tokens durante navegaciÃ³n
-   ğŸšª **Logout seguro**: Limpieza completa de cachÃ© sensible

### ğŸ›¡ï¸ Consideraciones de Privacidad

#### **Datos Sensibles**

-   âŒ **No almacenar localmente**: Documentos legales no guardados
-   âŒ **No hacer cachÃ©**: URLs temporales no persisten
-   âœ… **Solo memoria volÃ¡til**: Datos durante la sesiÃ³n
-   âœ… **EliminaciÃ³n garantizada**: Clean up explÃ­cito en todos los casos

#### **Cumplimiento Normativo**

-   ğŸ“‹ **ProtecciÃ³n financiera**: Cumplimiento con regulaciones de datos
-   ğŸ” **Audit trail**: Registro completo de accesos a documentos
-   ğŸ“Š **Transparencia**: InformaciÃ³n clara de estados y permisos
-   ğŸ¦ **Banking compliance**: EstÃ¡ndares de manejo de informaciÃ³n financiera

### ğŸ” Best Practices Implementadas

```dart
// Ejemplo de implementaciÃ³n segura
class SecureDocumentService {
  Future<String> getSecureDocumentUrl(int loanId, DocumentType type) async {
    try {
      // 1. Validar acceso del usuario
      await _validateDocumentAccess(loanId, type);

      // 2. Obtener URL temporal firmada
      final secureUrl = await _documentRepository.getSecureUrl(loanId, type);

      // 3. Validar y sanitizar URL
      final sanitizedUrl = _sanitizeDocumentUrl(secureUrl);

      return sanitizedUrl;
    } catch (e) {
      _handleSecureDocumentError(e);
      throw SecureDocumentException.fromError(e);
    }
  }
}
```

---

## ğŸš€ ImplementaciÃ³n y Mantenimiento

### ğŸ“¦ Dependencias Clave

```yaml
dependencies:
    flutter_riverpod: ^2.4.0 # GestiÃ³n de estado
    go_router: ^12.0.0 # NavegaciÃ³n
    freezed_annotation: ^2.4.0 # Modelos inmutables
    json_annotation: ^4.8.0 # SerializaciÃ³n JSON
    dio: ^5.3.0 # Cliente HTTP
    intl: ^0.18.0 # Formato de fechas
    pdf: ^3.10.0 # Visor de PDF (si aplica)

dev_dependencies:
    riverpod_generator: ^2.3.0 # Code generation
    freezed: ^2.4.0 # GeneraciÃ³n de modelos
    json_serializable: ^6.7.0 # GeneraciÃ³n JSON
    build_runner: ^2.4.0 # Herramienta de generaciÃ³n
```

### ğŸ”§ Comandos de Desarrollo

```bash
# Generar cÃ³digo (requerido despuÃ©s de cambios)
dart run build_runner build --delete-conflicting-outputs

# Modo watch durante desarrollo
dart run build_runner watch -d

# Ejecutar pruebas
flutter test test/features/loans_history/

# AnÃ¡lisis estÃ¡tico
flutter analyze lib/features/loans_history/
```

### ğŸ“ Mejores PrÃ¡cticas

1. **Code Generation**: Siempre ejecutar `build_runner` despuÃ©s de modificar modelos o providers
2. **State Management**: Usar `keepAlive: true` para persistencia durante navegaciÃ³n
3. **Error Handling**: Implementar manejo especÃ­fico para cada tipo de error
4. **Testing**: Mantener cobertura >85% para cÃ³digo crÃ­tico
5. **Document Security**: No almacenar URLs de documentos localmente
6. **Performance**: Usar carga diferida para listas largas

---

## ğŸ”— Integraciones

### ğŸ“„ MÃ³dulos Relacionados

-   **Auth**: GestiÃ³n de tokens y autenticaciÃ³n
-   **MyLoan**: InformaciÃ³n del prÃ©stamo activo actual
-   **Documents**: Repositorio central de documentos legales
-   **Network**: ConfiguraciÃ³n HTTP y manejo de errores
-   **Shared**: Componentes UI reutilizables

### ğŸ”„ Flujo de Datos

```
Auth (Usuario autenticado)
  â†“
LoansHistory (Lista de prÃ©stamos)
  â†“
LoanDetail (Detalle especÃ­fico)
  â†“
Documents (URLs seguras)
  â†“
PDFViewer (VisualizaciÃ³n)
```
