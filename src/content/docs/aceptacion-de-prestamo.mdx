---
title: Flujo de aceptaciÃ³n de PrÃ©stamos
slug: aceptacion-de-prestamo
tags: [auth, flutter, riverpod, dio, formz, go_router, freezed, json_annotation]
description: Flujo de aceptaciÃ³n de PrÃ©stamos. GestiÃ³n completa del proceso de confirmaciÃ³n de datos bancarios para la transferencia de fondos de prÃ©stamos aprobados.
---

## DescripciÃ³n General

La funcionalidad de **AceptaciÃ³n de PrÃ©stamos** (`accept_loan`) es el mÃ³dulo responsable de gestionar el proceso completo de confirmaciÃ³n de datos bancarios para la transferencia de fondos de prÃ©stamos aprobados. Este mÃ³dulo se activa automÃ¡ticamente despuÃ©s de que el usuario completa exitosamente el proceso de firma digital en el mÃ³dulo **OneShot**.

### ğŸ“Š Estructura de Pantallas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OneShot     â”‚â”€â”€â”€â”€â–¶â”‚ Splash Screen    â”‚â”€â”€â”€â”€â–¶â”‚ Confirmar Datos â”‚â”€â”€â”€â”€â–¶â”‚ Formulario   â”‚â”€â”€â”€â”€â–¶â”‚ Resultado   â”‚
â”‚ (Firma)     â”‚     â”‚ (Carga inicial)  â”‚     â”‚ (Previos/Nuevo) â”‚     â”‚ (Bancarios)  â”‚     â”‚ (Ã‰xito)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ Completado        âœ“ AutomÃ¡tica           âœ“ OpciÃ³n mÃºltiple      âœ“ ValidaciÃ³n      âœ“ Transferencia
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **Flujo condicional inteligente**: Detecta datos bancarios previos
-   âœ… **ValidaciÃ³n dinÃ¡mica**: Adaptada a las reglas de cada banco
-   âœ… **ReutilizaciÃ³n de datos**: OpciÃ³n de usar cuentas anteriores
-   âœ… **Seguridad robusta**: No persiste datos sensibles localmente
-   âœ… **Manejo de errores especÃ­ficos**: Diferentes mensajes por tipo
-   âœ… **IntegraciÃ³n con OneShot**: ActivaciÃ³n automÃ¡tica post-firma
-   âœ… **Estado persistente**: Mantiene datos durante navegaciÃ³n
-   âœ… **Experiencia optimizada**: Flujo guiado y feedback inmediato

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

La aceptaciÃ³n de prÃ©stamos es el paso final para recibir tu dinero:

-   **Confirma tu cuenta**: Donde recibirÃ¡s los fondos
-   **Valida tus datos**: Asegura que la informaciÃ³n sea correcta
-   **Procesa la transferencia**: Autoriza el envÃ­o del dinero
-   **Garantiza seguridad**: Protege tu informaciÃ³n bancaria

### ğŸ“± Pasos para aceptar tu prÃ©stamo

#### Paso 1: FinalizaciÃ³n de OneShot

DespuÃ©s de completar la firma digital:

1. âœ… **Firma completada** - Documentos firmados exitosamente
2. âœ… **RedirecciÃ³n automÃ¡tica** - La app te llevarÃ¡ a la pantalla de aceptaciÃ³n
3. âœ… **Carga de datos** - El sistema obtiene informaciÃ³n de tu prÃ©stamo aprobado

#### Paso 2: RevisiÃ³n de datos bancarios

**Si tienes datos previos:**

-   ğŸ“‹ **VerÃ¡s tu informaciÃ³n**: Banco, nÃºmero y tipo de cuenta
-   ğŸ” **Confirma los datos**: AsegÃºrate que sean correctos
-   âš–ï¸ **Toma una decisiÃ³n**:
    -   "Transferir a la misma cuenta" - Si los datos son correctos
    -   "Registrar nueva cuenta" - Si quieres cambiar de banco
    -   "Cancelar" - Si necesitas mÃ¡s tiempo

**Si es tu primer prÃ©stamo:**

-   ğŸ¦ **Selecciona un banco**: Elige de la lista de bancos disponibles
-   ğŸ‘† **Toca el banco deseado**: Se mostrarÃ¡ seleccionado
-   â–¶ï¸ **Presiona "Continuar"**: Avanza al formulario de datos

#### Paso 3: Ingreso de datos bancarios

Completa el formulario con:

-   ğŸ“ **NÃºmero de cuenta**: Ingresa tu nÃºmero de cuenta bancaria
-   ğŸ’³ **Tipo de cuenta**: Selecciona "Ahorro" o "Corriente"
-   âœ… **ValidaciÃ³n automÃ¡tica**: El sistema verifica que el nÃºmero sea correcto
-   ğŸ”¢ **DÃ­gitos requeridos**: VarÃ­a segÃºn banco y tipo de cuenta

#### Paso 4: ConfirmaciÃ³n final

Revisa toda la informaciÃ³n:

-   ğŸ‘€ **Verifica los datos**: Banco, cuenta y tipo
-   âš ï¸ **Advertencia importante**: "Verifica que los datos sean correctos"
-   âœ… **Presiona "Confirmar"**: EnvÃ­a la informaciÃ³n para procesar
-   â³ **Espera la confirmaciÃ³n**: El sistema procesarÃ¡ tu solicitud

#### Paso 5: Resultado del proceso

**Si es exitoso:**

-   ğŸ‰ **PrÃ©stamo aceptado**: Mensaje de confirmaciÃ³n
-   ğŸ’° **Transferencia en proceso**: El dinero llegarÃ¡ pronto a tu cuenta
-   ğŸ  **Ve a tu dashboard**: Presiona "Continuar" para ver tu prÃ©stamo

**Si hay errores:**

-   âŒ **Mensaje de error**: Explica quÃ© saliÃ³ mal
-   ğŸ”„ **OpciÃ³n de reintentar**: Corrige los datos e intenta nuevamente
-   ğŸ“ **Contacta soporte**: Si el problema persiste

### âš ï¸ Importante

-   **Verifica dos veces**: Los datos bancarios no se pueden cambiar despuÃ©s de confirmar
-   **Ten tu cuenta a mano**: NecesitarÃ¡s el nÃºmero completo de tu cuenta
-   **Conoce tu tipo de cuenta**: Ahorro o Corriente segÃºn tu banco
-   **No cierres la app**: MantÃ©n la aplicaciÃ³n abierta durante el proceso

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ Estructura del MÃ³dulo

El mÃ³dulo sigue la arquitectura establecida en el proyecto Pisto con separaciÃ³n de responsabilidades clara:

```
accept_loan/
â”œâ”€â”€ models/                      # DTOs y entidades de datos
â”‚   â”œâ”€â”€ bank_entity.dart        # InformaciÃ³n de bancos disponibles
â”‚   â”œâ”€â”€ accept_loan_step_one_response.dart # Respuesta inicial
â”‚   â”œâ”€â”€ accept_loan_request.dart # Payload para confirmaciÃ³n
â”‚   â””â”€â”€ accept_loan_success_response.dart # Respuesta final
â”œâ”€â”€ providers/                   # GestiÃ³n de estado con Riverpod
â”‚   â”œâ”€â”€ accept_loan_data_provider.dart # Carga inicial de datos
â”‚   â””â”€â”€ accept_loan_provider.dart # Estado principal del flujo
â”œâ”€â”€ repositories/               # Capa de acceso a datos
â”‚   â””â”€â”€ accept_loan_repository.dart # ComunicaciÃ³n con la API
â”œâ”€â”€ screens/                    # Interfaces de usuario
â”‚   â”œâ”€â”€ accept_loan_splash_screen.dart # Punto de entrada
â”‚   â”œâ”€â”€ confirm_old_bank_data_screen.dart # Datos previos
â”‚   â”œâ”€â”€ register_new_account_screen.dart # SelecciÃ³n de banco
â”‚   â”œâ”€â”€ add_bank_data_screen.dart # Formulario de datos
â”‚   â”œâ”€â”€ confirm_bank_data_screen.dart # ConfirmaciÃ³n final
â”‚   â””â”€â”€ accept_loan_result_screen.dart # Resultado del proceso
â””â”€â”€ widgets/                    # Componentes reutilizables
```

### ğŸ“Š Models (Entidades de Datos)

#### **BankEntity**

Representa la informaciÃ³n de un banco con sus reglas de validaciÃ³n:

```dart
@freezed
class BankEntity with _$BankEntity {
  const factory BankEntity({
    required int id,                           // ID Ãºnico del banco
    required String name,                      // Nombre del banco
    required String logo,                      // URL del logo
    required int minDigitsSaving,              // DÃ­gitos mÃ­nimos para ahorro
    required int maxDigitsSaving,              // DÃ­gitos mÃ¡ximos para ahorro
    required int minDigitsChecking,            // DÃ­gitos mÃ­nimos para corriente
    required int maxDigitsChecking,            // DÃ­gitos mÃ¡ximos para corriente
  }) = _BankEntity;
}
```

#### **AcceptLoanStepOneResponse**

Respuesta del endpoint inicial con datos del prÃ©stamo:

```dart
@freezed
class AcceptLoanStepOneResponse with _$AcceptLoanStepOneResponse {
  const factory AcceptLoanStepOneResponse({
    required int loanId,                       // ID del prÃ©stamo aprobado
    int? oldBankId,                           // null si es primera vez
    String? oldAccountNumber,                 // Cuenta anterior
    String? oldAccountType,                   // "ahorro" | "corriente"
    required String contract,                  // URL del contrato
    required List<BankEntity> banks,          // Lista de bancos disponibles
  }) = _AcceptLoanStepOneResponse;
}
```

### ğŸ¯ Providers (GestiÃ³n de Estado)

#### **AcceptLoanDataProvider**

FutureProvider para carga inicial de datos:

```dart
@riverpod
Future<AcceptLoanStepOneResponse> acceptLoanData(Ref ref) async {
  final repository = ref.read(acceptLoanRepositoryProvider);
  return repository.fetchLoanData();
}
```

#### **AcceptLoanNotifier**

StateNotifier principal con seguimiento de estado:

```dart
enum AcceptLoanStatus {
  initial,        // Estado inicial
  loading,        // Cargando datos
  dataLoaded,     // Datos cargados exitosamente
  submitting,     // Enviando confirmaciÃ³n
  completed,      // Proceso completado
  error,          // Error en el proceso
}

@Riverpod(keepAlive: true)
class AcceptLoanNotifier extends _$AcceptLoanNotifier {
  // MÃ©todos principales:
  // - void selectBank(BankEntity bank)
  // - void onAccountNumberChanged(String value)
  // - void onAccountTypeChanged(String type)
  // - Future<void> submitBankAccount()
  // - void reset()
}
```

### ğŸŒ Repository (Acceso a Datos)

#### **AcceptLoanRepository**

Clase responsable de la comunicaciÃ³n con la API:

```dart
class AcceptLoanRepository {
  // GET /client/accept-loan-step-1
  Future<AcceptLoanStepOneResponse> fetchLoanData();

  // POST /client/accept-loan-step-2
  Future<AcceptLoanSuccessResponse> acceptLoan(AcceptLoanRequest request);
}
```

---

## Flujo Completo de Datos

### ğŸ”„ Flujo de NavegaciÃ³n

#### **Flujo con Datos Bancarios Previos**

```
OneShot (Firma completada)
  â†“
/accept-loan/splash (Carga datos)
  â†“ [Detecta datos previos]
/accept-loan/confirm-old-bank-data
  â”œâ”€â†’ [Transferir a misma cuenta]
  â”‚   â””â”€â†’ /accept-loan/confirm-bank-data
  â”‚       â””â”€â†’ /accept-loan/result
  â”‚           â””â”€â†’ /my-loan (Dashboard)
  â”‚
  â””â”€â†’ [Registrar nueva cuenta]
      â””â”€â†’ /accept-loan/register-new-account
          â””â”€â†’ /accept-loan/add-bank-data
              â””â”€â†’ /accept-loan/confirm-bank-data
                  â””â”€â†’ /accept-loan/result
                      â””â”€â†’ /my-loan (Dashboard)
```

#### **Flujo sin Datos Previos (Primera vez)**

```
OneShot (Firma completada)
  â†“
/accept-loan/splash (Carga datos)
  â†“ [Sin datos previos]
/accept-loan/register-new-account
  â†“
/accept-loan/add-bank-data
  â†“
/accept-loan/confirm-bank-data
  â†“
/accept-loan/result
  â†“
/my-loan (Dashboard)
```

### ğŸ“Š Diagrama de Estado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AcceptLoanNotifier                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: initial â†’ loading â†’ dataLoaded â†’ submitting â†’ completed â”‚
â”‚                                                            â†‘ error â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Datos:                                                         â”‚
â”‚  - loanData: AcceptLoanStepOneResponse?                         â”‚
â”‚  - selectedBank: BankEntity?                                    â”‚
â”‚  - accountNumber: String                                        â”‚
â”‚  - accountType: AccountTypeInput?                               â”‚
â”‚  - isAccountNumberValid: bool                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ Ciclo de Vida

1. **OneShot â†’ Splash**: NavegaciÃ³n automÃ¡tica post-firma
2. **Splash â†’ DecisiÃ³n**: Carga datos y elige ruta
3. **DecisiÃ³n â†’ Formulario**: Basado en existencia de datos previos
4. **Formulario â†’ ConfirmaciÃ³n**: ValidaciÃ³n y resumen
5. **ConfirmaciÃ³n â†’ Resultado**: EnvÃ­o y procesamiento
6. **Result â†’ Dashboard**: NavegaciÃ³n final y limpieza

---

## Componentes y Pasos

### ğŸ“± Pantallas del Flujo

#### 1. ğŸ“± AcceptLoanSplashScreen

-   **Ruta**: `/accept-loan/splash`
-   **PropÃ³sito**: Punto de entrada que carga datos y decide el flujo
-   **Funcionalidad**:
    -   Carga automÃ¡tica de datos del prÃ©stamo aprobado
    -   DecisiÃ³n inteligente de navegaciÃ³n basada en historial
    -   Manejo de estados de carga y error

#### 2. ğŸ¦ ConfirmOldBankDataScreen

-   **Ruta**: `/accept-loan/confirm-old-bank-data`
-   **PropÃ³sito**: Mostrar datos bancarios de prÃ©stamos anteriores
-   **Funcionalidad**:
    -   Muestra banco, nÃºmero y tipo de cuenta anterior
    -   OpciÃ³n de reutilizar datos existentes
    -   OpciÃ³n de registrar nueva cuenta
    -   BotÃ³n de cancelaciÃ³n para regresar al dashboard

#### 3. ğŸ¯ RegisterNewAccountScreen

-   **Ruta**: `/accept-loan/register-new-account`
-   **PropÃ³sito**: SelecciÃ³n de banco mediante grid visual
-   **Funcionalidad**:
    -   Grid de bancos disponibles (2 columnas)
    -   Cards con logo y nombre de cada banco
    -   SelecciÃ³n Ãºnica con radio button
    -   ValidaciÃ³n de selecciÃ³n antes de continuar

#### 4. ğŸ“ AddBankDataScreen

-   **Ruta**: `/accept-loan/add-bank-data`
-   **PropÃ³sito**: Formulario para capturar datos bancarios
-   **Funcionalidad**:
    -   Muestra informaciÃ³n del usuario (solo lectura)
    -   Muestra banco seleccionado (solo lectura)
    -   Campo editable para nÃºmero de cuenta
    -   Selector de tipo de cuenta (Ahorro/Corriente)
    -   ValidaciÃ³n dinÃ¡mica segÃºn banco y tipo

#### 5. âœ… ConfirmBankDataScreen

-   **Ruta**: `/accept-loan/confirm-bank-data`
-   **PropÃ³sito**: ConfirmaciÃ³n final antes de enviar
-   **Funcionalidad**:
    -   Resumen completo de datos a confirmar
    -   Mensaje de advertencia sobre verificaciÃ³n
    -   BotÃ³n de confirmaciÃ³n con estado de carga
    -   OpciÃ³n para regresar y editar datos

#### 6. ğŸ‰ AcceptLoanResultScreen

-   **Ruta**: `/accept-loan/result`
-   **PropÃ³sito**: Mostrar resultado final del proceso
-   **Funcionalidad**:
    -   Mensaje de Ã©xito con detalles
    -   InformaciÃ³n sobre transferencia prÃ³xima
    -   BotÃ³n para continuar al dashboard
    -   Limpieza automÃ¡tica del estado

### ğŸ§© Componentes Reutilizables

#### **BankSelectionCard**

Componente visual para selecciÃ³n de bancos:

```dart
class BankSelectionCard extends StatelessWidget {
  final BankEntity bank;
  final bool isSelected;
  final VoidCallback onTap;

  // Muestra logo, nombre y estado de selecciÃ³n
}
```

#### **AccountTypeSelector**

Selector para tipo de cuenta bancaria:

```dart
class AccountTypeSelector extends ConsumerWidget {
  final String currentValue;
  final Function(String) onChanged;

  // Opciones: "ahorro" | "corriente"
}
```

---

## APIs Utilizadas

### ğŸ“¡ Endpoints de API

#### **GET** `/client/accept-loan-step-1`

**PropÃ³sito**: Obtener datos del prÃ©stamo aprobado y bancos disponibles

**Headers Requeridos**:

```
Authorization: Bearer {token}
Content-Type: application/json
```

**Response Exitoso (200)**:

```json
{
    "loanId": 123,
    "oldBankId": 1, // null si es primera vez
    "oldAccountNumber": "1234567890",
    "oldAccountType": "ahorro",
    "contract": "https://contrato.pisto.co/...",
    "banks": [
        {
            "id": 1,
            "name": "Banco AgrÃ­cola",
            "logo": "https://logo.pisto.co/agricola.png",
            "min_digits_saving": 10,
            "max_digits_saving": 14,
            "min_digits_checking": 10,
            "max_digits_checking": 14
        }
    ]
}
```

**Error 401**:

```json
{
    "message": "No autenticado"
}
```

#### **POST** `/client/accept-loan-step-2`

**PropÃ³sito**: Confirmar aceptaciÃ³n del prÃ©stamo con datos bancarios

**Request Body**:

```json
{
    "bankId": 1,
    "accountNumber": "1234567890",
    "accountType": "ahorro"
}
```

**Response Exitoso (200)**:

```json
{
    "message": "PrÃ©stamo aceptado exitosamente. El dinero serÃ¡ transferido pronto."
}
```

**Error 422 (Validation Error)**:

```json
{
    "message": "Datos bancarios invÃ¡lidos",
    "errors": {
        "accountNumber": [
            "El nÃºmero de cuenta debe tener entre 10 y 14 dÃ­gitos"
        ]
    }
}
```

### ğŸŒ IntegraciÃ³n con HTTP Client

```dart
// ConfiguraciÃ³n del interceptor
class AcceptLoanInterceptor extends Interceptor {
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    // Agregar headers de autenticaciÃ³n
    options.headers['Authorization'] = 'Bearer ${token}';
    super.onRequest(options, handler);
  }

  @override
  void onError(DioException error, ErrorInterceptorHandler handler) {
    // Manejar errores especÃ­ficos de aceptaciÃ³n
    if (error.response?.statusCode == 422) {
      // Error de validaciÃ³n
      throw AcceptLoanValidationException(error.response?.data);
    }
    super.onError(error, handler);
  }
}
```

---

## Manejo de Errores

### âš ï¸ Tipos de Errores

#### **1. Errores de Red**

```dart
// Timeout o conexiÃ³n perdida
NetworkException {
  message: "No se pudo conectar con el servidor. Verifica tu conexiÃ³n a internet.",
  canRetry: true,
  retryCallback: () => ref.refresh(acceptLoanDataProvider),
}
```

#### **2. Errores de AutenticaciÃ³n**

```dart
// Token expirado o invÃ¡lido
AuthException {
  message: "Tu sesiÃ³n ha expirado. Por favor inicia sesiÃ³n nuevamente.",
  action: "redirect_to_login",
}
```

#### **3. Errores de ValidaciÃ³n**

```dart
// Datos bancarios invÃ¡lidos
ValidationException {
  message: "El nÃºmero de cuenta no es vÃ¡lido para este banco",
  field: "accountNumber",
  expectedFormat: "10-14 dÃ­gitos para cuenta de ahorro",
}
```

#### **4. Errores de Negocio**

```dart
// PrÃ©stamo no encontrado o ya procesado
BusinessException {
  message: "Este prÃ©stamo ya ha sido procesado",
  code: "LOAN_ALREADY_PROCESSED",
  action: "redirect_to_dashboard",
}
```

### ğŸ”„ Estrategias de RecuperaciÃ³n

#### **Reintentos AutomÃ¡ticos**

```dart
@riverpod
class AcceptLoanRetryNotifier extends _$AcceptLoanRetryNotifier {
  int _retryCount = 0;
  static const int maxRetries = 3;

  Future<void> retryLastOperation() async {
    if (_retryCount < maxRetries) {
      _retryCount++;
      // Implementar backoff exponencial
      await Future.delayed(Duration(seconds: _retryCount * 2));
      // Reintentar operaciÃ³n
    }
  }
}
```

#### **Fallback para Usuario**

-   **OpciÃ³n de reintentar manual**
-   **Guardar borrador local** (no sensible)
-   **Contactar soporte** con cÃ³digo de error
-   **RedirecciÃ³n segura** al dashboard

---

## Validaciones

### âœ… Validaciones Implementadas

1. **ValidaciÃ³n DinÃ¡mica de Cuentas**

    - Cada banco tiene sus propias reglas de dÃ­gitos
    - ValidaciÃ³n en tiempo real mientras el usuario escribe
    - DiferenciaciÃ³n entre cuenta de ahorro y corriente

2. **Seguridad en Datos**

    - No se almacenan datos bancarios localmente
    - Token de autenticaciÃ³n requerido en todas las peticiones
    - Enmascarado de nÃºmero de cuenta en pantallas de confirmaciÃ³n

3. **Manejo de Errores**
    - ValidaciÃ³n tanto en cliente como servidor
    - Mensajes de error especÃ­ficos y amigables
    - OpciÃ³n de reintentar en caso de fallos de red

### ğŸ” LÃ³gica de ValidaciÃ³n

#### **ValidaciÃ³n de NÃºmero de Cuenta**

```dart
bool validateAccountNumber(String number, String type, BankEntity bank) {
  final digitCount = number.replaceAll(RegExp(r'\D'), '').length;

  if (type == 'ahorro') {
    return digitCount >= bank.minDigitsSaving &&
           digitCount <= bank.maxDigitsSaving;
  } else if (type == 'corriente') {
    return digitCount >= bank.minDigitsChecking &&
           digitCount <= bank.maxDigitsChecking;
  }

  return false;
}
```

#### **ValidaciÃ³n de Formulario Completo**

```dart
bool isFormValid(AcceptLoanState state) {
  return state.accountNumber.isNotEmpty &&
         state.accountType != null &&
         state.selectedBank != null &&
         state.isAccountNumberValid;
}
```

### ğŸ›¡ï¸ Consideraciones de Privacidad

-   Los datos bancarios solo se utilizan para el procesamiento del prÃ©stamo actual
-   No se persiste informaciÃ³n sensible en el dispositivo
-   Todas las comunicaciones se realizan travÃ©s de HTTPS
-   El usuario tiene control total sobre la informaciÃ³n que proporciona

---

## Testing

### ğŸ§ª Estrategia de Testing

#### **1. Unit Tests**

```dart
// test/unit/accept_loan_test.dart
void main() {
  group('AcceptLoanNotifier', () {
    test('debe seleccionar banco correctamente', () {
      // Test de selecciÃ³n de banco
    });

    test('debe validar nÃºmero de cuenta segÃºn banco', () {
      // Test de validaciÃ³n dinÃ¡mica
    });

    test('debe decidir flujo basado en oldBankId', () {
      // Test de lÃ³gica de decisiÃ³n
    });
  });
}
```

#### **2. Widget Tests**

```dart
// test/widget/accept_loan_splash_test.dart
void main() {
  testWidgets('debe mostrar loading mientras carga datos', (tester) async {
    // Test de estado de carga
  });

  testWidgets('debe navegar correctamente segÃºn datos previos', (tester) async {
    // Test de navegaciÃ³n condicional
  });
}
```

#### **3. Integration Tests**

```dart
// test/integration/accept_loan_flow_test.dart
void main() {
  integrationTest('flujo completo con datos previos', () async {
    // Simular OneShot â†’ AcceptLoan â†’ MyLoan
  });

  integrationTest('flujo completo primer prÃ©stamo', () async {
    // Simular flujo completo sin datos previos
  });
}
```

### ğŸ“‹ Casos de Prueba CrÃ­ticos

#### **Flujos de Usuario**

-   âœ… Usuario con datos previos que los reutiliza
-   âœ… Usuario con datos previos que registra nueva cuenta
-   âœ… Usuario primerizo que completa registro completo
-   âœ… Manejo de errores de red durante carga de datos
-   âœ… ValidaciÃ³n de nÃºmero de cuenta con diferentes bancos
-   âœ… NavegaciÃ³n hacia atrÃ¡s en pantallas crÃ­ticas

#### **Casos LÃ­mite**

-   ğŸ”„ CancelaciÃ³n del proceso en cualquier paso
-   ğŸ”„ PÃ©rdida de conexiÃ³n durante envÃ­o
-   ğŸ”„ Token expirado durante el flujo
-   ğŸ”„ Banco no disponible en lista
-   ğŸ”„ NÃºmero de cuenta con caracteres invÃ¡lidos

### ğŸ“Š MÃ©tricas de Testing

-   **Cobertura mÃ­nima**: 80% para cÃ³digo crÃ­tico
-   **Tests de flujos**: 100% de los caminos principales
-   **Tests de validaciÃ³n**: Todas las reglas de banco
-   **Tests de error**: Todos los tipos de error cubiertos

---

## Seguridad

### ğŸ”’ CaracterÃ­sticas de Seguridad

#### **1. ProtecciÃ³n de Datos**

-   âœ… **No persistencia local**: Datos bancarios solo en memoria
-   âœ… **Enmascarado visual**: `****1234` en pantallas de confirmaciÃ³n
-   âœ… **HTTPS obligatorio**: Todas las comunicaciones cifradas
-   âœ… **Token-based auth**: AutenticaciÃ³n en cada peticiÃ³n

#### **2. Validaciones de Seguridad**

```dart
// SanitizaciÃ³n de inputs
String sanitizeAccountNumber(String input) {
  return input.replaceAll(RegExp(r'[^0-9]'), '');
}

// ValidaciÃ³n de estructura
bool isValidAccountStructure(String number, BankEntity bank) {
  // Validar longitud y formato segÃºn banco
}
```

#### **3. Manejo de SesiÃ³n**

-   â° **Timeout de sesiÃ³n**: Auto-logout por inactividad
-   ğŸ”„ **Refresh token**: RenovaciÃ³n automÃ¡tica de tokens
-   ğŸšª **Logout forzado**: En detecciÃ³n de actividad sospechosa

### ğŸ›¡ï¸ Consideraciones de Privacidad

#### **Datos Sensibles**

-   âŒ **No almacenar**: NÃºmeros de cuenta completos
-   âŒ **No cachear**: InformaciÃ³n bancaria en dispositivo
-   âœ… **Solo memoria**: Datos eliminados al finalizar flujo
-   âœ… **EncriptaciÃ³n**: Para cualquier dato temporal

#### **Cumplimiento Normativo**

-   ğŸ“‹ **GDPR-like**: Derecho al olvido de datos
-   ğŸ” **Audit trail**: Registro de todas las operaciones
-   ğŸ“Š **Data minimization**: Solo datos necesarios
-   ğŸ¦ **Banking compliance**: EstÃ¡ndares financieros

### ğŸ” Best Practices Implementadas

```dart
// Ejemplo de implementaciÃ³n segura
class SecureAcceptLoanService {
  Future<void> submitSecurely(AcceptLoanRequest request) async {
    try {
      // 1. Validar en cliente primero
      _validateRequest(request);

      // 2. Enviar con token seguro
      final response = await _secureHttpClient.post(
        '/client/accept-loan-step-2',
        data: request.toJson(),
        options: Options(
          headers: {'Authorization': 'Bearer $_secureToken'},
          timeout: const Duration(seconds: 30),
        ),
      );

      // 3. Limpiar datos sensibles
      _cleanupSensitiveData();

    } catch (e) {
      // 4. Manejo seguro de errores
      _handleSecureError(e);
    }
  }
}
```

---

## ğŸš€ ImplementaciÃ³n y Mantenimiento

### ğŸ“¦ Dependencias Clave

```yaml
dependencies:
    flutter_riverpod: ^2.4.0 # GestiÃ³n de estado
    go_router: ^12.0.0 # NavegaciÃ³n
    freezed_annotation: ^2.4.0 # Modelos inmutables
    json_annotation: ^4.8.0 # SerializaciÃ³n JSON
    dio: ^5.3.0 # Cliente HTTP

dev_dependencies:
    riverpod_generator: ^2.3.0 # Code generation
    freezed: ^2.4.0 # GeneraciÃ³n de modelos
    json_serializable: ^6.7.0 # GeneraciÃ³n JSON
    build_runner: ^2.4.0 # Herramienta de generaciÃ³n
```

### ğŸ”§ Comandos de Desarrollo

```bash
# Generar cÃ³digo (requerido despuÃ©s de cambios)
dart run build_runner build --delete-conflicting-outputs

# Modo watch durante desarrollo
dart run build_runner watch -d

# Ejecutar pruebas
flutter test test/features/accept_loan/

# AnÃ¡lisis estÃ¡tico
flutter analyze lib/features/accept_loan/
```

### ğŸ“ Mejores PrÃ¡cticas

1. **Code Generation**: Siempre ejecutar `build_runner` despuÃ©s de modificar modelos o providers
2. **State Management**: Usar `keepAlive: true` para persistencia durante navegaciÃ³n
3. **Error Handling**: Implementar manejo especÃ­fico para cada tipo de error
4. **Testing**: Mantener cobertura >80% para cÃ³digo crÃ­tico
5. **Documentation**: Actualizar este documento con cada cambio significativo

---

## ğŸ”— Integraciones

### ğŸ“„ MÃ³dulos Relacionados

-   **OneShot**: MÃ³dulo previo de firma digital
-   **MyLoan**: Destino final despuÃ©s de aceptaciÃ³n
-   **Auth**: GestiÃ³n de tokens y autenticaciÃ³n
-   **Network**: ConfiguraciÃ³n HTTP y manejo de errores

### ğŸ”„ Flujo de Datos

```
OneShot (Firma completada)
  â†“
AcceptLoan (ConfirmaciÃ³n bancaria)
  â†“
MyLoan (Dashboard del prÃ©stamo)
```
