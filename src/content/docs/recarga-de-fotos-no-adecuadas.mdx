---
title: Flujo de recarga de fotos no adecuadas
slug: recarga-de-fotos-no-adecuadas
tags: [auth, flutter, riverpod, dio, formz, go_router, freezed, json_annotation]
description: Flujo de recarga de fotos no adecuadas. GestiÃ³n completa del proceso de recaptura y subida de documentos de identificaciÃ³n.
---

## DescripciÃ³n General

La funcionalidad de **Recarga de Fotos No Adecuadas** (`reload_photos`) es un mÃ³dulo especializado que permite a los usuarios volver a capturar y subir sus documentos de identificaciÃ³n cuando las imÃ¡genes originales no cumplen con los estÃ¡ndares de calidad requeridos. Este flujo se activa cuando el sistema detecta que las fotos del DUI (frente, reverso) o selfie no son adecuadas para el proceso de verificaciÃ³n de identidad.

### ğŸ“Š Estructura del Flujo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DetecciÃ³n de    â”‚â”€â”€â”€â”€â–¶â”‚ Pantalla de      â”‚â”€â”€â”€â”€â–¶â”‚ Captura con     â”‚â”€â”€â”€â”€â–¶â”‚ Subida a         â”‚â”€â”€â”€â”€â–¶â”‚ ConfirmaciÃ³n    â”‚
â”‚ Fotos Inadecuadasâ”‚     â”‚ Recarga de Fotos â”‚     â”‚ CÃ¡mara           â”‚     â”‚ Servidor         â”‚     â”‚ de Ã‰xito        â”‚
â”‚ (Sistema)       â”‚     â”‚ (Instrucciones)  â”‚     â”‚ (3 imÃ¡genes)     â”‚     â”‚ (ValidaciÃ³n)     â”‚     â”‚ (Resultado)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ AutomÃ¡tica           âœ“ Manual            âœ“ Manual             âœ“ AutomÃ¡tica         âœ“ AutomÃ¡tica
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **DetecciÃ³n automÃ¡tica**: IdentificaciÃ³n de imÃ¡genes que no cumplen estÃ¡ndares
-   âœ… **Flujo guiado**: Instrucciones claras para recapturar documentos
-   âœ… **Captura con cÃ¡mara**: IntegraciÃ³n nativa con cÃ¡mara del dispositivo
-   âœ… **ValidaciÃ³n en tiempo real**: Feedback inmediato sobre calidad de imagen
-   âœ… **Subida progresiva**: Cada imagen se sube individualmente
-   âœ… **Manejo robusto de errores**: RecuperaciÃ³n ante fallos de cÃ¡mara o red
-   âœ… **Estado persistente**: Mantiene progreso durante navegaciÃ³n
-   âœ… **Logging completo**: AuditorÃ­a de todas las operaciones

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

La recarga de fotos es necesaria cuando:

-   **Tus fotos no son claras**: Las imÃ¡genes originales estÃ¡n borrosas o oscuras
-   **Documentos incompletos**: Falta informaciÃ³n visible en el DUI
-   **Calidad insuficiente**: Las imÃ¡genes no cumplen los requisitos de verificaciÃ³n
-   **Selfie inadecuada**: La foto de tu rostro no es clara o reciente

### ğŸ“± Pasos para recargar tus fotos

#### Paso 1: NotificaciÃ³n del problema

El sistema te notificarÃ¡ cuando detecte un problema:

-   ğŸ“© **Mensaje claro**: "Tus fotos no cumplen los requisitos de calidad"
-   ğŸ“‹ **Instrucciones especÃ­ficas**: ExplicaciÃ³n de quÃ© necesita ser corregido
-   ğŸ” **Ejemplos visuales**: Referencias de fotos adecuadas vs inadecuadas

#### Paso 2: PreparaciÃ³n para la recarga

Antes de comenzar:

1. âœ… **Busca un lugar bien iluminado**
2. âœ… **Limpia la cÃ¡mara de tu telÃ©fono**
3. âœ… **Prepara tu DUI** (frente y reverso)
4. âœ… **AsegÃºrate de estar en un lugar tranquilo**

#### Paso 3: Captura del frente del DUI

-   ğŸ“¸ **Enfoca bien**: AsegÃºrate que el texto sea legible
-   ğŸ’¡ **Buena iluminaciÃ³n**: Sin sombras sobre el documento
-   ğŸ“ **Centra el DUI**: Todo el documento debe ser visible
-   âœ… **Sin reflejos**: Evita brillos que oculten informaciÃ³n
-   ğŸ”„ **Reintenta si es necesario**: Puedes tomar la foto varias veces

#### Paso 4: Captura del reverso del DUI

-   ğŸ“¸ **Voltea el documento**: Captura la parte trasera
-   ğŸ” **Verifica legibilidad**: El cÃ³digo de barras debe ser visible
-   ğŸ’¡ **Misma iluminaciÃ³n**: Consistente con la foto del frente
-   ğŸ“ **Marco completo**: No cortes ningÃºn borde
-   âœ… **Revisa la calidad**: Confirma que se lee claramente

#### Paso 5: Captura de selfie

-   ğŸ“¸ **Mira directamente a la cÃ¡mara**: Sin girar la cabeza
-   ğŸ’¡ **IluminaciÃ³n frontal**: Luz en tu rostro, no detrÃ¡s
-   ğŸ˜ **ExpresiÃ³n neutral**: Sin sonrisas exageradas ni gestos
-   ğŸ¯ **Fondo simple**: Sin elementos que distraigan
-   ğŸ‘” **Apariencia apropiada**: Sin accesorios que cubran tu rostro

#### Paso 6: Proceso de envÃ­o

Una vez capturadas las tres fotos:

-   â³ **Subida automÃ¡tica**: Las imÃ¡genes se envÃ­an al servidor
-   ğŸ”„ **ValidaciÃ³n**: El sistema verifica la calidad
-   ğŸ“Š **Progreso visible**: VerÃ¡s el estado de cada imagen
-   âœ… **ConfirmaciÃ³n**: RecibirÃ¡s mensaje de Ã©xito

#### Paso 7: Resultado final

**Si es exitoso:**

-   ğŸ‰ **Fotos actualizadas**: Tus documentos han sido recargados
-   ğŸ“§ **NotificaciÃ³n**: RecibirÃ¡s confirmaciÃ³n del cambio
-   ğŸ  **ContinÃºa el proceso**: PodrÃ¡s seguir con tu solicitud
-   ğŸ“± **PrÃ³ximos pasos**: El sistema te indicarÃ¡ quÃ© hacer despuÃ©s

**Si hay errores:**

-   âŒ **Mensaje especÃ­fico**: SabrÃ¡s exactamente quÃ© corregir
-   ğŸ”„ **OpciÃ³n de reintentar**: PodrÃ¡s recapturar las fotos necesarias
-   ğŸ“ **Soporte disponible**: PodrÃ¡s contactar ayuda si persisten los problemas

### âš ï¸ Consejos Importantes

-   **Paciencia**: TÃ³mate el tiempo necesario para capturar buenas fotos
-   **Calidad sobre velocidad**: Es mejor hacerlo bien que rÃ¡pido
-   **Revisa antes de enviar**: Confirma que todas las imÃ¡genes sean claras
-   **Estable conexiÃ³n**: AsegÃºrate de tener buena seÃ±al de internet
-   **Sigue las instrucciones**: Las guÃ­as visuales son muy Ãºtiles

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ Estructura del MÃ³dulo

El mÃ³dulo sigue la arquitectura establecida en el proyecto Pisto con separaciÃ³n de responsabilidades clara:

```
reload_photos/
â”œâ”€â”€ models/                      # DTOs y entidades de datos
â”‚   â”œâ”€â”€ reload_images_request.dart    # Payload para recarga
â”‚   â””â”€â”€ reload_images_response.dart   # Respuesta del servidor
â”œâ”€â”€ providers/                   # GestiÃ³n de estado con Riverpod
â”‚   â””â”€â”€ reload_photos_provider.dart   # Estado principal del flujo
â”œâ”€â”€ repositories/               # Capa de acceso a datos
â”‚   â””â”€â”€ reload_images_repository.dart # ComunicaciÃ³n con la API
â”œâ”€â”€ screens/                    # Interfaces de usuario
â”‚   â”œâ”€â”€ reload_photos_screen.dart     # Pantalla principal
â”‚   â””â”€â”€ reload_photos_success_screen.dart # Pantalla de Ã©xito
â””â”€â”€ widgets/                    # Componentes reutilizables
```

### ğŸ“Š Models (Entidades de Datos)

#### **ReloadImagesRequest**

Payload para enviar las imÃ¡genes recargadas:

```dart
@freezed
class ReloadImagesRequest with _$ReloadImagesRequest {
  const factory ReloadImagesRequest({
    required String imageFrontIdCard,    // URL del frente del DUI
    required String imageBackIdCard,     // URL del reverso del DUI
    required String imageSelfie,         // URL de la selfie
  }) = _ReloadImagesRequest;
}
```

#### **ReloadImagesResponse**

Respuesta del servidor despuÃ©s de procesar las imÃ¡genes:

```dart
@freezed
class ReloadImagesResponse with _$ReloadImagesResponse {
  const factory ReloadImagesResponse({
    required String message,             // Mensaje de confirmaciÃ³n
  }) = _ReloadImagesResponse;
}
```

### ğŸ¯ Providers (GestiÃ³n de Estado)

#### **ReloadPhotosNotifier**

StateNotifier principal con manejo de imÃ¡genes individuales:

```dart
@freezed
class ReloadPhotosState with _$ReloadPhotosState {
  const factory ReloadPhotosState({
    @Default(false) bool isLoading,           // Estado general de carga
    @Default('') String errorMessage,         // Error general
    @Default(ImageUploadState()) ImageUploadState frontIdCard,  // Estado frente DUI
    @Default(ImageUploadState()) ImageUploadState backIdCard,   // Estado reverso DUI
    @Default(ImageUploadState()) ImageUploadState selfie,       // Estado selfie
    @Default(false) bool isValid,             // Si todas las imÃ¡genes estÃ¡n listas
    @Default(false) bool isSubmitting,        // Enviando al servidor
    @Default(false) bool isSubmitted,         // Proceso completado
    String? successMessage,                   // Mensaje de Ã©xito
  }) = _ReloadPhotosState;
}

@Riverpod(keepAlive: true)
class ReloadPhotosNotifier extends _$ReloadPhotosNotifier {
  // MÃ©todos principales:
  // - Future<void> captureAndUploadImage(ImageType imageType)
  // - Future<void> submitReloadImages()
  // - void clearImageError(ImageType imageType)
  // - void resetState()
  // - Map<String, String> getUploadedImageUrls()
}
```

#### **ImageUploadState**

Estado individual para cada imagen:

```dart
@freezed
class ImageUploadState with _$ImageUploadState {
  const factory ImageUploadState({
    @Default(false) bool isUploading,        // Subiendo imagen
    @Default('') String errorMessage,         // Error especÃ­fico
    String? imageUrl,                        // URL de la imagen subida
    String? localImagePath,                  // Path local temporal
  }) = _ImageUploadState;
}
```

### ğŸŒ Repository (Acceso a Datos)

#### **ReloadImagesRepository**

Clase responsable de la comunicaciÃ³n con la API:

```dart
class ReloadImagesRepository {
  // POST /client/reload-images
  Future<ReloadImagesResponse> reloadImages(ReloadImagesRequest request);
}

// Manejo especÃ­fico de errores
enum ReloadImagesExceptionType {
  network,      // Problemas de conectividad
  validation,   // Datos invÃ¡lidos
  unauthorized, // No autenticado
  forbidden,    // Permiso denegado
  unknown,      // Error desconocido
}
```

---

## Flujo Completo de Datos

### ğŸ”„ Flujo de NavegaciÃ³n

```
DetecciÃ³n de problema (Sistema)
  â†“
/reload-photos (Pantalla principal)
  â”œâ”€â†’ [Capturar frente DUI] â†’ Subida individual â†’ ValidaciÃ³n local
  â”œâ”€â†’ [Capturar reverso DUI] â†’ Subida individual â†’ ValidaciÃ³n local
  â”œâ”€â†’ [Capturar selfie] â†’ Subida individual â†’ ValidaciÃ³n local
  â””â”€â†’ [Enviar todas] â†’ POST /client/reload-images â†’ /reload-photos/success
```

### ğŸ“Š Diagrama de Estado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ReloadPhotosNotifier                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: initial â†’ loading â†’ uploading â†’ submitting â†’ completed â”‚
â”‚                                                              â†‘ error â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ImÃ¡genes:                                                     â”‚
â”‚  - frontIdCard: ImageUploadState (uploading, url, error)       â”‚
â”‚  - backIdCard: ImageUploadState (uploading, url, error)        â”‚
â”‚  - selfie: ImageUploadState (uploading, url, error)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ValidaciÃ³n:                                                   â”‚
â”‚  - isValid: true solo si todas las imÃ¡genes tienen URL         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ Ciclo de Vida

1. **DetecciÃ³n â†’ NavegaciÃ³n**: Sistema detecta problema y redirige
2. **Captura â†’ Subida**: Cada imagen se captura y sube individualmente
3. **ValidaciÃ³n â†’ Estado**: Se actualiza estado segÃºn resultado de cada subida
4. **EnvÃ­o Final â†’ ConfirmaciÃ³n**: Se envÃ­an todas las URLs juntas
5. **Ã‰xito â†’ Dashboard**: NavegaciÃ³n a pantalla de Ã©xito y retorno

---

## Componentes y Pasos

### ğŸ“± Pantallas del Flujo

#### 1. ğŸ“¸ ReloadPhotosScreen

-   **Ruta**: `/reload-photos`
-   **PropÃ³sito**: Interfaz principal para recapturar documentos
-   **Funcionalidad**:
    -   Instrucciones claras sobre el proceso
    -   Tres cards para capturar cada imagen
    -   Estado visual de cada imagen (pendiente/subida/error)
    -   BotÃ³n de envÃ­o habilitado solo cuando todas estÃ¡n listas
    -   Manejo de permisos de cÃ¡mara

#### 2. ğŸ‰ ReloadPhotosSuccessScreen

-   **Ruta**: `/reload-photos/success`
-   **PropÃ³sito**: ConfirmaciÃ³n de proceso completado
-   **Funcionalidad**:
    -   Mensaje de Ã©xito con detalles
    -   InformaciÃ³n sobre prÃ³ximos pasos
    -   BotÃ³n para continuar al flujo principal
    -   Limpieza automÃ¡tica del estado

### ğŸ§© Componentes Reutilizables

#### **ImageUploadCard**

Componente visual para cada tipo de imagen:

```dart
class ImageUploadCard extends StatelessWidget {
  final ImageType imageType;
  final ImageUploadState imageState;
  final VoidCallback onCapture;
  final VoidCallback onClearError;

  // Muestra: estado actual, preview, botÃ³n de captura, mensajes de error
}
```

#### **CameraPermissionHandler**

Manejador de permisos de cÃ¡mara:

```dart
class CameraPermissionHandler {
  static Future<bool> requestCameraPermission();
  static void showPermissionDeniedDialog();
  static void openAppSettings();
}
```

---

## APIs Utilizadas

### ğŸ“¡ Endpoints de API

#### **POST** `/client/reload-images`

**PropÃ³sito**: Enviar las URLs de las imÃ¡genes recargadas para procesamiento

**Headers Requeridos**:

```
Authorization: Bearer {token}
Content-Type: application/json
```

**Request Body**:

```json
{
    "imageFrontIdCard": "https://cdn.pisto.co/images/front_dui_123.jpg",
    "imageBackIdCard": "https://cdn.pisto.co/images/back_dui_123.jpg",
    "imageSelfie": "https://cdn.pisto.co/images/selfie_123.jpg"
}
```

**Response Exitoso (200)**:

```json
{
    "message": "ImÃ¡genes recargadas exitosamente. Tu verificaciÃ³n continuarÃ¡ en breve."
}
```

**Error 422 (Validation Error)**:

```json
{
    "message": "Una o mÃ¡s imÃ¡genes no cumplen los requisitos",
    "errors": {
        "imageSelfie": ["La selfie no es clara o el rostro no es visible"]
    }
}
```

**Error 401 (Unauthorized)**:

```json
{
    "message": "No autenticado. Por favor inicia sesiÃ³n nuevamente."
}
```

### ğŸŒ IntegraciÃ³n con Image Upload

El flujo utiliza el endpoint de subida de imÃ¡genes existente:

```dart
// POST /client/upload-image
{
  "image": "base64_encoded_image",
  "imageType": "frontIdCard" | "backIdCard" | "selfie"
}

// Response
{
  "imageUrl": "https://cdn.pisto.co/images/..."
}
```

---

## Manejo de Errores

### âš ï¸ Tipos de Errores

#### **1. Errores de CÃ¡mara**

```dart
// Permiso denegado
CameraPermissionException {
  message: "Se requiere acceso a la cÃ¡mara para continuar",
  action: "request_permission",
}

// CÃ¡mara no disponible
CameraUnavailableException {
  message: "No se pudo acceder a la cÃ¡mara del dispositivo",
  canRetry: true,
}
```

#### **2. Errores de Subida**

```dart
// Error de red durante subida
ImageUploadException {
  message: "Error al subir la imagen. Verifica tu conexiÃ³n.",
  imageType: "frontIdCard",
  canRetry: true,
}

// Formato no soportado
ImageFormatException {
  message: "Formato de imagen no soportado. Usa JPG o PNG.",
  imageType: "selfie",
}
```

#### **3. Errores de ValidaciÃ³n**

```dart
// Imagen de baja calidad
ImageQualityException {
  message: "La imagen es muy borrosa. Intenta capturarla nuevamente.",
  suggestions: ["Usa mejor iluminaciÃ³n", "MantÃ©n el dispositivo firme"],
}

// Documento incompleto
DocumentIncompleteException {
  message: "El DUI no estÃ¡ completo en la imagen.",
  field: "frontIdCard",
}
```

#### **4. Errores de Red**

```dart
// ConexiÃ³n perdida
NetworkException {
  message: "ConexiÃ³n a internet perdida. Reintentando...",
  autoRetry: true,
  maxRetries: 3,
}

// Timeout
TimeoutException {
  message: "La operaciÃ³n estÃ¡ tomando demasiado tiempo.",
  canRetry: true,
}
```

### ğŸ”„ Estrategias de RecuperaciÃ³n

#### **Reintentos AutomÃ¡ticos**

```dart
@riverpod
class ImageUploadRetryNotifier extends _$ImageUploadRetryNotifier {
  int _retryCount = 0;
  static const int maxRetries = 3;

  Future<void> retryUpload(ImageType imageType, String localPath) async {
    if (_retryCount < maxRetries) {
      _retryCount++;
      await Future.delayed(Duration(seconds: _retryCount * 2));
      // Reintentar subida con backoff exponencial
    }
  }
}
```

#### **Fallback para Usuario**

-   **OpciÃ³n de reintentar manual** cada imagen
-   **Guardar imÃ¡genes localmente** como backup
-   **Contactar soporte** con diagnÃ³stico automÃ¡tico
-   **Modo offline** permitiendo capturar y subir despuÃ©s

---

## Validaciones

### âœ… Validaciones Implementadas

1. **ValidaciÃ³n de Calidad de Imagen**

    - DetecciÃ³n de borrosidad usando algoritmos de enfoque
    - VerificaciÃ³n de iluminaciÃ³n adecuada
    - DetecciÃ³n de reflejos y sombras
    - AnÃ¡lisis de contraste y claridad

2. **ValidaciÃ³n de Contenido**

    - VerificaciÃ³n de que el DUI estÃ© completo
    - DetecciÃ³n de texto legible en el documento
    - ConfirmaciÃ³n de presencia de rostro en selfie
    - ValidaciÃ³n de formato y orientaciÃ³n

3. **Validaciones TÃ©cnicas**
    - TamaÃ±o y formato de archivo
    - ResoluciÃ³n mÃ­nima requerida
    - Ratio de aspecto apropiado
    - Integridad del archivo de imagen

### ğŸ” LÃ³gica de ValidaciÃ³n

#### **ValidaciÃ³n Individual de ImÃ¡genes**

```dart
class ImageValidator {
  static ValidationResult validateImage(File imageFile, ImageType type) {
    switch (type) {
      case ImageType.frontIdCard:
        return _validateIdCardFront(imageFile);
      case ImageType.backIdCard:
        return _validateIdCardBack(imageFile);
      case ImageType.selfie:
        return _validateSelfie(imageFile);
    }
  }

  static ValidationResult _validateIdCardFront(File image) {
    // Verificar bordes completos, texto legible, sin reflejos
    return ValidationResult(
      isValid: true,
      quality: 0.85,
      issues: [],
    );
  }
}
```

#### **ValidaciÃ³n de Formulario Completo**

```dart
bool isFormValid(ReloadPhotosState state) {
  return state.frontIdCard.imageUrl != null &&
         state.backIdCard.imageUrl != null &&
         state.selfie.imageUrl != null &&
         state.frontIdCard.imageUrl!.isNotEmpty &&
         state.backIdCard.imageUrl!.isNotEmpty &&
         state.selfie.imageUrl!.isNotEmpty;
}
```

### ğŸ›¡ï¸ Consideraciones de Privacidad

-   Las imÃ¡genes locales se eliminan despuÃ©s de subirlas
-   No se almacenan copias de seguridad de documentos sensibles
-   Todas las comunicaciones se realizan travÃ©s de HTTPS
-   Las URLs de imÃ¡genes tienen tiempo de expiraciÃ³n limitado

---

## Testing

### ğŸ§ª Estrategia de Testing

#### **1. Unit Tests**

```dart
// test/unit/reload_photos_test.dart
void main() {
  group('ReloadPhotosNotifier', () {
    test('debe manejar captura y subida de imagen correctamente', () {
      // Test de flujo completo de una imagen
    });

    test('debe validar formulario cuando todas las imÃ¡genes estÃ¡n listas', () {
      // Test de validaciÃ³n de estado completo
    });

    test('debe manejar errores de cÃ¡mara apropiadamente', () {
      // Test de manejo de excepciones de cÃ¡mara
    });
  });
}
```

#### **2. Widget Tests**

```dart
// test/widget/reload_photos_screen_test.dart
void main() {
  testWidgets('debe mostrar estados de carga correctamente', (tester) async {
    // Test de estados visuales durante subida
  });

  testWidgets('debe habilitar botÃ³n de envÃ­o solo cuando es vÃ¡lido', (tester) async {
    // Test de lÃ³gica de habilitaciÃ³n de botones
  });

  testWidgets('debe mostrar mensajes de error especÃ­ficos', (tester) async {
    // Test de visualizaciÃ³n de errores
  });
}
```

#### **3. Integration Tests**

```dart
// test/integration/reload_photos_flow_test.dart
void main() {
  integrationTest('flujo completo de recarga de imÃ¡genes', () async {
    // Simular detecciÃ³n â†’ captura â†’ subida â†’ confirmaciÃ³n
  });

  integrationTest('manejo de interrupciones durante el flujo', () async {
    // Test de recuperaciÃ³n ante pÃ©rdida de conexiÃ³n
  });
}
```

### ğŸ“‹ Casos de Prueba CrÃ­ticos

#### **Flujos de Usuario**

-   âœ… Usuario completa recarga exitosamente en primer intento
-   âœ… Usuario reintenta captura de imÃ¡genes con errores
-   âœ… Usuario maneja pÃ©rdida de conexiÃ³n durante subida
-   âœ… Usuario deniega permisos de cÃ¡mara y luego los concede
-   âœ… Usuario navega hacia atrÃ¡s y pierde progreso

#### **Casos LÃ­mite**

-   ğŸ”„ CancelaciÃ³n del proceso en diferentes etapas
-   ğŸ”„ PÃ©rdida de conexiÃ³n durante subida de imagen individual
-   ğŸ”„ Token expirado durante el flujo
-   ğŸ”„ Espacio de almacenamiento insuficiente
-   ğŸ”„ CÃ¡mara en uso por otra aplicaciÃ³n

### ğŸ“Š MÃ©tricas de Testing

-   **Cobertura mÃ­nima**: 85% para cÃ³digo crÃ­tico
-   **Tests de flujos**: 100% de los caminos principales
-   **Tests de validaciÃ³n**: Todas las reglas de calidad de imagen
-   **Tests de error**: Todos los tipos de error cubiertos

---

## Seguridad

### ğŸ”’ CaracterÃ­sticas de Seguridad

#### **1. ProtecciÃ³n de Datos**

-   âœ… **EliminaciÃ³n local**: ImÃ¡genes temporales eliminadas despuÃ©s de subida
-   âœ… **EncriptaciÃ³n en trÃ¡nsito**: Todas las imÃ¡genes viajan por HTTPS
-   âœ… **URLs temporales**: Las imÃ¡genes tienen expiraciÃ³n limitada
-   âœ… **No cachÃ© sensible**: Sin almacenamiento local de documentos

#### **2. Validaciones de Seguridad**

```dart
// SanitizaciÃ³n de archivos de imagen
File sanitizeImageFile(File imageFile) {
  // Verificar tipo de archivo real
  // Eliminar metadatos EXIF
  // Validar tamaÃ±o mÃ¡ximo
  // Detectar patrones maliciosos
}

// ValidaciÃ³n de integridad
bool validateImageIntegrity(String imageUrl) {
  // Verificar que la URL sea del dominio esperado
  // Validar estructura de URL
  // Detectar manipulaciones
}
```

#### **3. Manejo de SesiÃ³n**

-   â° **Timeout de captura**: LÃ­mite de tiempo para tomar cada foto
-   ğŸ”„ **Refresh automÃ¡tico**: RenovaciÃ³n de tokens durante subidas largas
-   ğŸšª **Logout seguro**: Limpieza completa de datos sensibles

### ğŸ›¡ï¸ Consideraciones de Privacidad

#### **Datos Sensibles**

-   âŒ **No almacenar localmente**: ImÃ¡genes de DUI eliminadas del dispositivo
-   âŒ **No hacer cachÃ©**: Sin copias temporales persistentes
-   âœ… **Solo memoria volÃ¡til**: Datos en memoria durante el proceso
-   âœ… **EliminaciÃ³n garantizada**: Clean up explÃ­cito en todos los casos

#### **Cumplimiento Normativo**

-   ğŸ“‹ **ProtecciÃ³n de datos**: Cumplimiento con leyes de privacidad
-   ğŸ” **Audit trail**: Registro completo de operaciones con imÃ¡genes
-   ğŸ“Š **MinimizaciÃ³n**: Solo datos necesarios para verificaciÃ³n
-   ğŸ¦ **KYC compliance**: EstÃ¡ndares de conocimiento de cliente

### ğŸ” Best Practices Implementadas

```dart
// Ejemplo de implementaciÃ³n segura
class SecureImageUploadService {
  Future<void> uploadImageSecurely(File imageFile, ImageType type) async {
    try {
      // 1. Validar y sanitizar imagen
      final sanitizedFile = await _sanitizeImage(imageFile);

      // 2. Subir con token seguro
      final response = await _secureUploadRepository.upload(
        sanitizedFile,
        type,
        options: SecureUploadOptions(
          timeout: Duration(seconds: 30),
          encryption: true,
        ),
      );

      // 3. Eliminar archivo local inmediatamente
      await _deleteLocalFile(imageFile);

    } catch (e) {
      // 4. Limpieza segura en caso de error
      await _cleanupOnError(imageFile);
      throw SecureUploadException.fromError(e);
    }
  }
}
```

---

## ğŸš€ ImplementaciÃ³n y Mantenimiento

### ğŸ“¦ Dependencias Clave

```yaml
dependencies:
    flutter_riverpod: ^2.4.0 # GestiÃ³n de estado
    go_router: ^12.0.0 # NavegaciÃ³n
    freezed_annotation: ^2.4.0 # Modelos inmutables
    json_annotation: ^4.8.0 # SerializaciÃ³n JSON
    image_picker: ^1.0.0 # Acceso a cÃ¡mara
    dio: ^5.3.0 # Cliente HTTP
    dotted_border: ^2.0.0 # UI para zonas de captura

dev_dependencies:
    riverpod_generator: ^2.3.0 # Code generation
    freezed: ^2.4.0 # GeneraciÃ³n de modelos
    json_serializable: ^6.7.0 # GeneraciÃ³n JSON
    build_runner: ^2.4.0 # Herramienta de generaciÃ³n
```

### ğŸ”§ Comandos de Desarrollo

```bash
# Generar cÃ³digo (requerido despuÃ©s de cambios)
dart run build_runner build --delete-conflicting-outputs

# Modo watch durante desarrollo
dart run build_runner watch -d

# Ejecutar pruebas
flutter test test/features/reload_photos/

# AnÃ¡lisis estÃ¡tico
flutter analyze lib/features/reload_photos/
```

### ğŸ“ Mejores PrÃ¡cticas

1. **Code Generation**: Siempre ejecutar `build_runner` despuÃ©s de modificar modelos o providers
2. **State Management**: Usar `keepAlive: true` para persistencia durante navegaciÃ³n
3. **Error Handling**: Implementar manejo especÃ­fico para cada tipo de error
4. **Testing**: Mantener cobertura >85% para cÃ³digo crÃ­tico
5. **Memory Management**: Limpiar recursos de cÃ¡mara y archivos temporales
6. **Documentation**: Actualizar este documento con cada cambio significativo

---

## ğŸ”— Integraciones

### ğŸ“„ MÃ³dulos Relacionados

-   **FirstLoan**: Utiliza el mismo sistema de subida de imÃ¡genes
-   **ImageUpload**: Comparte repositorio y lÃ³gica de subida
-   **Auth**: GestiÃ³n de tokens y permisos
-   **Network**: ConfiguraciÃ³n HTTP y manejo de errores
-   **Logging**: Registro de operaciones y auditorÃ­a

### ğŸ”„ Flujo de Datos

```
DetecciÃ³n de problemas (External Flow)
  â†“
ReloadPhotos (Recaptura y validaciÃ³n)
  â†“
ImageUpload (Subida a CDN)
  â†“
ValidationAPI (Procesamiento y verificaciÃ³n)
  â†“
MainLoanFlow (ContinuaciÃ³n del proceso)
```
