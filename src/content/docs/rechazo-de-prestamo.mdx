---
title: Flujo de rechazo de prÃ©stamo en Pisto
slug: rechazo-de-prestamo
tags: [auth, my-loan, flutter, riverpod, dio]
description: Flujo de rechazo de prÃ©stamo en la aplicaciÃ³n Pisto.
---

## DescripciÃ³n General

El **flujo de rechazo de prÃ©stamo** permite a usuarios **rechazar deliberadamente** un prÃ©stamo que ha sido ofrecido o aprobado por el sistema. Este es un flujo poco comÃºn pero importante para casos donde:

-   El usuario cambiÃ³ de opiniÃ³n
-   Las condiciones no son favorables
-   El usuario necesita diferir el prÃ©stamo
-   El usuario prefiere no endeudarse en este momento

### ğŸ“Š Estructura de Pantallas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pantalla de PrÃ©stamo   â”‚
â”‚ Oferta Disponible      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    [Rechazar]
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LoanRejectionScreen             â”‚
â”‚ Â¿Por quÃ© rechazas este prÃ©stamo?â”‚
â”‚                                 â”‚
â”‚ â€¢ Motivo 1: "No lo necesito"    â”‚
â”‚ â€¢ Motivo 2: "Tasas altas"       â”‚
â”‚ â€¢ Motivo 3: "Por ahora no"      â”‚
â”‚ â€¢ Motivo 4: "Otro"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    [Confirmar rechazo]
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /client/refuse-loan       â”‚
â”‚ { reason: "..." }              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    âœ… Ã‰xito / âŒ Error
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LoanRejectionSuccessScreen     â”‚
â”‚ "PrÃ©stamo rechazado"           â”‚
â”‚                                â”‚
â”‚ [Volver al Dashboard]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **Razones dinÃ¡micas**: Cargadas desde servidor
-   âœ… **ConfirmaciÃ³n clara**: Usuario confirma su decisiÃ³n
-   âœ… **Feedback positivo**: Pantalla de Ã©xito
-   âœ… **AuditorÃ­a completa**: Se registra razÃ³n del rechazo
-   âœ… **Sin penalizaciones**: El usuario puede solicitar de nuevo

---

## Contexto y Escenarios

### ğŸ¯ Â¿CuÃ¡ndo aparece este flujo?

**Escenarios de uso:**

1. **En pantalla de prÃ©stamo aprobado**

    - Usuario ve monto ofrecido
    - Presiona botÃ³n "Rechazar"
    - Se abre modal de rechazo

2. **Desde notificaciÃ³n de aprobaciÃ³n**

    - Sistema notifica al usuario: "Tu prÃ©stamo fue aprobado"
    - Usuario abre notificaciÃ³n
    - OpciÃ³n para rechazar estÃ¡ disponible

3. **En historial de prÃ©stamos**
    - Usuario ve prÃ©stamo pendiente de aceptaciÃ³n
    - Presiona "..."
    - OpciÃ³n: "Rechazar este prÃ©stamo"

### ğŸ’¡ Razones de Rechazo (Ejemplos)

Las razones son **dinÃ¡micas** (cargadas del servidor):

```
Ejemplos de razones que el servidor puede proporcionar:

1. "No lo necesito en este momento"
2. "Las tasas de interÃ©s son demasiado altas"
3. "Prefiero diferir a un mejor momento"
4. "CambiÃ© de opiniÃ³n"
5. "EncontrÃ© una mejor opciÃ³n"
6. "Razones personales"
7. "Otro (especificar)"
```

### ğŸš« Situaciones donde NO se puede rechazar

```
âŒ PrÃ©stamo ya desembolsado
âŒ PrÃ©stamo en perÃ­odo de gracia
âŒ PrÃ©stamo con pagos vencidos
âŒ PrÃ©stamo siendo refinanciado
```

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

Si Pisto te ofrece un prÃ©stamo pero decidiste que no lo necesitas o las condiciones no te favorecen, puedes rechazarlo fÃ¡cilmente sin penalizaciÃ³n.

### ğŸ“ UbicaciÃ³n en la App

**Ubicaciones donde puedes rechazar:**

1. **Dashboard**

    - Tarjeta de "PrÃ©stamo disponible"
    - BotÃ³n "â‹®" (tres puntos) â†’ "Rechazar"

2. **Pantalla de Oferta**

    - Monto aprobado: $500
    - Plazo: 30 dÃ­as
    - BotÃ³n "Rechazar este prÃ©stamo"

3. **Notificaciones**
    - "Tu prÃ©stamo fue aprobado"
    - Abre notificaciÃ³n
    - BotÃ³n "Rechazar oferta"

### ğŸš€ Flujo Paso a Paso

#### **Paso 1: Indicar Rechazo**

Usuario presiona cualquier botÃ³n "Rechazar":

```
Dashboard â†’ PrÃ©stamo Disponible
   â†“
Presiona: "â‹® Opciones"
   â†“
MenÃº aparece:
  â”œâ”€ Aceptar prÃ©stamo
  â””â”€ Rechazar prÃ©stamo
   â†“
Presiona: "Rechazar prÃ©stamo"
```

#### **Paso 2: Modal de Rechazo**

Se muestra modal con tÃ­tulo y explicaciÃ³n:

**Modal:**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ Â¿Por quÃ© rechazas este prÃ©stamo?   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                    â•‘
â•‘ Si rechazas, no podrÃ¡s acceder a   â•‘
â•‘ este prÃ©stamo. Puedes solicitar    â•‘
â•‘ uno nuevo en el futuro.            â•‘
â•‘                                    â•‘
â•‘ Selecciona un motivo:              â•‘
â•‘                                    â•‘
â•‘ â—¯ No lo necesito ahora             â•‘
â•‘ â—¯ Las tasas son muy altas          â•‘
â•‘ â—¯ Prefiero esperar                 â•‘
â•‘ â—¯ Razones personales               â•‘
â•‘ â—¯ Otro (especificar)               â•‘
â•‘                                    â•‘
â•‘  [Cancelar]    [Confirmar Rechazo] â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**QuÃ© ocurre:**

1. Modal carga razones desde servidor
2. Usuario selecciona una razÃ³n
3. Si es "Otro", aparece campo de texto
4. Usuario presiona "Confirmar Rechazo"

#### **Paso 3: ConfirmaciÃ³n**

ConfirmaciÃ³n adicional (si es apropiado):

```
Â¿EstÃ¡s seguro?

Una vez rechaces, este prÃ©stamo no
estarÃ¡ disponible. Puedes solicitar
uno nuevo en [fecha].

[ No, cancelar ]  [ SÃ­, rechazar ]
```

#### **Paso 4: EnvÃ­o a API**

Sistema envÃ­a:

```
POST /client/refuse-loan
{
  "reason": "No lo necesito ahora"
}
```

#### **Paso 5: Pantalla de Ã‰xito**

Se muestra confirmaciÃ³n:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  âœ… PrÃ©stamo Rechazado               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                      â•‘
â•‘  Tu prÃ©stamo ha sido rechazado       â•‘
â•‘  exitosamente.                       â•‘
â•‘                                      â•‘
â•‘  â€¢ Monto: $500                       â•‘
â•‘  â€¢ Plazo: 30 dÃ­as                    â•‘
â•‘  â€¢ RazÃ³n: No lo necesito ahora       â•‘
â•‘                                      â•‘
â•‘  Puedes solicitar un nuevo prÃ©stamo  â•‘
â•‘  cuando lo necesites.                â•‘
â•‘                                      â•‘
â•‘         [Volver al Dashboard]        â•‘
â•‘                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**InformaciÃ³n mostrada:**

-   âœ… ConfirmaciÃ³n de rechazo
-   ğŸ“Š Detalles del prÃ©stamo rechazado
-   ğŸ“ RazÃ³n del rechazo
-   â­ï¸ CuÃ¡ndo puede solicitar de nuevo

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ PatrÃ³n ArquitectÃ³nico

Flujo simple y lineal optimizado para operaciÃ³n rÃ¡pida:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Presentation Layer (UI)                    â”‚
â”‚                                             â”‚
â”‚ â”œâ”€ LoanRejectionScreen      (Modal)         â”‚
â”‚ â””â”€ LoanRejectionSuccessScreen (Ã‰xito)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘
                    â”‚ (Riverpod Consumers)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ State Mgmt   â”‚      â”‚ State Mgmt   â”‚
â”‚              â”‚      â”‚              â”‚
â”‚ LoanRejectionâ”‚      â”‚ SelectedRej  â”‚
â”‚ Notifier     â”‚      â”‚ ReasonNotif. â”‚
â”‚              â”‚      â”‚              â”‚
â”‚ AsyncValue   â”‚      â”‚ String?      â”‚
â”‚ <Response>   â”‚      â”‚ (reason)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Repository Layer    â”‚
        â”‚                     â”‚
        â”‚ LoanRejectionRepo   â”‚
        â”‚ â”œâ”€ getRejectReasons â”‚
        â”‚ â””â”€ refuseLoan()     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Data Layer (APIs)   â”‚
        â”‚                     â”‚
        â”‚ GET /client/        â”‚
        â”‚   reject-reasons    â”‚
        â”‚                     â”‚
        â”‚ POST /client/       â”‚
        â”‚   refuse-loan       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¦ GestiÃ³n de Estado con Riverpod

```dart
// Provider para razones de rechazo (cargadas de API)
@riverpod
Future<List<String>> rejectReasons(Ref ref) async {
  final repository = ref.read(loanRejectionRepositoryProvider);
  final response = await repository.getRejectReasons();
  return response.data;
}

// Notifier para manejar rechazo (enviar a API)
@riverpod
class LoanRejectionNotifier extends _$LoanRejectionNotifier {
  @override
  AsyncValue<RefuseLoanResponse?> build() {
    return const AsyncValue.data(null);
  }

  Future<void> refuseLoan(String reason) async {
    state = const AsyncValue.loading();
    try {
      final repository = ref.read(loanRejectionRepositoryProvider);
      final response = await repository.refuseLoan(reason);
      state = AsyncValue.data(response);
    } catch (error, stackTrace) {
      state = AsyncValue.error(error, stackTrace);
    }
  }
}

// Notifier para razÃ³n seleccionada
@riverpod
class SelectedRejectionReasonNotifier
    extends _$SelectedRejectionReasonNotifier {
  @override
  String? build() => null;

  void selectReason(String reason) => state = reason;
  void clearSelection() => state = null;
}
```

**Por quÃ© AsyncValue:**

-   Maneja 3 estados: loading, data, error
-   UI reacciona automÃ¡ticamente
-   Manejo simple de errores
-   No requiere keepAlive (operaciÃ³n de una sola vez)

---

## Flujo Completo de Datos

### ğŸ”„ Secuencia Completa

```
INICIO: Usuario ve prÃ©stamo aprobado
    â†“
â”Œâ”€ CARGA DE RAZONES
â”‚  â”œâ”€ GET /client/reject-reasons
â”‚  â”œâ”€ Response: ["No lo necesito", "Tasas altas", ...]
â”‚  â””â”€ UI carga razones en dropdown/radio
â”‚
â”œâ”€ SELECCIÃ“N DE RAZÃ“N
â”‚  â”œâ”€ Usuario selecciona razÃ³n
â”‚  â”œâ”€ SelectedRejectionReasonNotifier.selectReason(reason)
â”‚  â””â”€ state = reason
â”‚
â”œâ”€ CONFIRMACIÃ“N
â”‚  â”œâ”€ Usuario presiona "Confirmar Rechazo"
â”‚  â”œâ”€ Sistema valida que hay razÃ³n seleccionada
â”‚  â””â”€ Procede con envÃ­o
â”‚
â”œâ”€ ENVÃO A API
â”‚  â”œâ”€ LoanRejectionNotifier.refuseLoan(reason)
â”‚  â”œâ”€ state = AsyncValue.loading()
â”‚  â”œâ”€ Mostrar spinner
â”‚  â”‚
â”‚  â”œâ”€ POST /client/refuse-loan
â”‚  â”‚  Body: { "reason": "No lo necesito ahora" }
â”‚  â”‚  Headers: Authorization: Bearer <token>
â”‚  â”‚
â”‚  â””â”€ Response:
â”‚     {
â”‚       "status": 200,
â”‚       "message": "PrÃ©stamo rechazado exitosamente"
â”‚     }
â”‚
â”œâ”€ MANEJO DE RESPUESTA
â”‚  â”œâ”€ Si 200: state = AsyncValue.data(response)
â”‚  â”œâ”€ Si error: state = AsyncValue.error(error, stackTrace)
â”‚  â””â”€ UI reacciona y navega accordingly
â”‚
â””â”€ Ã‰XITO
   â”œâ”€ Mostrar LoanRejectionSuccessScreen
   â”œâ”€ Resumen del rechazo
   â””â”€ BotÃ³n "Volver al Dashboard"
```

---

## Componentes

### ğŸ“¦ Models

#### RefuseLoanRequest

```dart
@freezed
abstract class RefuseLoanRequest with _$RefuseLoanRequest {
  const factory RefuseLoanRequest({
    required String reason,
  }) = _RefuseLoanRequest;

  factory RefuseLoanRequest.fromJson(Map<String, dynamic> json) =>
      _$RefuseLoanRequestFromJson(json);
}
```

#### RefuseLoanResponse

```dart
@freezed
abstract class RefuseLoanResponse with _$RefuseLoanResponse {
  const factory RefuseLoanResponse({
    required String message,
    // Puede incluir: timestamp, requestId, etc.
  }) = _RefuseLoanResponse;

  factory RefuseLoanResponse.fromJson(Map<String, dynamic> json) =>
      _$RefuseLoanResponseFromJson(json);
}
```

#### RejectReasonsResponse

```dart
@freezed
abstract class RejectReasonsResponse with _$RejectReasonsResponse {
  const factory RejectReasonsResponse({
    required List<String> data,  // Lista de razones
  }) = _RejectReasonsResponse;

  factory RejectReasonsResponse.fromJson(Map<String, dynamic> json) =>
      _$RejectReasonsResponseFromJson(json);
}
```

### ğŸ”§ Repositories

#### LoanRejectionRepository

```dart
class LoanRejectionRepository {
  final HttpClient _httpClient;

  LoanRejectionRepository(this._httpClient);

  // Obtener razones de rechazo
  Future<RejectReasonsResponse> getRejectReasons() async {
    try {
      final response = await _httpClient.get('/client/reject-reasons');
      return RejectReasonsResponse.fromJson(response.data);
    } on DioException catch (e) {
      throw Exception('Error al obtener razones: ${e.message}');
    }
  }

  // Rechazar prÃ©stamo
  Future<RefuseLoanResponse> refuseLoan(String reason) async {
    try {
      final requestData = {'reason': reason};
      final response = await _httpClient.post(
        '/client/refuse-loan',
        data: requestData,
      );
      return RefuseLoanResponse.fromJson(response.data);
    } on DioException catch (e) {
      throw Exception('Error al rechazar: ${e.message}');
    }
  }
}
```

---

## APIs Utilizadas

### Endpoint 1: Obtener Razones de Rechazo

#### `GET /client/reject-reasons`

**DescripciÃ³n**: Obtiene la lista de razones disponibles para rechazar un prÃ©stamo.

**Headers Requeridos**:

```
Authorization: Bearer <token_del_usuario>
Language: es
```

**Response Exitosa (200 OK)**:

```json
{
    "status": 200,
    "data": [
        "No lo necesito en este momento",
        "Las tasas de interÃ©s son demasiado altas",
        "Prefiero diferir a un mejor momento",
        "CambiÃ© de opiniÃ³n",
        "Razones personales",
        "Otro"
    ]
}
```

**Respuestas de Error**:

| CÃ³digo | SituaciÃ³n      | Mensaje                  |
| ------ | -------------- | ------------------------ |
| 401    | No autenticado | "Usuario no autenticado" |
| 500    | Error servidor | "Error interno"          |

---

### Endpoint 2: Rechazar PrÃ©stamo

#### `POST /client/refuse-loan`

**DescripciÃ³n**: Rechaza el prÃ©stamo actualmente ofrecido.

**Headers Requeridos**:

```
Content-Type: application/json
Authorization: Bearer <token_del_usuario>
Language: es
```

**Request Body**:

```json
{
    "reason": "No lo necesito en este momento"
}
```

**Validaciones servidor:**

-   âœ… Token vÃ¡lido
-   âœ… Usuario tiene prÃ©stamo en estado "oferecido" o "pendiente"
-   âœ… RazÃ³n no estÃ¡ vacÃ­a
-   âœ… RazÃ³n existe en lista de razones vÃ¡lidas (o es "Otro")

**Response Exitosa (200 OK)**:

```json
{
    "status": 200,
    "message": "PrÃ©stamo rechazado exitosamente"
}
```

**Respuestas de Error**:

| CÃ³digo | SituaciÃ³n                     | Mensaje                             |
| ------ | ----------------------------- | ----------------------------------- |
| 400    | RazÃ³n invÃ¡lida                | "RazÃ³n no vÃ¡lida"                   |
| 400    | No hay prÃ©stamo para rechazar | "No hay prÃ©stamo disponible"        |
| 401    | No autenticado                | "Usuario no autenticado"            |
| 422    | PrÃ©stamo no rechazable        | "Este prÃ©stamo no puede rechazarse" |
| 500    | Error servidor                | "Error interno del servidor"        |

---

## Manejo de Errores

### ğŸš¨ Estrategia de Errores

#### Errores Comunes

```dart
try {
  await repository.refuseLoan(reason);
} on DioException catch (e) {
  if (e.response?.statusCode == 400) {
    // RazÃ³n invÃ¡lida o no hay prÃ©stamo
    showSnackBar("No se puede rechazar este prÃ©stamo");
  } else if (e.response?.statusCode == 401) {
    // No autenticado
    redirectToLogin();
  } else if (e.response?.statusCode == 422) {
    // PrÃ©stamo no rechazable
    showSnackBar("Este prÃ©stamo estÃ¡ en estado no permitido");
  } else {
    // Error genÃ©rico
    showSnackBar("Error al rechazar el prÃ©stamo");
  }
}
```

### ğŸ“Š Ãrbol de DecisiÃ³n

```
Error en Rechazo
    â”‚
    â”œâ”€ 400: ValidaciÃ³n
    â”‚   â”œâ”€ "RazÃ³n invÃ¡lida"
    â”‚   â”‚   â””â”€ Seleccionar razÃ³n vÃ¡lida
    â”‚   â””â”€ "No hay prÃ©stamo"
    â”‚       â””â”€ Volver al inicio
    â”‚
    â”œâ”€ 401: AutenticaciÃ³n
    â”‚   â””â”€ Redirigir a login
    â”‚
    â”œâ”€ 422: Estado invÃ¡lido
    â”‚   â””â”€ "PrÃ©stamo ya desembolsado"
    â”‚       â†’ Mostrar mensaje explicativo
    â”‚
    â””â”€ 5xx: Servidor
        â””â”€ "Error del servidor, intenta mÃ¡s tarde"
```

---

## Casos de Uso

### ğŸ“– Escenarios Reales

#### Caso 1: Usuario cambiÃ³ de opiniÃ³n

```
SituaciÃ³n:
  Usuario solicita prÃ©stamo â†’ Es aprobado â†’ Recibe notificaciÃ³n

Mientras espera desembolso, cambia de opiniÃ³n.

Acciones:
  1. Abre app
  2. Ve "PrÃ©stamo disponible: $500"
  3. Presiona "Rechazar"
  4. Selecciona "CambiÃ© de opiniÃ³n"
  5. Presiona "Confirmar Rechazo"

Resultado:
  PrÃ©stamo rechazado âœ…
  Mensaje de Ã©xito mostrado
  Dashboard actualizado
```

#### Caso 2: Condiciones no favorables

```
SituaciÃ³n:
  Usuario ve oferta pero tasas son muy altas

Acciones:
  1. Toca modal de prÃ©stamo
  2. Presiona "â‹® Opciones"
  3. Selecciona "Rechazar"
  4. Elige razÃ³n: "Las tasas son muy altas"
  5. Ingresa comentario (si aplica)

Resultado:
  Servidor recibe feedback sobre razÃ³n
  Sistema puede mejorar ofertas futuras
  Usuario puede solicitar de nuevo en futuro
```

#### Caso 3: Diferimiento temporal

```
SituaciÃ³n:
  Usuario necesita dinero pero prefiere diferir

Acciones:
  1. Recibe notificaciÃ³n de aprobaciÃ³n
  2. Abre notificaciÃ³n
  3. Presiona "No lo necesito ahora"
  4. Confirma rechazo

Resultado:
  PrÃ©stamo rechazado pero puede solicitar cuando lo necesite
  Sin penalizaciÃ³n
  Sin afectar calificaciÃ³n crediticia
```

---

## Seguridad

### ğŸ” Consideraciones Importantes

#### 1. AutenticaciÃ³n

**En cada peticiÃ³n:**

```dart
final response = await _httpClient.post(
  '/client/refuse-loan',
  data: requestData,
  options: Options(
    headers: {
      'Authorization': 'Bearer $token',  // Token requerido
    },
  ),
);
```

**Validaciones servidor:**

-   âœ… Token vÃ¡lido y no expirado
-   âœ… Usuario existe y estÃ¡ activo
-   âœ… Token pertenece al usuario que intenta rechazar

#### 2. ValidaciÃ³n de OperaciÃ³n

**Servidor valida:**

-   âœ… PrÃ©stamo existe
-   âœ… PrÃ©stamo pertenece al usuario
-   âœ… PrÃ©stamo estÃ¡ en estado rechazable
-   âœ… RazÃ³n estÃ¡ en lista permitida

#### 3. AuditorÃ­a

**Se registran:**

-   âœ… QuiÃ©n rechazÃ³ (user_id)
-   âœ… CuÃ¡ndo (timestamp)
-   âœ… QuÃ© prÃ©stamo (loan_id)
-   âœ… RazÃ³n especificada
-   âœ… IP de origen

#### 4. Sin Penalizaciones

-   âœ… No afecta calificaciÃ³n crediticia
-   âœ… Usuario puede solicitar de nuevo inmediatamente
-   âœ… No hay registro negativo

---

## ğŸ“ Resumen de Capas

| Capa           | Componente                      | Responsabilidad    |
| -------------- | ------------------------------- | ------------------ |
| **UI**         | LoanRejectionScreen             | Modal de razones   |
| **UI**         | LoanRejectionSuccessScreen      | ConfirmaciÃ³n Ã©xito |
| **State**      | LoanRejectionNotifier           | Enviar rechazo     |
| **State**      | SelectedRejectionReasonNotifier | SelecciÃ³n de razÃ³n |
| **State**      | rejectReasonsProvider           | Cargar razones     |
| **Repository** | LoanRejectionRepository         | HTTP calls         |
| **Data**       | HttpClient                      | HTTP client        |
| **Domain**     | RefuseLoanRequest/Response      | Modelos            |

---

## ğŸš€ PrÃ³ximos Pasos

1. **Razones personalizadas**: Permitir usuario escribir razÃ³n propia
2. **Encuestas de retroalimentaciÃ³n**: Obtener mÃ¡s informaciÃ³n
3. **Re-oferta automÃ¡tica**: Ofrecer prÃ©stamo mejorado despuÃ©s
4. **AnÃ¡lisis de razones**: Dashboard mostrando por quÃ© rechazos
5. **Seguimiento**: Notificar cuando usuario puede solicitar de nuevo

---

**VersiÃ³n**: 1.0
**Ãšltima actualizaciÃ³n**: Octubre 2024
**Autor**: Equipo de Desarrollo Pisto
**Estado**: ProducciÃ³n âœ…
