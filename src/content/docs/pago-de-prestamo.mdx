---
title: Flujo de pago de prÃ©stamo
slug: pago-de-prestamo
tags: [auth, flutter, riverpod, dio, formz, go_router, freezed, json_annotation]
description: Flujo de pago de prÃ©stamo. GestiÃ³n completa del proceso de registro de pagos de prÃ©stamos.
---

## DescripciÃ³n General

La funcionalidad de **Pago de PrÃ©stamo** (`loan_payment`) es el mÃ³dulo responsable de gestionar el proceso completo de registro de pagos de prÃ©stamos, permitiendo a los usuarios seleccionar entre diferentes operadores de pago (recargas, bancos) y registrar sus pagos de manera segura y eficiente. Este mÃ³dulo proporciona una interfaz intuitiva para que los usuarios puedan realizar pagos desde diferentes plataformas y mantener un registro detallado de sus transacciones.

### ğŸ“Š Estructura del Flujo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard       â”‚â”€â”€â”€â”€â–¶â”‚ InformaciÃ³n      â”‚â”€â”€â”€â”€â–¶â”‚ SelecciÃ³n de     â”‚â”€â”€â”€â”€â–¶â”‚ Formulario de    â”‚â”€â”€â”€â”€â–¶â”‚ ConfirmaciÃ³n    â”‚
â”‚ PrÃ©stamos       â”‚     â”‚ Importante       â”‚     â”‚ Operador         â”‚     â”‚ Pago             â”‚     â”‚ de Ã‰xito        â”‚
â”‚ (MyLoan)        â”‚     â”‚ (Instrucciones)  â”‚     â”‚ (Recargas/Bancos)â”‚     â”‚ (Monto/Fecha)    â”‚     â”‚ (Comprobante)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ Acceso directo      âœ“ Manual            âœ“ DinÃ¡mica          âœ“ Validado          âœ“ AutomÃ¡tica
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **Carga dinÃ¡mica de operadores**: Obtiene lista actualizada de mÃ©todos de pago
-   âœ… **DiferenciaciÃ³n por tipo**: Soporta operadores de recarga y bancos
-   âœ… **CÃ¡lculo automÃ¡tico de comisiones**: Muestra costos transparentes
-   âœ… **ValidaciÃ³n inteligente**: Campos dinÃ¡micos segÃºn tipo de operador
-   âœ… **Registro de pagos**: Proceso completo con confirmaciÃ³n
-   âœ… **Manejo robusto de errores**: RecuperaciÃ³n ante fallos de red
-   âœ… **Estado persistente**: Mantiene datos durante navegaciÃ³n
-   âœ… **IntegraciÃ³n con prÃ©stamos**: InformaciÃ³n contextual del prÃ©stamo activo

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

El registro de pagos te permite:

-   **Pagar tu prÃ©stamo**: Realizar abonos a tu prÃ©stamo desde diferentes plataformas
-   **Elegir mÃ©todo de pago**: Seleccionar entre operadores de recarga o bancos
-   **Ver comisiones**: Conocer los costos asociados a cada mÃ©todo de pago
-   **Obtener comprobante**: Generar registro de tu pago para tu control

### ğŸ“± Pasos para registrar tu pago

#### Paso 1: Acceso desde tu dashboard

Desde tu pantalla principal de prÃ©stamos:

1. ğŸ  **Ve a "Mis PrÃ©stamos"** - Accede desde el menÃº principal
2. ğŸ“„ **Selecciona tu prÃ©stamo activo** - Toca el prÃ©stamo que quieres pagar
3. ğŸ’° **Busca "Registrar Pago"** - Encuentra la opciÃ³n de pago
4. â–¶ï¸ **Presiona "Continuar"** - Inicia el proceso de registro

#### Paso 2: InformaciÃ³n importante

Lee cuidadosamente las instrucciones:

-   ğŸ“‹ **Requisitos del pago**: Monto mÃ­nimo y condiciones
-   â° **Horarios de procesamiento**: CuÃ¡ndo se aplicarÃ¡ tu pago
-   ğŸ’¡ **MÃ©todos disponibles**: QuÃ© opciones de pago tienes
-   ğŸ“ **Soporte**: Contacto en caso de dudas
-   âœ… **Presiona "Aceptar"** - ContinÃºa al siguiente paso

#### Paso 3: SelecciÃ³n del operador de pago

Elige cÃ³mo quieres realizar tu pago:

**Operadores de Recarga:**

-   ğŸ“± **Recargas electrÃ³nicas**: Tigo, Claro, Movistar, etc.
-   ğŸ’° **Comisiones bajas**: Generalmente montos fijos pequeÃ±os
-   ğŸ• **Procesamiento rÃ¡pido**: AplicaciÃ³n inmediata o en minutos
-   ğŸ“² **Conveniencia**: Paga desde tu telÃ©fono

**Bancos:**

-   ğŸ¦ **Transferencias bancarias**: Todos los bancos principales
-   ğŸ’¸ **Comisiones variables**: Porcentuales segÃºn el banco
-   ğŸ• **Procesamiento estÃ¡ndar**: Puede tomar 1-2 horas
-   ğŸ“„ **Referencia requerida**: NecesitarÃ¡s nÃºmero de referencia

#### Paso 4: Completar el formulario

Ingresa los detalles de tu pago:

**InformaciÃ³n del Pago:**

-   ğŸ’° **Monto a pagar**: Ingresa la cantidad que deseas abonar
-   ğŸ“… **Fecha del pago**: Selecciona cuÃ¡ndo realizaste el pago
-   ğŸ”¢ **NÃºmero de referencia**: (Solo bancos) El cÃ³digo de tu transacciÃ³n

**ValidaciÃ³n AutomÃ¡tica:**

-   âœ… **Monto vÃ¡lido**: Verifica que cumpla el mÃ­nimo requerido
-   âœ… **Formato correcto**: Valida que los datos estÃ©n bien escritos
-   âœ… **ComisiÃ³n calculada**: Muestra cuÃ¡nto recibirÃ¡ Pisto
-   âœ… **Total transparente**: Ve exactamente cuÃ¡nto pagarÃ¡s

#### Paso 5: ConfirmaciÃ³n del pago

Revisa toda la informaciÃ³n antes de registrar:

**Resumen del Pago:**

-   ğŸ‘€ **Operador seleccionado**: Confirma el mÃ©todo de pago
-   ğŸ’° **Monto del pago**: Verifica la cantidad a registrar
-   ğŸ“Š **ComisiÃ³n aplicada**: Revisa los costos del servicio
-   ğŸ¦ **Monto neto**: CuÃ¡nto se aplicarÃ¡ a tu prÃ©stamo
-   ğŸ“… **Fecha y hora**: CuÃ¡ndo se realizÃ³ el pago

**ConfirmaciÃ³n Final:**

-   âš ï¸ **VerificaciÃ³n final**: "Â¿EstÃ¡s seguro de registrar este pago?"
-   âœ… **Presiona "Confirmar"** - EnvÃ­a la informaciÃ³n para procesar
-   â³ **Espera la confirmaciÃ³n** - El sistema procesarÃ¡ tu registro

#### Paso 6: Resultado del proceso

**Si el pago se registra exitosamente:**

-   ğŸ‰ **Pago registrado**: ConfirmaciÃ³n inmediata del registro
-   ğŸ“§ **Comprobante generado**: NÃºmero de referencia del registro
-   ğŸ  **Ve a tu dashboard**: Presiona "Continuar" para ver actualizaciones
-   ğŸ“Š **PrÃ©stamo actualizado**: VerÃ¡s el nuevo saldo en tu prÃ©stamo

**Si hay errores:**

-   âŒ **Mensaje especÃ­fico**: Explica quÃ© necesita ser corregido
-   ğŸ”„ **OpciÃ³n de reintentar**: Corrige los datos e intenta nuevamente
-   ğŸ“ **Contacta soporte**: Si el problema persiste
-   ğŸ’¡ **Sugerencias**: Recomendaciones para completar el pago

### âš ï¸ Importante

-   **Verifica el monto**: AsegÃºrate de pagar el monto correcto
-   **Guarda tu comprobante**: MantÃ©n el nÃºmero de referencia
-   **Horarios de procesamiento**: Algunos mÃ©todos tienen demoras
-   **Comisiones**: Revisa los costos antes de confirmar
-   **Soporte tÃ©cnico**: Contacta si tienes problemas con el pago

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ Estructura del MÃ³dulo

El mÃ³dulo sigue la arquitectura establecida en el proyecto Pisto con separaciÃ³n de responsabilidades clara:

```
loan_payment/
â”œâ”€â”€ models/                      # DTOs y entidades de datos
â”‚   â”œâ”€â”€ payment_operator.dart           # Operadores de pago disponibles
â”‚   â”œâ”€â”€ payment_operators_response.dart # Respuesta de lista de operadores
â”‚   â”œâ”€â”€ payment_request.dart            # Payload para registrar pago
â”‚   â”œâ”€â”€ payment_response.dart           # Respuesta del registro
â”‚   â””â”€â”€ payment_form_state.dart         # Estado del formulario
â”œâ”€â”€ providers/                   # GestiÃ³n de estado con Riverpod
â”‚   â””â”€â”€ loan_payment_provider.dart      # Estado principal del flujo
â”œâ”€â”€ repositories/               # Capa de acceso a datos
â”‚   â””â”€â”€ loan_payment_repository.dart    # ComunicaciÃ³n con la API
â”œâ”€â”€ screens/                    # Interfaces de usuario
â”‚   â”œâ”€â”€ loan_payment_step_one_screen.dart   # InformaciÃ³n importante
â”‚   â”œâ”€â”€ loan_payment_step_two_screen.dart  # SelecciÃ³n y formulario
â”‚   â”œâ”€â”€ loan_payment_success_screen.dart   # ConfirmaciÃ³n de Ã©xito
â”‚   â””â”€â”€ loan_amount_info_section.dart      # Info del prÃ©stamo
â””â”€â”€ widgets/                    # Componentes reutilizables
```

### ğŸ“Š Models (Entidades de Datos)

#### **PaymentOperator**

Representa un operador de pago con sus caracterÃ­sticas:

```dart
@freezed
class PaymentOperator with _$PaymentOperator {
  const factory PaymentOperator({
    required int id,                           // ID Ãºnico del operador
    required String name,                      // Nombre del operador
    required String operatorType,              // 'o' = operador, 'b' = banco
    required String accountName,               // Nombre de la cuenta
    required String logo,                      // URL del logo
    required String commissionType,            // 'amount' | 'percentage'
    double? commissionValueAmount,             // ComisiÃ³n fija
    double? commissionValuePercentage,         // ComisiÃ³n porcentual
    required String workingHours,              // Horario de atenciÃ³n
    String? accountType,                       // Tipo de cuenta (bancos)
    String? accountNumber,                     // NÃºmero de cuenta
    required bool active,                      // Si estÃ¡ disponible
  }) = _PaymentOperator;

  // MÃ©todos de conveniencia
  bool get isOperator => operatorType == 'o';
  bool get isBank => operatorType == 'b';
  String get commissionText => /* Formato legible */;
}
```

#### **PaymentRequest**

Payload para registrar un pago:

```dart
@freezed
class PaymentRequest with _$PaymentRequest {
  const factory PaymentRequest({
    required String operatorType,              // 'o' | 'b'
    required int operatorId,                   // ID del operador
    required double amount,                    // Monto del pago
    String? reference,                         // Referencia (solo bancos)
    required String date,                      // Fecha del pago
  }) = _PaymentRequest;
}
```

#### **PaymentFormState**

Estado del formulario con validaciones:

```dart
@freezed
class PaymentFormState with _$PaymentFormState {
  const factory PaymentFormState({
    @Default(AmountInput.pure()) AmountInput amount,
    @Default(BirthDateInput.pure()) BirthDateInput paymentDate,
    @Default(TextInput.pure()) TextInput reference,
    @Default(false) bool isLoading,
    String? error,
    @Default(false) bool showConfirmation,
    @Default(false) bool paymentCompleted,
  }) = _PaymentFormState;

  // ValidaciÃ³n dinÃ¡mica segÃºn tipo de operador
  bool isFormValid(String operatorType);
  double calculateReceivedAmount(double? commissionAmount);
}
```

### ğŸ¯ Providers (GestiÃ³n de Estado)

#### **LoanPaymentNotifier**

StateNotifier principal con manejo completo del flujo:

```dart
@freezed
class LoanPaymentState with _$LoanPaymentState {
  const factory LoanPaymentState({
    @Default(false) bool isLoading,           // Cargando operadores
    @Default([]) List<PaymentOperator> paymentOperators,  // Lista completa
    PaymentOperator? selectedOperator,         // Operador seleccionado
    @Default(PaymentFormState()) PaymentFormState formState,  // Estado formulario
    String? error,                             // Error general
    String? successMessage,                    // Mensaje de Ã©xito
  }) = _LoanPaymentState;
}

@riverpod
class LoanPaymentNotifier extends _$LoanPaymentNotifier {
  // MÃ©todos principales:
  // - Future<void> loadPaymentOperators()
  // - void selectOperator(PaymentOperator operator)
  // - void updateAmount(String value)
  // - void updateDate(String value)
  // - void updateReference(String value)
  // - Future<void> registerPayment()
  // - void showConfirmation()
  // - bool get isFormValid
}
```

### ğŸŒ Repository (Acceso a Datos)

#### **LoanPaymentRepository**

Clase responsable de la comunicaciÃ³n con la API:

```dart
class LoanPaymentRepository {
  // GET /client/payment-operators
  Future<PaymentOperatorsResponse> getPaymentOperators();

  // POST /client/payment
  Future<PaymentResponse> registerPayment(PaymentRequest request);
}

// Manejo especÃ­fico de errores
enum LoanPaymentExceptionType {
  network,      // Problemas de conectividad
  validation,   // Datos invÃ¡lidos
  unauthorized, // No autenticado
  unknown,      // Error desconocido
}
```

---

## Flujo Completo de Datos

### ğŸ”„ Flujo de NavegaciÃ³n

```
MyLoan (Dashboard)
  â†“
/loan-payment/step-one (InformaciÃ³n importante)
  â†“
/loan-payment/step-two (SelecciÃ³n y formulario)
  â”œâ”€â†’ [Seleccionar operador] â†’ Actualizar comisiones
  â”œâ”€â†’ [Completar formulario] â†’ Validar campos
  â”œâ”€â†’ [Mostrar confirmaciÃ³n] â†’ DiÃ¡logo de verificaciÃ³n
  â””â”€â†’ [Registrar pago] â†’ POST /client/payment â†’ /loan-payment/success
```

### ğŸ“Š Diagrama de Estado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LoanPaymentNotifier                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Estado: initial â†’ loading â†’ operators_loaded â†’ submitting â†’ completed â”‚
â”‚                                                               â†‘ error â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Datos:                                                        â”‚
â”‚  - paymentOperators: List<PaymentOperator>                     â”‚
â”‚  - selectedOperator: PaymentOperator?                          â”‚
â”‚  - formState: PaymentFormState (amount, date, reference)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LÃ³gica:                                                       â”‚
â”‚  - activeOperators: Filtrados por type='o' y active=true       â”‚
â”‚  - activeBanks: Filtrados por type='b' y active=true           â”‚
â”‚  - isFormValid: SegÃºn tipo de operador seleccionado            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ Ciclo de Vida

1. **Dashboard â†’ Step One**: NavegaciÃ³n desde prÃ©stamos activos
2. **Step One â†’ Step Two**: Lectura de informaciÃ³n y carga de operadores
3. **Step Two â†’ SelecciÃ³n**: ElecciÃ³n de operador y carga de comisiones
4. **SelecciÃ³n â†’ Formulario**: Completar datos del pago
5. **Formulario â†’ ConfirmaciÃ³n**: ValidaciÃ³n y diÃ¡logo de verificaciÃ³n
6. **ConfirmaciÃ³n â†’ Registro**: EnvÃ­o a API y procesamiento
7. **Registro â†’ Ã‰xito**: NavegaciÃ³n a pantalla de confirmaciÃ³n

---

## Componentes y Pasos

### ğŸ“± Pantallas del Flujo

#### 1. ğŸ“‹ LoanPaymentStepOneScreen

-   **Ruta**: `/loan-payment/step-one`
-   **PropÃ³sito**: Mostrar informaciÃ³n importante sobre el proceso
-   **Funcionalidad**:
    -   Instrucciones claras sobre requisitos y horarios
    -   InformaciÃ³n sobre mÃ©todos de pago disponibles
    -   Carga automÃ¡tica de operadores en background
    -   Botones de navegaciÃ³n (Aceptar/AtrÃ¡s)

#### 2. ğŸ’³ LoanPaymentStepTwoScreen

-   **Ruta**: `/loan-payment/step-two`
-   **PropÃ³sito**: SelecciÃ³n de operador y formulario de pago
-   **Funcionalidad**:
    -   Grid de operadores de recarga y bancos
    -   Formulario dinÃ¡mico segÃºn tipo seleccionado
    -   CÃ¡lculo automÃ¡tico de comisiones
    -   ValidaciÃ³n en tiempo real
    -   DiÃ¡logo de confirmaciÃ³n antes de registrar

#### 3. ğŸ‰ LoanPaymentSuccessScreen

-   **Ruta**: `/loan-payment/success`
-   **PropÃ³sito**: ConfirmaciÃ³n de pago registrado exitosamente
-   **Funcionalidad**:
    -   Mensaje de Ã©xito con detalles
    -   InformaciÃ³n del comprobante generado
    -   BotÃ³n para volver al dashboard
    -   Limpieza automÃ¡tica del estado

### ğŸ§© Componentes Reutilizables

#### **LoanAmountInfoSection**

Componente para mostrar informaciÃ³n del prÃ©stamo activo:

```dart
class LoanAmountInfoSection extends StatelessWidget {
  final LoanData loanData;

  // Muestra: monto total, saldo pendiente, fecha lÃ­mite
}
```

#### **OperatorSelectionCard**

Componente visual para selecciÃ³n de operadores:

```dart
class OperatorSelectionCard extends StatelessWidget {
  final PaymentOperator operator;
  final bool isSelected;
  final VoidCallback onTap;

  // Muestra: logo, nombre, comisiÃ³n, estado
}
```

---

## APIs Utilizadas

### ğŸ“¡ Endpoints de API

#### **GET** `/client/payment-operators`

**PropÃ³sito**: Obtener lista de operadores de pago disponibles

**Headers Requeridos**:

```
Authorization: Bearer {token}
Content-Type: application/json
```

**Response Exitoso (200)**:

```json
{
    "data": [
        {
            "id": 1,
            "name": "Tigo Recargas",
            "operator_type": "o",
            "account_name": "Tigo Money",
            "logo": "https://logo.pisto.co/tigo.png",
            "commission_type": "amount",
            "commission_value_amount": 0.5,
            "commission_value_percentage": null,
            "working_hours": "24/7",
            "account_type": null,
            "account_number": null,
            "active": true
        },
        {
            "id": 2,
            "name": "Banco AgrÃ­cola",
            "operator_type": "b",
            "account_name": "Pisto SA de CV",
            "logo": "https://logo.pisto.co/agricola.png",
            "commission_type": "percentage",
            "commission_value_amount": null,
            "commission_value_percentage": 2.5,
            "working_hours": "Lunes a Viernes 9:00-16:00",
            "account_type": "Ahorro",
            "account_number": "1234-5678-9012-3456",
            "active": true
        }
    ]
}
```

**Error 403 (Forbidden)**:

```json
{
    "message": "No tienes permisos para realizar esta acciÃ³n."
}
```

#### **POST** `/client/payment`

**PropÃ³sito**: Registrar un nuevo pago de prÃ©stamo

**Request Body**:

```json
{
    "operatorType": "o",
    "operatorId": 1,
    "amount": 50.0,
    "reference": null,
    "date": "2025-11-03"
}
```

**Response Exitoso (200)**:

```json
{
    "message": "Pago registrado exitosamente. Se aplicarÃ¡ a tu prÃ©stamo en breve."
}
```

**Error 422 (Validation Error)**:

```json
{
    "errors": [
        {
            "message": "El monto mÃ­nimo de pago es $25.00"
        }
    ]
}
```

**Error 401 (Unauthorized)**:

```json
{
    "message": "Usuario no autenticado"
}
```

### ğŸŒ IntegraciÃ³n con HTTP Client

```dart
// ConfiguraciÃ³n del interceptor
class LoanPaymentInterceptor extends Interceptor {
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    // Agregar headers especÃ­ficos para pagos
    options.headers['X-Payment-Source'] = 'mobile_app';
    super.onRequest(options, handler);
  }

  @override
  void onError(DioException error, ErrorInterceptorHandler handler) {
    // Manejar errores especÃ­ficos de pagos
    if (error.response?.statusCode == 422) {
      // Error de validaciÃ³n de pago
      throw LoanPaymentValidationException(error.response?.data);
    }
    super.onError(error, handler);
  }
}
```

---

## Manejo de Errores

### âš ï¸ Tipos de Errores

#### **1. Errores de Carga de Operadores**

```dart
// Error de red
NetworkException {
  message: "No se pudieron cargar los operadores de pago. Verifica tu conexiÃ³n.",
  canRetry: true,
  retryCallback: () => ref.refresh(loanPaymentProvider),
}

// Permiso denegado
ForbiddenException {
  message: "No tienes permisos para acceder a los operadores de pago.",
  action: "contact_support",
}
```

#### **2. Errores de Registro de Pago**

```dart
// Error de validaciÃ³n
PaymentValidationException {
  message: "El monto del pago no cumple los requisitos mÃ­nimos.",
  field: "amount",
  minValue: 25.00,
}

// Error de referencia
ReferenceException {
  message: "El nÃºmero de referencia es invÃ¡lido para este banco.",
  field: "reference",
  pattern: "\\d{10}",
}
```

#### **3. Errores de Negocio**

```dart
// PrÃ©stamo no encontrado
LoanNotFoundException {
  message: "No se encontrÃ³ un prÃ©stamo activo para registrar el pago.",
  action: "redirect_to_dashboard",
}

// Pago duplicado
DuplicatePaymentException {
  message: "Ya existe un pago registrado con esta referencia.",
  paymentId: "PAY-123456",
}
```

#### **4. Errores de Sistema**

```dart
// Error del servidor
ServerException {
  message: "Error temporal del servidor. Por favor intenta mÃ¡s tarde.",
  canRetry: true,
  retryAfter: 300, // 5 minutos
}

// Timeout
TimeoutException {
  message: "La operaciÃ³n estÃ¡ tomando demasiado tiempo.",
  canRetry: true,
}
```

### ğŸ”„ Estrategias de RecuperaciÃ³n

#### **Reintentos AutomÃ¡ticos**

```dart
@riverpod
class PaymentRetryNotifier extends _$PaymentRetryNotifier {
  int _retryCount = 0;
  static const int maxRetries = 3;

  Future<void> retryPaymentRegistration() async {
    if (_retryCount < maxRetries) {
      _retryCount++;
      await Future.delayed(Duration(seconds: _retryCount * 3));
      // Reintentar registro con backoff exponencial
    }
  }
}
```

#### **Fallback para Usuario**

-   **OpciÃ³n de reintentar manual** el registro
-   **Guardar borrador local** del formulario
-   **Contactar soporte** con diagnÃ³stico automÃ¡tico
-   **Modo offline** permitiendo completar y sincronizar despuÃ©s

---

## Validaciones

### âœ… Validaciones Implementadas

1. **ValidaciÃ³n de Operadores**

    - VerificaciÃ³n de operadores activos
    - Filtrado por tipo (operador vs banco)
    - ValidaciÃ³n de horarios de operaciÃ³n

2. **ValidaciÃ³n de Formulario**

    - Monto mÃ­nimo requerido ($25.00)
    - Formato de fecha vÃ¡lido
    - Referencia obligatoria para bancos
    - Formato de referencia segÃºn banco

3. **Validaciones de Negocio**
    - Usuario con prÃ©stamo activo
    - Monto no excede saldo pendiente
    - No pagos duplicados
    - Horario de procesamiento vÃ¡lido

### ğŸ” LÃ³gica de ValidaciÃ³n

#### **ValidaciÃ³n DinÃ¡mica del Formulario**

```dart
class PaymentValidator {
  static ValidationResult validatePayment(
    PaymentFormState formState,
    PaymentOperator selectedOperator,
  ) {
    // Validar monto
    if (!formState.amount.isValid || formState.amount.doubleValue < 25.00) {
      return ValidationResult.invalid(
        'El monto mÃ­nimo de pago es \$25.00',
      );
    }

    // Validar referencia solo para bancos
    if (selectedOperator.isBank && !formState.reference.isValid) {
      return ValidationResult.invalid(
        'La referencia es obligatoria para pagos bancarios',
      );
    }

    // Validar fecha
    if (!formState.paymentDate.isValid) {
      return ValidationResult.invalid('Selecciona una fecha vÃ¡lida');
    }

    return ValidationResult.valid();
  }
}
```

#### **CÃ¡lculo de Comisiones**

```dart
class CommissionCalculator {
  static double calculateCommission(
    double amount,
    PaymentOperator operator,
  ) {
    if (operator.commissionType == 'amount') {
      return operator.commissionValueAmount ?? 0.0;
    } else if (operator.commissionType == 'percentage') {
      return amount * (operator.commissionValuePercentage ?? 0.0) / 100;
    }
    return 0.0;
  }

  static double calculateNetAmount(
    double amount,
    double commission,
  ) {
    return amount - commission;
  }
}
```

### ğŸ›¡ï¸ Consideraciones de Privacidad

-   Los datos de pago se encriptan en trÃ¡nsito
-   No se almacenan nÃºmeros de referencia localmente
-   Las transacciones tienen auditorÃ­a completa
-   Los datos sensibles tienen tiempo de vida limitado

---

## Testing

### ğŸ§ª Estrategia de Testing

#### **1. Unit Tests**

```dart
// test/unit/loan_payment_test.dart
void main() {
  group('LoanPaymentNotifier', () {
    test('debe cargar operadores correctamente', () {
      // Test de carga de operadores desde API
    });

    test('debe validar formulario segÃºn tipo de operador', () {
      // Test de validaciÃ³n dinÃ¡mica
    });

    test('debe calcular comisiones correctamente', () {
      // Test de cÃ¡lculo de montos y comisiones
    });
  });
}
```

#### **2. Widget Tests**

```dart
// test/widget/loan_payment_screen_test.dart
void main() {
  testWidgets('debe mostrar operadores correctamente', (tester) async {
    // Test de renderizado de lista de operadores
  });

  testWidgets('debe habilitar botÃ³n solo cuando formulario es vÃ¡lido', (tester) async {
    // Test de lÃ³gica de habilitaciÃ³n
  });

  testWidgets('debe mostrar diÃ¡logo de confirmaciÃ³n', (tester) async {
    // Test de flujo de confirmaciÃ³n
  });
}
```

#### **3. Integration Tests**

```dart
// test/integration/loan_payment_flow_test.dart
void main() {
  integrationTest('flujo completo de registro de pago', () async {
    // Simular selecciÃ³n â†’ formulario â†’ confirmaciÃ³n â†’ registro
  });

  integrationTest('manejo de errores de red', () async {
    // Test de recuperaciÃ³n ante fallos de conectividad
  });
}
```

### ğŸ“‹ Casos de Prueba CrÃ­ticos

#### **Flujos de Usuario**

-   âœ… Usuario completa pago con operador de recarga exitosamente
-   âœ… Usuario completa pago con banco y referencia
-   âœ… Usuario maneja error de validaciÃ³n de monto
-   âœ… Usuario reintenta despuÃ©s de error de red
-   âœ… Usuario navega hacia atrÃ¡s y pierde progreso del formulario

#### **Casos LÃ­mite**

-   ğŸ”„ CancelaciÃ³n del pago en el diÃ¡logo de confirmaciÃ³n
-   ğŸ”„ PÃ©rdida de conexiÃ³n durante registro de pago
-   ğŸ”„ Token expirado durante el proceso
-   ğŸ”„ Cambio de operador despuÃ©s de completar formulario
-   ğŸ”„ Monto exacto del saldo pendiente

### ğŸ“Š MÃ©tricas de Testing

-   **Cobertura mÃ­nima**: 85% para cÃ³digo crÃ­tico
-   **Tests de flujos**: 100% de los caminos principales
-   **Tests de validaciÃ³n**: Todas las reglas de negocio
-   **Tests de error**: Todos los tipos de error cubiertos

---

## Seguridad

### ğŸ”’ CaracterÃ­sticas de Seguridad

#### **1. ProtecciÃ³n de Datos**

-   âœ… **EncriptaciÃ³n en trÃ¡nsito**: Todos los datos viajan por HTTPS
-   âœ… **No persistencia local**: Datos de formulario no almacenados
-   âœ… **Tokens seguros**: AutenticaciÃ³n en cada peticiÃ³n
-   âœ… **ValidaciÃ³n de entrada**: SanitizaciÃ³n de todos los datos

#### **2. Validaciones de Seguridad**

```dart
// SanitizaciÃ³n de datos de pago
PaymentRequest sanitizePaymentRequest(PaymentRequest request) {
  // Validar formato de monto
  // Verificar formato de fecha
  // Limpiar caracteres especiales de referencia
  // Validar rangos permitidos
}

// ValidaciÃ³n de integridad
bool validatePaymentIntegrity(PaymentRequest request) {
  // Verificar que el monto sea positivo
  // Validar que la referencia tenga formato esperado
  // Confirmar que el operador estÃ© activo
}
```

#### **3. Manejo de SesiÃ³n**

-   â° **Timeout de formulario**: LÃ­mite de tiempo para completar pago
-   ğŸ”„ **Refresh automÃ¡tico**: RenovaciÃ³n de tokens durante proceso largo
-   ğŸšª **Logout seguro**: Limpieza completa de datos sensibles

### ğŸ›¡ï¸ Consideraciones de Privacidad

#### **Datos Sensibles**

-   âŒ **No almacenar**: NÃºmeros de referencia localmente
-   âŒ **No hacer cachÃ©**: InformaciÃ³n de tarjetas o cuentas
-   âœ… **Solo memoria volÃ¡til**: Datos durante el proceso
-   âœ… **EliminaciÃ³n garantizada**: Clean up explÃ­cito en todos los casos

#### **Cumplimiento Normativo**

-   ğŸ“‹ **ProtecciÃ³n financiera**: Cumplimiento con regulaciones de pago
-   ğŸ” **Audit trail**: Registro completo de transacciones
-   ğŸ“Š **Transparencia**: InformaciÃ³n clara de comisiones
-   ğŸ¦ **Banking compliance**: EstÃ¡ndares de transacciones financieras

### ğŸ” Best Practices Implementadas

```dart
// Ejemplo de implementaciÃ³n segura
class SecurePaymentService {
  Future<PaymentResponse> registerPaymentSecurely(
    PaymentRequest request,
  ) async {
    try {
      // 1. Validar y sanitizar solicitud
      final sanitizedRequest = _sanitizePaymentRequest(request);

      // 2. Enviar con token seguro
      final response = await _securePaymentRepository.register(
        sanitizedRequest,
        options: SecurePaymentOptions(
          timeout: Duration(seconds: 30),
          encryption: true,
          auditLog: true,
        ),
      );

      // 3. Limpiar datos sensibles
      _cleanupSensitiveData();

      return response;
    } catch (e) {
      // 4. Manejo seguro de errores
      _handlePaymentError(e);
      throw SecurePaymentException.fromError(e);
    }
  }
}
```

---

## ğŸš€ ImplementaciÃ³n y Mantenimiento

### ğŸ“¦ Dependencias Clave

```yaml
dependencies:
    flutter_riverpod: ^2.4.0 # GestiÃ³n de estado
    go_router: ^12.0.0 # NavegaciÃ³n
    freezed_annotation: ^2.4.0 # Modelos inmutables
    json_annotation: ^4.8.0 # SerializaciÃ³n JSON
    dio: ^5.3.0 # Cliente HTTP
    intl: ^0.18.0 # Formato de fechas y monedas

dev_dependencies:
    riverpod_generator: ^2.3.0 # Code generation
    freezed: ^2.4.0 # GeneraciÃ³n de modelos
    json_serializable: ^6.7.0 # GeneraciÃ³n JSON
    build_runner: ^2.4.0 # Herramienta de generaciÃ³n
```

### ğŸ”§ Comandos de Desarrollo

```bash
# Generar cÃ³digo (requerido despuÃ©s de cambios)
dart run build_runner build --delete-conflicting-outputs

# Modo watch durante desarrollo
dart run build_runner watch -d

# Ejecutar pruebas
flutter test test/features/loan_payment/

# AnÃ¡lisis estÃ¡tico
flutter analyze lib/features/loan_payment/
```

### ğŸ“ Mejores PrÃ¡cticas

1. **Code Generation**: Siempre ejecutar `build_runner` despuÃ©s de modificar modelos o providers
2. **State Management**: Usar `keepAlive: true` para persistencia durante navegaciÃ³n
3. **Error Handling**: Implementar manejo especÃ­fico para cada tipo de error
4. **Testing**: Mantener cobertura >85% para cÃ³digo crÃ­tico
5. **Form Validation**: ValidaciÃ³n en tiempo real con feedback claro
6. **Documentation**: Actualizar este documento con cada cambio significativo

---

## ğŸ”— Integraciones

### ğŸ“„ MÃ³dulos Relacionados

-   **MyLoan**: InformaciÃ³n del prÃ©stamo activo y dashboard
-   **Auth**: GestiÃ³n de tokens y permisos
-   **Network**: ConfiguraciÃ³n HTTP y manejo de errores
-   **Shared**: Inputs reutilizables y widgets comunes
-   **Logging**: Registro de operaciones financieras

### ğŸ”„ Flujo de Datos

```
MyLoan (PrÃ©stamo activo)
  â†“
LoanPayment (Registro de pago)
  â†“
PaymentOperators (Carga de mÃ©todos)
  â†“
PaymentAPI (Procesamiento de transacciÃ³n)
  â†“
MyLoan (ActualizaciÃ³n de saldo)
```
