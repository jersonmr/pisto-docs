---
title: Flujo de Solicitud de primer prÃ©stamo
slug: solicitud-de-primer-prestamo
tags:
    [
        auth,
        first-loan,
        phone-number-verification,
        otp,
        image-upload,
        flutter,
        riverpod,
        dio,
        formz,
    ]
description: Flujo de solicitud de primer prÃ©stamo en la aplicaciÃ³n Pisto, incluyendo validaciÃ³n de nÃºmero telefÃ³nico, carga de imÃ¡genes, manejo de errores y estados del proceso.
---

## DescripciÃ³n General

El **flujo de solicitud de primer prÃ©stamo** es el proceso central de Pisto que permite a nuevos usuarios solicitar su primer prÃ©stamo. El flujo estÃ¡ dividido en **7 pasos** (incluyendo bienvenida y confirmaciÃ³n) donde se recopila informaciÃ³n completa del usuario.

### ğŸ“Š Estructura de Pasos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Welcome    â”‚â”€â”€â”€â”€â–¶â”‚   Step 1   â”‚â”€â”€â”€â”€â–¶â”‚   Step 2    â”‚â”€â”€â”€â”€â–¶â”‚   Step 3   â”‚â”€â”€â”€â”€â–¶â”‚   Step 4     â”‚â”€â”€â”€â”€â–¶â”‚   Step 5   â”‚â”€â”€â”€â”€â–¶â”‚ Completion  â”‚
â”‚  (Intro)    â”‚     â”‚ (Personal) â”‚     â”‚  (Address)  â”‚     â”‚  (Finance) â”‚     â”‚(References) â”‚     â”‚  (Images)  â”‚     â”‚ (Confirm)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     âœ“ Auto           âœ“ Manual           âœ“ Manual           âœ“ Manual           âœ“ Manual           âœ“ Manual          âœ“ Auto/Manual
     (Inicio)        (ValidaciÃ³n)       (SelecciÃ³n)        (Ingreso)          (Ingreso)          (CÃ¡mara)         (ConfirmaciÃ³n)
```

### âœ¨ CaracterÃ­sticas Principales

-   âœ… **7 pasos guiados**: RecolecciÃ³n progresiva de datos
-   âœ… **ValidaciÃ³n en tiempo real**: Feedback inmediato
-   âœ… **Salto a pasos anteriores**: CorrecciÃ³n fÃ¡cil
-   âœ… **Datos del calculador**: Monto y plazo pre-seleccionados
-   âœ… **Descarga de documentos**: PDF con tÃ©rminos y condiciones
-   âœ… **ConfirmaciÃ³n final**: RevisiÃ³n antes de envÃ­o
-   âœ… **Manejo robusto de errores**: Reintentos y recuperaciÃ³n
-   âœ… **Logging completo**: AuditorÃ­a de todas las operaciones

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

La solicitud de primer prÃ©stamo es tu entrada a Pisto. En este proceso:

-   **Verificamos tu identidad**: Necesitamos datos personales completos
-   **Confirmamos tu ubicaciÃ³n**: Para determinar si puedes recibir prÃ©stamo
-   **Evaluamos tu capacidad de pago**: Ingresos, deudas, referencias
-   **Recolectamos documentos**: Fotos de tu DUI y selfie
-   **Calculamos el prÃ©stamo**: Basado en lo que preseleccionaste

### ğŸ“ UbicaciÃ³n en la App

**Ruta**: `Settings â†’ Solicitar PrÃ©stamo` o `Dashboard â†’ Nuevo PrÃ©stamo`

**Requisitos previos:**

-   âœ… Cuenta creada y verificada
-   âœ… TelÃ©fono confirmado
-   âœ… Email validado

### ğŸš€ Flujo Paso a Paso

#### **Paso 0: Bienvenida (Welcome Screen)**

Esta pantalla es informativa y NO requiere entrada de datos.

**QuÃ© se muestra:**

1. Bienvenida personalizada: "Â¡Hola [nombre]!"
2. Monto y plazo que preseleccionaste en el calculador
3. Resumen de lo que necesitaremos
4. InformaciÃ³n sobre documentos requeridos
5. BotÃ³n "Comencemos"

**QuÃ© ocurre internamente:**

-   El sistema carga los datos del calculador
-   Se valida que el usuario tenga sesiÃ³n activa
-   Se prepara el estado para recibir datos

**Campos:** Ninguno (solo botÃ³n de continuar)

---

#### **Paso 1: InformaciÃ³n Personal (Step 1)**

**QuÃ© necesitamos:**

| Campo      | Tipo      | ValidaciÃ³n                                | Obligatorio |
| ---------- | --------- | ----------------------------------------- | ----------- |
| Nombre     | Texto     | MÃ­nimo 2 caracteres, sin nÃºmeros          | âœ… SÃ­       |
| Apellido   | Texto     | MÃ­nimo 2 caracteres, sin nÃºmeros          | âœ… SÃ­       |
| GÃ©nero     | SelecciÃ³n | Masculino / Femenino                      | âœ… SÃ­       |
| Fecha Nac. | Fecha     | Edad mÃ­nima 18 aÃ±os, mÃ¡ximo 100 aÃ±os      | âœ… SÃ­       |
| DUI        | Texto     | 8 dÃ­gitos + guiÃ³n + 1 dÃ­gito (12345678-9) | âœ… SÃ­       |
| TelÃ©fono   | Texto     | Validado en Step anterior (OTP)           | âœ… SÃ­       |

**Validaciones especiales:**

-   El telÃ©fono viene pre-llenado del paso de validaciÃ³n
-   Se requiere marca de verificaciÃ³n: âœ… TelÃ©fono validado
-   Si el usuario intenta cambiar el telÃ©fono, debe validar nuevamente
-   DUI sin espacios en formato: 12345678-9

**QuÃ© ocurre:**

1. Usuario rellena los 6 campos
2. ValidaciÃ³n en tiempo real marca campos
3. Cuando todos son vÃ¡lidos: BotÃ³n "Continuar" se habilita
4. Usuario presiona "Continuar"
5. Los datos se guardan en state de Step 1

**Errores comunes:**

| Error                  | Causa                  | SoluciÃ³n                    |
| ---------------------- | ---------------------- | --------------------------- |
| DUI invÃ¡lido           | Formato incorrecto     | Usar formato: 12345678-9    |
| Fecha muy antigua      | Mayor de 100 aÃ±os      | Revisar fecha de nacimiento |
| TelÃ©fono no verificado | No pasÃ³ validaciÃ³n OTP | Validar nÃºmero nuevamente   |
| Nombre con nÃºmeros     | CarÃ¡cter invÃ¡lido      | Usar solo letras            |

---

#### **Paso 2: DirecciÃ³n (Step 2)**

**QuÃ© necesitamos:**

| Campo         | Tipo      | ValidaciÃ³n              | Obligatorio |
| ------------- | --------- | ----------------------- | ----------- |
| Departamento  | SelecciÃ³n | Cargado desde API       | âœ… SÃ­       |
| Distrito      | SelecciÃ³n | Depende de departamento | âœ… SÃ­       |
| Municipio     | SelecciÃ³n | Depende de distrito     | âœ… SÃ­       |
| Calle         | Texto     | MÃ­nimo 3 caracteres     | âœ… SÃ­       |
| NÃºmero Casa   | Texto     | NÃºmero o nÃºmero + letra | âœ… SÃ­       |
| Barrio/Sector | Texto     | MÃ­nimo 3 caracteres     | âœ… SÃ­       |

**Flujo de selecciÃ³n en cascada:**

```
Departamento (ej: San Salvador)
    â†“ Carga Distritos
Distrito (ej: San Salvador Centro)
    â†“ Carga Municipio
Municipio (ej: San Salvador)
```

**Validaciones geogrÃ¡ficas:**

-   Solo se pueden seleccionar departamentos de El Salvador
-   Los distritos cambian segÃºn el departamento seleccionado
-   El municipio es determinado automÃ¡ticamente
-   No se permiten direcciones vacÃ­as

**QuÃ© ocurre:**

1. Pantalla carga departamentos automÃ¡ticamente
2. Usuario selecciona departamento
3. Se cargan distritos del departamento
4. Usuario selecciona distrito
5. Se determina municipio automÃ¡ticamente
6. Usuario rellena calle, nÃºmero y barrio
7. Cuando todos son vÃ¡lidos: BotÃ³n "Continuar" se habilita

**Errores comunes:**

| Error                  | Causa                  | SoluciÃ³n                  |
| ---------------------- | ---------------------- | ------------------------- |
| No carga departamentos | Error de conexiÃ³n      | Reintentar con WiFi       |
| Departamento bloqueado | RestricciÃ³n geogrÃ¡fica | ContÃ¡ctanos               |
| Calle rechazada        | Caracteres invÃ¡lidos   | Evitar caracteres especia |

---

#### **Paso 3: InformaciÃ³n Laboral/Financiera (Step 3)**

**QuÃ© necesitamos:**

| Campo                 | Tipo      | ValidaciÃ³n                         | Obligatorio |
| --------------------- | --------- | ---------------------------------- | ----------- |
| Tipo de Empleo        | SelecciÃ³n | Cargado desde API                  | âœ… SÃ­       |
| Nombre Empresa        | Texto     | MÃ­nimo 3 caracteres                | âœ… SÃ­       |
| TelÃ©fono Empresa      | TelÃ©fono  | Formato vÃ¡lido                     | âœ… SÃ­       |
| Ingreso Neto          | SelecciÃ³n | Rango de ingresos (ej: $500-$1000) | âœ… SÃ­       |
| Ingreso Adicional     | Cantidad  | 0 a 99,999                         | âŒ Opcional |
| Otras Deudas          | Cantidad  | 0 a 99,999                         | âŒ Opcional |
| PropÃ³sito PrÃ©stamo    | SelecciÃ³n | Cargado desde API                  | âœ… SÃ­       |
| DescripciÃ³n PropÃ³sito | Texto     | MÃ­nimo 10 caracteres               | âœ… SÃ­       |

**Opciones de ingreso neto:**

-   Menos de $500
-   $500 - $1,000
-   $1,000 - $2,000
-   $2,000 - $5,000
-   MÃ¡s de $5,000

**PropÃ³sitos de prÃ©stamo:**

-   Emergencia mÃ©dica
-   EducaciÃ³n
-   ReparaciÃ³n del hogar
-   Negocio
-   Otro

**Validaciones especiales:**

-   Si Ingreso Neto + Ingreso Adicional < $200: Advertencia
-   Si Otras Deudas > Ingreso: Advertencia
-   DescripciÃ³n debe ser mayor a 10 caracteres

**QuÃ© ocurre:**

1. Pantalla carga tipos de empleo y propÃ³sitos automÃ¡ticamente
2. Usuario selecciona tipo de empleo
3. Usuario rellena datos de empresa
4. Usuario selecciona ingreso neto
5. Usuario rellena (opcionalmente) ingreso adicional y deudas
6. Usuario selecciona propÃ³sito
7. Usuario describe propÃ³sito del prÃ©stamo
8. Sistema valida todo
9. BotÃ³n "Continuar" se habilita

**Errores comunes:**

| Error                 | Causa                  | SoluciÃ³n            |
| --------------------- | ---------------------- | ------------------- |
| Ingreso muy bajo      | Menos de $200          | Agregar ingresos    |
| Empresa no existe     | Nombre/telÃ©fono falso  | Verificar datos     |
| Deudas muy altas      | Mayor que ingresos     | Revisar deudas      |
| DescripciÃ³n muy corta | Menos de 10 caracteres | Ampliar descripciÃ³n |

---

#### **Paso 4: Referencias Personales (Step 4)**

**QuÃ© necesitamos:**

Dos referencias (Familiar y Amigo):

| Campo          | Tipo     | ValidaciÃ³n          | Obligatorio |
| -------------- | -------- | ------------------- | ----------- |
| Nombre Ref 1   | Texto    | MÃ­nimo 2 caracteres | âœ… SÃ­       |
| Apellido Ref 1 | Texto    | MÃ­nimo 2 caracteres | âœ… SÃ­       |
| TelÃ©fono Ref 1 | TelÃ©fono | Formato vÃ¡lido      | âœ… SÃ­       |
| Nombre Ref 2   | Texto    | MÃ­nimo 2 caracteres | âœ… SÃ­       |
| Apellido Ref 2 | Texto    | MÃ­nimo 2 caracteres | âœ… SÃ­       |
| TelÃ©fono Ref 2 | TelÃ©fono | Formato vÃ¡lido      | âœ… SÃ­       |

**Restricciones:**

-   No puede ser el mismo telÃ©fono para ambas referencias
-   No pueden ser nÃºmeros familiares (tuyo)
-   MÃ­nimo 2 referencias requeridas

**Validaciones especiales:**

-   El sistema puede validar si los nÃºmeros son vÃ¡lidos (rango vÃ¡lido de El Salvador)
-   Se almacenan para potencial contacto posterior

**QuÃ© ocurre:**

1. Usuario rellena datos de Referencia 1 (Familiar)
2. Usuario rellena datos de Referencia 2 (Amigo)
3. Sistema valida que ambas estÃ©n completas
4. Sistema valida que no sean iguales
5. BotÃ³n "Continuar" se habilita

**Errores comunes:**

| Error               | Causa                 | SoluciÃ³n               |
| ------------------- | --------------------- | ---------------------- |
| Referencias iguales | Mismo telÃ©fono        | Usar nÃºmeros distintos |
| Nombre muy corto    | Menos de 2 caracteres | Nombre completo        |
| TelÃ©fono invÃ¡lido   | Formato incorrecto    | Formato: +503 7777777  |

---

#### **Paso 5: VerificaciÃ³n de Identidad (Step 5)**

**QuÃ© necesitamos:**

3 imÃ¡genes (ya documentado en #15-carga-de-imagenes.md):

1. Frente del DUI
2. RevÃ©s del DUI
3. Selfie con DUI

**Validaciones:**

-   Todas las 3 imÃ¡genes son obligatorias
-   No se puede continuar sin las 3 imÃ¡genes cargadas exitosamente
-   Solo se aceptan JPEG y PNG
-   MÃ¡ximo 5MB por imagen

**Estado general:**

-   âœ… Frente cargado
-   âœ… RevÃ©s cargado
-   âœ… Selfie cargado
-   â†’ "Continuar" habilitado

**QuÃ© ocurre:**

1. Ver documentaciÃ³n de #15-carga-de-imagenes.md para detalles

---

#### **Paso 6: ConfirmaciÃ³n (Completion Screen)**

**QuÃ© se muestra:**

1. Resumen completo de datos ingresados
2. Monto final del prÃ©stamo
3. Plazo seleccionado
4. CÃ¡lculo de intereses
5. Fecha estimada de recepciÃ³n
6. TÃ©rminos y condiciones
7. BotÃ³n "Confirmar y Enviar"

**Antes de enviar, se verifica:**

-   âœ… Todos los pasos completados
-   âœ… Validaciones pasadas
-   âœ… ImÃ¡genes cargadas
-   âœ… Usuario confirma informaciÃ³n

**QuÃ© ocurre al presionar "Confirmar":**

1. Sistema recolecta datos de todos los pasos
2. Se construye el payload (FirstLoanRequest)
3. Se envÃ­a a `/client/request-first-loan`
4. Se muestra indicador de carga: â³ Procesando...
5. Si Ã©xito: Pantalla de confirmaciÃ³n final
6. Si error: Mensaje de error con opciÃ³n de reintentar

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ PatrÃ³n ArquitectÃ³nico

La solicitud de primer prÃ©stamo sigue una arquitectura **Feature-Based Multi-Step** con orquestaciÃ³n centralizada:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Presentation Layer (UI)                                    â”‚
â”‚                                                              â”‚
â”‚ â”œâ”€ FirstLoanWelcomeScreen          (Paso 0)                â”‚
â”‚ â”œâ”€ FirstLoanStepOneScreen          (Paso 1: Personal)      â”‚
â”‚ â”œâ”€ FirstLoanStepTwoScreen          (Paso 2: DirecciÃ³n)     â”‚
â”‚ â”œâ”€ FirstLoanStepThreeScreen        (Paso 3: Financiero)    â”‚
â”‚ â”œâ”€ FirstLoanStepFourScreen         (Paso 4: Referencias)   â”‚
â”‚ â”œâ”€ FirstLoanStepFiveScreen         (Paso 5: ImÃ¡genes)      â”‚
â”‚ â””â”€ FirstLoanCompletionScreen       (Paso 6: ConfirmaciÃ³n)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                          â”‚ (Riverpod Consumers)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State Mgmt    â”‚ â”‚ State Mgmt    â”‚ â”‚ State Mgmt      â”‚
â”‚               â”‚ â”‚               â”‚ â”‚                 â”‚
â”‚ Step1Notif.   â”‚ â”‚ Step2Notif.   â”‚ â”‚ Step3Notif. ... â”‚
â”‚ Step4Notif.   â”‚ â”‚ Step5Notif.   â”‚ â”‚ Request Notif.  â”‚
â”‚ Calculator    â”‚ â”‚ Geographic    â”‚ â”‚ LoanCalc Data   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Repository Layer                   â”‚
        â”‚                                    â”‚
        â”‚ FirstLoanRepository               â”‚
        â”‚ â”œâ”€ requestFirstLoan()             â”‚
        â”‚                                    â”‚
        â”‚ AdditionalDataRepository          â”‚
        â”‚ â”œâ”€ getAdditionalData()            â”‚
        â”‚                                    â”‚
        â”‚ GeographicRepository              â”‚
        â”‚ â”œâ”€ getDepartments()               â”‚
        â”‚ â””â”€ getDistricts()                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Data Layer (APIs & Services)       â”‚
        â”‚                                    â”‚
        â”‚ POST /client/request-first-loan   â”‚
        â”‚ GET  /client/additional-data      â”‚
        â”‚ GET  /client/geographic/...       â”‚
        â”‚ Bearer token authentication        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¦ GestiÃ³n de Estado con Riverpod

**Provider Structure:**

```dart
@Riverpod(keepAlive: true)
class FirstLoanStepOneNotifier extends _$FirstLoanStepOneNotifier {
  // Gerencia el estado del Paso 1
}

@Riverpod(keepAlive: true)
class FirstLoanStepTwoNotifier extends _$FirstLoanStepTwoNotifier {
  // Gerencia el estado del Paso 2
}

// ... Paso 3, 4, 5

@Riverpod(keepAlive: true)
class FirstLoanRequestNotifier extends _$FirstLoanRequestNotifier {
  // Orquestador: Valida todos los pasos y envÃ­a request
}
```

**Por quÃ© `keepAlive: true`?**

-   Los datos se preservan durante navegaciÃ³n
-   Si el usuario vuelve al paso anterior, los datos permanecen
-   Permite cancelar y retomar sin perder informaciÃ³n

### ğŸ”„ Flujo de Datos Completo

```
Usuario Ingresa Datos (Step 1)
        â†“
Step1Notifier.onNameChanged("Juan")
        â†“
state = state.copyWith(name: TextInput.dirty("Juan"))
        â†“
_updateValidation()  // Valida si nombre es vÃ¡lido
        â†“
isValid = true/false
        â†“
UI Re-renderiza con estado actualizado
        â†“
BotÃ³n "Continuar" se habilita/deshabilita
```

### ğŸ“ ValidaciÃ³n en Cascada

```
Usuario Presiona "Continuar"
        â†“
Step1 Valida:
â”œâ”€ Nombre: No vacÃ­o, no nÃºmeros âœ“
â”œâ”€ Apellido: No vacÃ­o, no nÃºmeros âœ“
â”œâ”€ GÃ©nero: Seleccionado âœ“
â”œâ”€ Fecha Nac.: Mayor de 18 aÃ±os âœ“
â”œâ”€ DUI: Formato correcto âœ“
â””â”€ TelÃ©fono: Validado anteriormente âœ“
        â†“
Si alguno falla: Mostrar error âŒ
Si todos pasan: Guardar datos âœ…
        â†“
Navegar a Step 2
```

### ğŸ¯ PatrÃ³n de ConstrucciÃ³n de Payload

```dart
FirstLoanRequest _buildFirstLoanRequest() {
  final step1 = ref.read(firstLoanStepOneProvider);
  final step2 = ref.read(firstLoanStepTwoProvider);
  final step3 = ref.read(firstLoanStepThreeProvider);
  final step4 = ref.read(firstLoanStepFourProvider);
  final step5 = ref.read(firstLoanStepFiveProvider);
  final calculator = ref.read(loanCalculatorProvider);

  return FirstLoanRequest(
    // Del calculador
    amount: calculator.selectedAmount.toDouble(),
    deadline: calculator.selectedDays,
    promoCode: calculator.appliedPromoCode?.code ?? "",

    // Del paso 1: Datos personales
    name: step1.name.value,
    surname: step1.surname.value,
    gender: step1.gender.value,
    birthDate: step1.birthDate.value,
    dni: step1.dni.value,
    phoneNumber: step1.phoneNumber.value,

    // Del paso 2: DirecciÃ³n
    street: step2.street.value,
    streetNumber: step2.streetNumber.value,
    suburb: step2.suburb.value,
    municipality: step2.selectedMunicipality?.name ?? "",
    department: step2.selectedDepartment?.name ?? "",

    // Del paso 3: InformaciÃ³n laboral/financiera
    jobType: step3.jobType.value,
    companyName: step3.companyName.value,
    companyPhone: step3.companyPhone.value,
    netIncome: step3.selectedNetIncome?.value.toDouble() ?? 0.0,
    additionalIncome: step3.additionalIncome.doubleValue,
    otherLoan: step3.otherLoan.doubleValue,
    purpose: step3.purpose.value,
    purposeDescription: step3.purposeDescription.value,

    // Del paso 4: Referencias
    familiarName: step4.familiarName.value,
    familiarSurname: step4.familiarSurname.value,
    familiarPhone: step4.familiarPhone.value,
    friendName: step4.friendName.value,
    friendSurname: step4.friendSurname.value,
    friendPhone: step4.friendPhone.value,

    // Del paso 5: ImÃ¡genes
    imageFrontIdCard: step5.frontIdCard.imageUrl,
    imageBackIdCard: step5.backIdCard.imageUrl,
    imageSelfie: step5.selfie.imageUrl,
  );
}
```

---

## Flujo Completo de Datos

### ğŸ”„ Secuencia Completa: De Welcome a Ã‰xito

```
INICIO: Usuario presiona "Solicitar PrÃ©stamo"
    â†“
â”Œâ”€ WELCOME SCREEN
â”‚  â”œâ”€ Cargar datos del calculador
â”‚  â”œâ”€ Mostrar monto y plazo preseleccionados
â”‚  â””â”€ Presiona "Comencemos"
â”‚
â”œâ”€ STEP 1: INFORMACIÃ“N PERSONAL
â”‚  â”œâ”€ Usuario ingresa: Nombre, Apellido, GÃ©nero, Fecha Nac., DUI
â”‚  â”œâ”€ TelÃ©fono: Pre-llenado y validado
â”‚  â”œâ”€ Validaciones en tiempo real
â”‚  â””â”€ Presiona "Continuar" â†’ Datos guardados
â”‚
â”œâ”€ STEP 2: DIRECCIÃ“N
â”‚  â”œâ”€ Cargar departamentos
â”‚  â”œâ”€ Usuario selecciona departamento
â”‚  â”œâ”€ Sistema carga distritos
â”‚  â”œâ”€ Usuario selecciona distrito
â”‚  â”œâ”€ Sistema determina municipio
â”‚  â”œâ”€ Usuario ingresa: Calle, NÃºmero, Barrio
â”‚  â””â”€ Presiona "Continuar" â†’ Datos guardados
â”‚
â”œâ”€ STEP 3: INFORMACIÃ“N LABORAL/FINANCIERA
â”‚  â”œâ”€ Cargar opciones de: Empleo, PropÃ³sito, Ingresos
â”‚  â”œâ”€ Usuario ingresa todos los campos
â”‚  â”œâ”€ Validar que ingresos sean razonables
â”‚  â””â”€ Presiona "Continuar" â†’ Datos guardados
â”‚
â”œâ”€ STEP 4: REFERENCIAS PERSONALES
â”‚  â”œâ”€ Usuario ingresa Referencia 1: Nombre, Apellido, TelÃ©fono
â”‚  â”œâ”€ Usuario ingresa Referencia 2: Nombre, Apellido, TelÃ©fono
â”‚  â”œâ”€ Validar que referencias sean diferentes
â”‚  â””â”€ Presiona "Continuar" â†’ Datos guardados
â”‚
â”œâ”€ STEP 5: VERIFICACIÃ“N DE IDENTIDAD
â”‚  â”œâ”€ Capturar Frente DUI (con cÃ¡mara, comprime a 50%)
â”‚  â”œâ”€ Upload Frente DUI (Multipart Form)
â”‚  â”œâ”€ Mostrar âœ… si Ã©xito
â”‚  â”‚
â”‚  â”œâ”€ Capturar RevÃ©s DUI
â”‚  â”œâ”€ Upload RevÃ©s DUI
â”‚  â”œâ”€ Mostrar âœ… si Ã©xito
â”‚  â”‚
â”‚  â”œâ”€ Capturar Selfie con DUI
â”‚  â”œâ”€ Upload Selfie
â”‚  â”œâ”€ Mostrar âœ… si Ã©xito
â”‚  â”‚
â”‚  â””â”€ Presiona "Continuar" â†’ Datos guardados
â”‚
â”œâ”€ COMPLETION SCREEN (Resumen)
â”‚  â”œâ”€ Mostrar resumen de TODOS los datos
â”‚  â”œâ”€ Mostrar monto final
â”‚  â”œâ”€ Mostrar plazo
â”‚  â”œâ”€ Mostrar cÃ¡lculos de interÃ©s
â”‚  â”œâ”€ Usuario revisa todo
â”‚  â””â”€ Presiona "Confirmar y Enviar"
â”‚
â”œâ”€ VALIDACIÃ“N FINAL
â”‚  â”œâ”€ Verificar que todos los steps estÃ©n completos
â”‚  â”œâ”€ Verificar que todas las validaciones pasen
â”‚  â”œâ”€ Verificar que todas las imÃ¡genes estÃ©n cargadas
â”‚  â””â”€ Si TODO OK: Continuar, SI NO: Mostrar error
â”‚
â”œâ”€ CONSTRUCCIÃ“N DE PAYLOAD
â”‚  â””â”€ Recolectar datos de todos los pasos â†’ FirstLoanRequest
â”‚
â”œâ”€ ENVÃO A API
â”‚  â”œâ”€ POST /client/request-first-loan
â”‚  â”œâ”€ Body: FirstLoanRequest.toJson()
â”‚  â”œâ”€ Headers: Authorization: Bearer <token>
â”‚  â””â”€ Response: FirstLoanResponse { message, requestId, ... }
â”‚
â””â”€ FIN: PANTALLA DE Ã‰XITO
   â”œâ”€ "Tu solicitud fue enviada exitosamente"
   â”œâ”€ Mostrar ID de solicitud
   â”œâ”€ Mostrar fecha de revisiÃ³n esperada
   â””â”€ BotÃ³n "Volver al Inicio"
```

---

## Componentes y Pasos

### ğŸ“¦ State Models

#### FirstLoanStepOneState

```dart
@freezed
abstract class FirstLoanStepOneState with _$FirstLoanStepOneState {
  const factory FirstLoanStepOneState({
    @Default(TextInput.pure()) TextInput name,
    @Default(TextInput.pure()) TextInput surname,
    @Default(GenderInput.pure()) GenderInput gender,
    @Default(BirthDateInput.pure()) BirthDateInput birthDate,
    @Default(DuiInput.pure()) DuiInput dni,
    @Default(PhoneInput.pure()) PhoneInput phoneNumber,
    @Default(false) bool isPhoneVerified,  // Importa: Debe estar verificado
    @Default(false) bool isValid,
  }) = _FirstLoanStepOneState;
}
```

#### FirstLoanStepTwoState

```dart
@freezed
abstract class FirstLoanStepTwoState with _$FirstLoanStepTwoState {
  const factory FirstLoanStepTwoState({
    @Default(TextInput.pure()) TextInput street,
    @Default(TextInput.pure()) TextInput streetNumber,
    @Default(TextInput.pure()) TextInput suburb,
    DepartmentEntity? selectedDepartment,
    DistrictEntity? selectedDistrict,
    MunicipalityEntity? selectedMunicipality,
    @Default([]) List<DepartmentEntity> departments,
    @Default([]) List<DistrictEntity> districts,
    @Default(false) bool isLoadingDepartments,
    @Default(false) bool isLoadingDistricts,
    @Default(false) bool isLoadingMunicipality,
    @Default(false) bool isValid,
  }) = _FirstLoanStepTwoState;
}
```

#### FirstLoanRequestState

```dart
@freezed
abstract class FirstLoanRequestState with _$FirstLoanRequestState {
  const factory FirstLoanRequestState({
    @Default(RequestStatus.idle) RequestStatus status,  // idle, loading, success, error
    @Default('') String errorMessage,
    FirstLoanResponse? response,
  }) = _FirstLoanRequestState;
}

enum RequestStatus { idle, loading, success, error }
```

### ğŸ”§ Notifiers

#### FirstLoanRequestNotifier (Orquestador Principal)

```dart
@Riverpod(keepAlive: true)
class FirstLoanRequestNotifier extends _$FirstLoanRequestNotifier {
  @override
  FirstLoanRequestState build() {
    return const FirstLoanRequestState();
  }

  Future<void> sendFirstLoanRequest() async {
    try {
      // 1. Validar todos los pasos
      if (!_validateAllSteps()) {
        state = state.copyWith(
          status: RequestStatus.error,
          errorMessage: 'Por favor complete todos los pasos',
        );
        return;
      }

      // 2. Actualizar estado a loading
      state = state.copyWith(status: RequestStatus.loading);

      // 3. Construir payload
      final request = _buildFirstLoanRequest();

      // 4. Enviar a API
      final repository = ref.read(firstLoanRepositoryProvider);
      final response = await repository.requestFirstLoan(request);

      // 5. Guardar respuesta
      state = state.copyWith(
        status: RequestStatus.success,
        response: response,
      );
    } catch (e, stackTrace) {
      LoggingService.error(
        'Failed to send first loan request',
        tag: 'FIRST_LOAN_REQUEST',
        error: e,
        stackTrace: stackTrace,
      );

      state = state.copyWith(
        status: RequestStatus.error,
        errorMessage: e.toString(),
      );
    }
  }

  bool _validateAllSteps() {
    final step1 = ref.read(firstLoanStepOneProvider);
    final step2 = ref.read(firstLoanStepTwoProvider);
    final step3 = ref.read(firstLoanStepThreeProvider);
    final step4 = ref.read(firstLoanStepFourProvider);
    final step5 = ref.read(firstLoanStepFiveProvider);
    final calculator = ref.read(loanCalculatorProvider);

    return step1.isValid &&
        step2.isValid &&
        step3.isValid &&
        step4.isValid &&
        step5.isValid &&
        calculator.selectedAmount > 0 &&
        calculator.selectedDays > 0;
  }
}
```

---

## APIs Utilizadas

### Endpoint Principal de Solicitud

#### `POST /client/request-first-loan`

**DescripciÃ³n**: EnvÃ­a la solicitud completa de primer prÃ©stamo al servidor.

**Headers Requeridos**:

```
Content-Type: application/json
Authorization: Bearer <token_del_usuario>
Language: es
```

**Request Body (FirstLoanRequest)**:

```json
{
    "amount": 500,
    "deadline": 30,
    "promoCode": "BIENVENIDA2024",
    "name": "Juan",
    "surname": "PÃ©rez",
    "gender": "M",
    "birthDate": "1990-05-15",
    "dni": "12345678-9",
    "phoneNumber": "+503 7777-7777",
    "street": "Avenida Central",
    "streetNumber": "123A",
    "suburb": "Barrio San Benito",
    "municipality": "San Salvador",
    "department": "San Salvador",
    "district": "San Salvador Centro",
    "jobType": "Empleado",
    "companyName": "TechCorp SRL",
    "companyPhone": "+503 2111-1111",
    "netIncome": 800.0,
    "additionalIncome": 200.0,
    "otherLoan": 0.0,
    "purpose": "Emergencia",
    "purposeDescription": "Necesito reparar mi vehÃ­culo para llegar al trabajo",
    "familiarName": "Carlos",
    "familiarSurname": "PÃ©rez",
    "familiarPhone": "+503 7888-8888",
    "friendName": "Roberto",
    "friendSurname": "LÃ³pez",
    "friendPhone": "+503 7999-9999",
    "imageFrontIdCard": "https://storage.example.com/images/uuid/frontIdCard.jpg",
    "imageBackIdCard": "https://storage.example.com/images/uuid/backIdCard.jpg",
    "imageSelfie": "https://storage.example.com/images/uuid/selfie.jpg"
}
```

**Response Exitosa (200 OK)**:

```json
{
    "status": 200,
    "message": "Solicitud enviada exitosamente",
    "data": {
        "requestId": "REQ-20241027-001234",
        "approvalDate": "2024-10-29",
        "processingTime": "48 horas"
    }
}
```

**Respuestas de Error**:

| CÃ³digo | SituaciÃ³n           | Mensaje                                     |
| ------ | ------------------- | ------------------------------------------- |
| 400    | ValidaciÃ³n fallida  | "Campo [nombre] es invÃ¡lido"                |
| 401    | No autenticado      | "Usuario no autenticado"                    |
| 408    | Timeout             | "Tiempo de conexiÃ³n agotado"                |
| 422    | Solicitud rechazada | "Solicitud no cumple requisitos"            |
| 429    | Rate limiting       | "Demasiadas solicitudes, intenta mÃ¡s tarde" |
| 500    | Error servidor      | "Error interno del servidor"                |

### APIs Secundarias

#### `GET /client/additional-data`

**DescripciÃ³n**: Obtiene listas dinÃ¡micas para el Paso 3.

**Response**:

```json
{
    "jobTypes": ["Empleado", "Independiente", "Desempleado"],
    "purposes": ["Emergencia", "EducaciÃ³n", "Negocio"],
    "netIncomes": [
        { "value": 500, "label": "Menos de $500" },
        { "value": 1000, "label": "$500 - $1,000" }
    ]
}
```

#### `GET /client/geographic/departments`

**DescripciÃ³n**: Obtiene departamentos de El Salvador.

**Response**:

```json
{
    "data": [
        { "id": 1, "name": "San Salvador" },
        { "id": 2, "name": "La Libertad" }
    ]
}
```

---

## Manejo de Errores

### ğŸš¨ Estrategia de Errores

Errores se capturan en mÃºltiples niveles:

#### Nivel 1: ValidaciÃ³n en UI (Inmediata)

```dart
// Campo Nombre: No puede estar vacÃ­o
if (state.name.value.isEmpty) {
  return "El nombre es requerido";
}

// Campo DUI: Debe tener formato correcto
if (!RegExp(r'^\d{8}-\d$').hasMatch(state.dni.value)) {
  return "DUI debe tener formato: 12345678-9";
}
```

#### Nivel 2: ValidaciÃ³n en Notifier (Pre-envÃ­o)

```dart
bool _validateAllSteps() {
  final step1 = ref.read(firstLoanStepOneProvider);

  // Â¿Paso 1 vÃ¡lido?
  if (!step1.isValid) {
    state = state.copyWith(
      status: RequestStatus.error,
      errorMessage: 'Por favor complete el Paso 1',
    );
    return false;
  }

  return true;
}
```

#### Nivel 3: ValidaciÃ³n en Repository (API)

```dart
try {
  final response = await _httpClient.post(
    '/client/request-first-loan',
    data: request.toJson(),
  );
  return FirstLoanResponse.fromJson(response.data);
} on DioException catch (e) {
  if (e.response?.statusCode == 422) {
    throw FirstLoanException(
      message: 'Datos de solicitud invÃ¡lidos',
      statusCode: 422,
      type: FirstLoanExceptionType.validation,
      data: e.response?.data,
    );
  }
  // ... manejar otros errores
}
```

### ğŸ“Š Ãrbol de DecisiÃ³n de Errores

```
Error en EnvÃ­o
    â”‚
    â”œâ”€ 400: ValidaciÃ³n
    â”‚   â””â”€ "Campo invÃ¡lido: [detalles]"
    â”‚       â†’ Resaltar campo, permitir ediciÃ³n
    â”‚
    â”œâ”€ 401: AutenticaciÃ³n
    â”‚   â””â”€ "Tu sesiÃ³n expirÃ³"
    â”‚       â†’ Redirigir a login
    â”‚
    â”œâ”€ 408: Timeout
    â”‚   â””â”€ "ConexiÃ³n lenta, intenta de nuevo"
    â”‚       â†’ BotÃ³n "Reintentar"
    â”‚
    â”œâ”€ 422: Rechazado
    â”‚   â”œâ”€ Edad no cumple (< 18)
    â”‚   â”‚   â†’ "Debes ser mayor de 18 aÃ±os"
    â”‚   â”œâ”€ UbicaciÃ³n no permitida
    â”‚   â”‚   â†’ "No podemos prestar en tu Ã¡rea"
    â”‚   â””â”€ Criterios no cumplidos
    â”‚       â†’ "No cumples requisitos actualmente"
    â”‚
    â”œâ”€ 429: Rate Limit
    â”‚   â””â”€ "Demasiadas solicitudes"
    â”‚       â†’ Mostrar tiempo de espera
    â”‚
    â””â”€ 5xx: Servidor
        â””â”€ "Error del servidor, intenta mÃ¡s tarde"
            â†’ Reintentar con backoff exponencial
```

### ğŸ”„ Estrategia de Reintentos

**AutomÃ¡tico:**

-   Red: 3 intentos con backoff exponencial (1s, 2s, 4s)
-   Timeout: 1 reintento automÃ¡tico despuÃ©s de 5 segundos

**Manual:**

-   Usuario puede presionar "Reintentar"
-   Se limpia el estado de error
-   Se reintenta el Ãºltimo paso fallido

---

## Validaciones

### ğŸ“‹ Validaciones por Paso

#### Paso 1: InformaciÃ³n Personal

```dart
class TextInput {
  final String value;

  bool get isValid {
    // Nombre: 2-50 caracteres, solo letras
    if (fieldName == 'name') {
      return value.length >= 2 &&
             value.length <= 50 &&
             RegExp(r'^[a-zÃ¡Ã©Ã­Ã³ÃºÃ±\s]+$', caseSensitive: false)
               .hasMatch(value);
    }
    // ... mÃ¡s validaciones
  }
}

class DuiInput {
  bool get isValid {
    // Formato: 12345678-9
    return RegExp(r'^\d{8}-\d$').hasMatch(value) &&
           _isValidChecksum(value);
  }

  bool _isValidChecksum(String dui) {
    // Validar dÃ­gito verificador segÃºn algoritmo DUI El Salvador
    // ...
  }
}
```

#### Paso 2: DirecciÃ³n

```dart
// Cascada de dependencias
- Departamento: Obligatorio
  â†’ Carga distritos
- Distrito: Obligatorio
  â†’ Carga municipios
- Municipio: AutomÃ¡tico (determinado por distrito)
- Calle: 3-100 caracteres
- NÃºmero: 1-10 caracteres
- Barrio: 3-50 caracteres
```

#### Paso 3: InformaciÃ³n Laboral

```dart
- Tipo de Empleo: Obligatorio
- Nombre Empresa: 3-100 caracteres
- TelÃ©fono Empresa: Formato vÃ¡lido
- Ingreso Neto: SelecciÃ³n obligatoria
- Ingreso Adicional: 0 - 99,999
- Otras Deudas: 0 - 99,999
- PropÃ³sito: Obligatorio
- DescripciÃ³n: 10-500 caracteres

Regla de negocio:
  Ingreso Total = Ingreso Neto + Ingreso Adicional
  Monto MÃ¡ximo PrÃ©stamo = Ingreso Total * 0.3
```

#### Paso 4: Referencias

```dart
- Referencia 1 (Familiar):
  - Nombre: 2-50 caracteres
  - Apellido: 2-50 caracteres
  - TelÃ©fono: Formato vÃ¡lido

- Referencia 2 (Amigo):
  - Nombre: 2-50 caracteres
  - Apellido: 2-50 caracteres
  - TelÃ©fono: Formato vÃ¡lido

Regla:
  Los telÃ©fonos deben ser distintos (no iguales entre sÃ­ ni al usuario)
```

#### Paso 5: ImÃ¡genes

```dart
- Frente DUI:
  - Obligatorio: SÃ­
  - Tipos: JPEG, PNG
  - TamaÃ±o: < 5MB
  - ResoluciÃ³n: > 640x480

- RevÃ©s DUI:
  - Obligatorio: SÃ­
  - Tipos: JPEG, PNG
  - TamaÃ±o: < 5MB
  - ResoluciÃ³n: > 640x480

- Selfie:
  - Obligatorio: SÃ­
  - Tipos: JPEG, PNG
  - TamaÃ±o: < 5MB
  - Debe mostrar cara + DUI
```

---

## Testing

### ğŸ§ª Estrategia de Testing

#### 1. Unit Tests - Validaciones

```dart
group('FirstLoanStepOneState Validations', () {
  test('Nombre vÃ¡lido debe aceptar', () {
    expect(
      TextInput.dirty('Juan').isValid,
      isTrue,
    );
  });

  test('Nombre con nÃºmeros debe rechazar', () {
    expect(
      TextInput.dirty('Juan123').isValid,
      isFalse,
    );
  });

  test('DUI con formato correcto debe aceptar', () {
    expect(
      DuiInput.dirty('12345678-9').isValid,
      isTrue,
    );
  });

  test('DUI con formato incorrecto debe rechazar', () {
    expect(
      DuiInput.dirty('12345678').isValid,
      isFalse,
    );
  });
});
```

#### 2. State Management Tests

```dart
group('FirstLoanRequestNotifier', () {
  late ProviderContainer container;
  late MockFirstLoanRepository mockRepository;

  setUp(() {
    mockRepository = MockFirstLoanRepository();
    container = ProviderContainer(
      overrides: [
        firstLoanRepositoryProvider.overrideWithValue(mockRepository),
      ],
    );
  });

  test('sendFirstLoanRequest updates status to loading', () {
    final notifier = container.read(firstLoanRequestProvider.notifier);

    notifier.sendFirstLoanRequest();

    final state = container.read(firstLoanRequestProvider);
    expect(state.status, equals(RequestStatus.loading));
  });

  test('sendFirstLoanRequest validates all steps', () async {
    // Setup: Steps incompletos

    final notifier = container.read(firstLoanRequestProvider.notifier);
    await notifier.sendFirstLoanRequest();

    final state = container.read(firstLoanRequestProvider);
    expect(state.status, equals(RequestStatus.error));
    expect(state.errorMessage, contains('complete'));
  });

  test('sendFirstLoanRequest sends correct payload', () async {
    // Setup: Steps completos

    when(mockRepository.requestFirstLoan(any))
      .thenAnswer((_) async => FirstLoanResponse(...));

    final notifier = container.read(firstLoanRequestProvider.notifier);
    await notifier.sendFirstLoanRequest();

    verify(
      mockRepository.requestFirstLoan(
        argThat(
          isA<FirstLoanRequest>()
            .having((r) => r.name, 'name', 'Juan')
            .having((r) => r.surname, 'surname', 'PÃ©rez'),
        ),
      ),
    ).called(1);
  });
});
```

#### 3. Widget Tests

```dart
group('FirstLoanStepOneScreen', () {
  testWidgets('displays all required fields', (tester) async {
    await tester.pumpWidget(
      ProviderScope(
        container: testContainer,
        child: const MaterialApp(
          home: FirstLoanStepOneScreen(),
        ),
      ),
    );

    expect(find.byType(TextFormField), findsWidgets);
    expect(find.text('Nombre'), findsOneWidget);
    expect(find.text('Apellido'), findsOneWidget);
    expect(find.text('GÃ©nero'), findsOneWidget);
    expect(find.text('Fecha de Nacimiento'), findsOneWidget);
    expect(find.text('DUI'), findsOneWidget);
  });

  testWidgets('continue button disabled when incomplete', (tester) async {
    await tester.pumpWidget(/* ... */);

    final continueButton = find.byType(ElevatedButton);
    expect(
      tester.widget<ElevatedButton>(continueButton).onPressed,
      isNull,  // Deshabilitado
    );
  });

  testWidgets('continue button enabled when complete', (tester) async {
    // Fill all fields
    await tester.enterText(find.byType(TextFormField).at(0), 'Juan');
    // ... llenar otros campos

    await tester.pumpAndSettle();

    final continueButton = find.byType(ElevatedButton);
    expect(
      tester.widget<ElevatedButton>(continueButton).onPressed,
      isNotNull,  // Habilitado
    );
  });

  testWidgets('shows error on invalid DUI', (tester) async {
    await tester.pumpWidget(/* ... */);

    await tester.enterText(
      find.byType(TextFormField).at(4),  // DUI field
      '123',  // InvÃ¡lido
    );

    await tester.pumpAndSettle();

    expect(find.text('DUI invÃ¡lido'), findsOneWidget);
  });
});
```

---

## Seguridad

### ğŸ” Consideraciones Importantes

#### 1. AutenticaciÃ³n y AutorizaciÃ³n

**En cada peticiÃ³n:**

```dart
final response = await _httpClient.post(
  '/client/request-first-loan',
  data: request.toJson(),
  options: Options(
    headers: {
      'Authorization': 'Bearer $token',  // Token Ãºnico del usuario
      'Content-Type': 'application/json',
    },
  ),
);
```

**Validaciones servidor:**

-   âœ… Token vÃ¡lido y no expirado
-   âœ… Usuario existe y estÃ¡ activo
-   âœ… Usuario no tiene otra solicitud en progreso

#### 2. ValidaciÃ³n de Datos

**Cliente (Validaciones iniciales):**

-   Formatos correctos (email, telÃ©fono, DUI)
-   Rangos vÃ¡lidos (edad, montos)
-   Caracteres permitidos

**Servidor (Validaciones definitivas):**

-   Integridad referencial
-   Duplicados (DNI, email, telÃ©fono)
-   Reglas de negocio (edad, capacidad de pago)
-   DetecciÃ³n de fraude

#### 3. ProtecciÃ³n de ImÃ¡genes

**En trÃ¡nsito:**

-   HTTPS obligatorio (TLS 1.2+)
-   FormData multipart encriptado
-   Urls firmadas con expiraciÃ³n

**En servidor:**

-   Almacenamiento en S3/Cloud Storage privado
-   EncriptaciÃ³n en reposo
-   Acceso mediante IAM roles
-   Logs de acceso

**En dispositivo:**

-   No se guardan archivos permanentemente
-   Se eliminan tras envÃ­o exitoso
-   Permiso de cÃ¡mara solicitado en tiempo de ejecuciÃ³n

#### 4. Rate Limiting

**ProtecciÃ³n contra abuso:**

```
- MÃ¡ximo 5 solicitudes por usuario en 24 horas
- MÃ¡ximo 100 solicitudes por IP en 1 hora
- Retraso progresivo tras fallos (backoff exponencial)
```

#### 5. Cumplimiento Normativo

-   **GDPR**: Derecho al olvido (datos eliminados tras 90 dÃ­as si se rechaza)
-   **CCPA**: Derecho a descargar datos personales
-   **KYC**: VerificaciÃ³n Know Your Customer
-   **AML**: Anti Money Laundering checks
-   **Regulaciones Locales**: Compliance con leyes de El Salvador

#### 6. Integridad de Datos

**Verificaciones:**

-   Checksums en requests
-   Signatures en responses
-   Versionamiento de API
-   Logs inmutables de auditorÃ­a

---

## ğŸ“ Resumen de Capas

| Capa           | Componente                     | Responsabilidad             |
| -------------- | ------------------------------ | --------------------------- |
| **UI**         | FirstLoanStepXScreen           | Mostrar UI, recopilar input |
| **State**      | FirstLoanStepXNotifier         | Validar, guardar estado     |
| **State**      | FirstLoanRequestNotifier       | Orquestar, enviar           |
| **Repository** | FirstLoanRepository            | HTTP POST request           |
| **Data**       | HttpClient                     | HTTP client                 |
| **Domain**     | FirstLoanRequest/FirstLoanStep | Modelos de datos            |

---

## ğŸš€ PrÃ³ximos Pasos

1. **AprobaciÃ³n automÃ¡tica**: Verificar documentos con IA
2. **DecisiÃ³n acelerada**: Respuesta en < 5 minutos
3. **Desembolso automÃ¡tico**: Transferencia directa a cuenta
4. **Seguimiento**: Notificaciones de estado real-time
5. **Refinanciamiento**: Pre-calificaciÃ³n para segundo prÃ©stamo
6. **Historiales**: Descargar PDF de solicitud

---

**VersiÃ³n**: 1.0
**Ãšltima actualizaciÃ³n**: Octubre 2024
**Autor**: Equipo de Desarrollo Pisto
**Estado**: ProducciÃ³n âœ…
