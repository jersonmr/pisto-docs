---
title: Flujo de ValidaciÃ³n de NÃºmero TelefÃ³nico
slug: validacion-de-numero-telefonico
tags: [auth, phone-number-verification, otp, flutter, riverpod, dio, formz]
description: Flujo de validaciÃ³n de nÃºmero telefÃ³nico. Incluye envÃ­o de cÃ³digo OTP, verificaciÃ³n del cÃ³digo y manejo de errores y estados del proceso.
---

## DescripciÃ³n General

La funcionalidad de **ValidaciÃ³n de NÃºmero TelefÃ³nico** es un componente crÃ­tico del proceso de solicitud del primer prÃ©stamo en Pisto. Esta funcionalidad implementa un sistema de verificaciÃ³n en dos pasos utilizando **OTP (One-Time Password)** enviado por SMS para validar que el nÃºmero telefÃ³nico ingresado por el usuario es autÃ©ntico y estÃ¡ bajo su control.

### CaracterÃ­sticas Principales

-   âœ… **EnvÃ­o de cÃ³digo OTP**: Sistema de dos pasos para verificaciÃ³n de telÃ©fono
-   âœ… **CÃ³digo por SMS**: EnvÃ­o automÃ¡tico de cÃ³digo de 6 dÃ­gitos al telÃ©fono
-   âœ… **Contador regresivo**: LÃ­mite de tiempo de 5 minutos para ingresar el cÃ³digo
-   âœ… **Auto-detecciÃ³n de SMS**: El campo puede auto-llenar con SMS entrantes
-   âœ… **ValidaciÃ³n de formato**: Valida formatos de telÃ©fono para El Salvador
-   âœ… **Manejo de errores especÃ­ficos**: Diferentes mensajes segÃºn el tipo de error
-   âœ… **Reintentos**: Permite solicitar nuevo cÃ³digo si expira el anterior
-   âœ… **IntegraciÃ³n con primer prÃ©stamo**: Requisito obligatorio del Paso 1

---

## GuÃ­a del Usuario

### ğŸ¯ Â¿Para quÃ© sirve?

La validaciÃ³n de nÃºmero telefÃ³nico asegura que:

-   **Eres quien dices ser**: Verificamos que es tu telÃ©fono
-   **Es accesible**: Podemos contactarte cuando sea necesario
-   **InformaciÃ³n correcta**: Aseguramos datos precisos en el sistema
-   **Seguridad**: Previene el uso de nÃºmeros telefÃ³nicos de terceros

### ğŸ“± Pasos para validar tu nÃºmero telefÃ³nico

#### Paso 1: Ingresar el nÃºmero telefÃ³nico

En el Paso 1 del flujo de solicitud:

-   Escribe tu nÃºmero telefÃ³nico personal
-   El formato puede ser local (8 dÃ­gitos) o internacional (+503 XXXX XXXX)
-   Ejemplos vÃ¡lidos: `7777-1234`, `+503 7777 1234`, `27771234`

#### Paso 2: Iniciar validaciÃ³n

-   Presiona el botÃ³n **"Validar telÃ©fono"** o continÃºa al siguiente paso
-   El sistema enviarÃ¡ un cÃ³digo OTP de **6 dÃ­gitos** a tu telÃ©fono
-   RecibirÃ¡s un SMS con el cÃ³digo
-   AparecerÃ¡ un modal/diÃ¡logo para ingresar el cÃ³digo

#### Paso 3: Ingresar el cÃ³digo OTP

En el modal de verificaciÃ³n:

-   Ingresa el cÃ³digo de 6 dÃ­gitos que recibiste por SMS
-   El cÃ³digo se puede escribir manualmente
-   O puede auto-llenarse si permites que el sistema detecte el SMS
-   Tienes **5 minutos** para ingresar el cÃ³digo

**Indicador de tiempo**: VerÃ¡s un contador regresivo mostrando el tiempo restante en formato MM:SS (minutos:segundos)

#### Paso 4: ConfirmaciÃ³n

-   Si el cÃ³digo es correcto: âœ… TelÃ©fono verificado
-   Si el cÃ³digo es incorrecto: âŒ Intenta de nuevo
-   Si se agota el tiempo: Solicita un nuevo cÃ³digo

### âš ï¸ Importante

-   **CÃ³digo Ãºnico**: Cada sesiÃ³n de validaciÃ³n genera un cÃ³digo diferente
-   **No reutilizable**: El cÃ³digo anterior expira tras enviar uno nuevo
-   **Tiempo limitado**: 5 minutos es el mÃ¡ximo para ingresar el cÃ³digo
-   **Reintentos**: Puedes solicitar hasta 3 cÃ³digos por telÃ©fono en 24 horas (lÃ­mite del servidor)
-   **SMS no llega**: Si no recibes el SMS:
    -   Verifica que el nÃºmero sea correcto
    -   Comprueba que tienes servicio SMS
    -   Solicita un nuevo cÃ³digo
-   **NÃºmero incorrecto**: Si ingresas un nÃºmero equivocado, deberÃ¡ ser validado nuevamente

---

## Arquitectura TÃ©cnica

### ğŸ—ï¸ PatrÃ³n de Arquitectura

La funcionalidad sigue una arquitectura **Feature-Based** con separaciÃ³n clara de responsabilidades:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Presentation Layer (UI)                     â”‚
â”‚  FirstLoanStepOneScreen                        â”‚
â”‚  + PhoneVerificationModal                      â”‚
â”‚  + OTP Input Field                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    State Management Layer                     â”‚
â”‚  PhoneValidationNotifier (Riverpod)           â”‚
â”‚  PhoneValidationState (Freezed)               â”‚
â”‚  FirstLoanStepOneProvider                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Repository Layer                           â”‚
â”‚  PhoneValidationRepository                    â”‚
â”‚  Manejo de errores                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Data Layer (API)                           â”‚
â”‚  HttpClient provider                          â”‚
â”‚  /client/validate-phone-step-1                â”‚
â”‚  /client/validate-phone-step-2                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ§© Estructura de Directorios

```
lib/features/first_loan/
â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ first_loan_request.dart           # Modelo de solicitud
â”‚   â””â”€â”€ first_loan_step.dart              # Enum de pasos
â”‚
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ first_loan_request.dart           # DTO de solicitud
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ phone_validation_provider.dart    # Notifier + State
â”‚   â”œâ”€â”€ first_loan_step_one_provider.dart # Step 1 especÃ­fico
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ first_loan_repository.dart        # Acceso a datos
â”‚
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ first_loan_step_one_screen.dart   # Pantalla del paso 1
â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â””â”€â”€ phone_verification_modal.dart # Modal de verificaciÃ³n
â”‚   â””â”€â”€ ...
â”‚
lib/shared/phone_validation/
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ phone_validation_repository.dart  # Repository compartido
â””â”€â”€ models/
    â”œâ”€â”€ phone_validation_request.dart
    â”œâ”€â”€ phone_validation_response.dart
    â”œâ”€â”€ phone_code_verification_request.dart
    â””â”€â”€ ...
```

### ğŸ”„ Flujo de IntegraciÃ³n

```
FirstLoanStepOne
      â†“
[User enters phone & proceeds]
      â†“
[Check if phone verified?]
      â†“
[NO] â†’ PhoneVerificationModal
         â†“
      validatePhone()
         â†“
      [OTP Code sent]
         â†“
      [User enters code]
         â†“
      verifyCode()
         â†“
      [Success/Error]
         â†“
      markPhoneAsVerified()
      â†“
[YES] â†’ Proceed to Step 2
```

---

## Flujo de Datos

### ğŸ”„ Flujo Principal: ValidaciÃ³n en Dos Pasos

#### Fase 1: EnvÃ­o del cÃ³digo OTP (validatePhone)

```
1. Usuario ingresa nÃºmero en FirstLoanStepOne
   â”‚
2. Sistema valida formato del telÃ©fono
   â”‚
   â””â”€> Â¿Formato vÃ¡lido?
       â”œâ”€> NO: Mostrar error de validaciÃ³n
       â””â”€> SI: Continuar
   â”‚
3. ref.read(phoneValidationProvider.notifier).validatePhone(phone)
   â”‚
   â”œâ”€> state.status = PhoneValidationStatus.sending
   â”‚
4. PhoneValidationRepository.validatePhoneStep1(phone)
   â”‚
   â”œâ”€> POST /client/validate-phone-step-1
   â”‚   â””â”€> { "phone": "+503XXXXXXXX" }
   â”‚
5. API responde con requestId
   â”‚
   â”œâ”€> Response: { "data": { "requestId": "abc123..." } }
   â”‚
6. state.status = PhoneValidationStatus.pendingVerification
   state.requestId = "abc123..."
   state.remainingSeconds = 300 (5 minutos)
   â”‚
7. Inicia contador regresivo (_startCountdown)
   â”‚
8. Mostrar PhoneVerificationModal al usuario
```

#### Fase 2: VerificaciÃ³n del cÃ³digo OTP (verifyCode)

```
1. Usuario ingresa cÃ³digo de 6 dÃ­gitos
   â”‚
   â””â”€> onPhoneCodeChanged("123456")
       â””â”€> state.verificationCode = "123456"
   â”‚
2. ValidaciÃ³n automÃ¡tica o presionar botÃ³n
   â”‚
3. ref.read(phoneValidationProvider.notifier).verifyCode("123456")
   â”‚
4. Validaciones previas:
   â”œâ”€> Â¿requestId existe?
   â”‚   â””â”€> NO: Error "No hay solicitud pendiente"
   â”‚
5. PhoneValidationRepository.validatePhoneStep2()
   â”‚
   â”œâ”€> POST /client/validate-phone-step-2
   â”‚   â””â”€> {
   â”‚        "requestId": "abc123...",
   â”‚        "phoneCode": "123456"
   â”‚      }
   â”‚
6. Â¿Respuesta exitosa (200)?
   â”‚
   â”œâ”€> SI:
   â”‚   â”œâ”€> _timer?.cancel()
   â”‚   â”œâ”€> state.status = PhoneValidationStatus.verified
   â”‚   â”œâ”€> Cerrar modal
   â”‚   â””â”€> markPhoneAsVerified()
   â”‚
   â””â”€> NO:
       â”œâ”€> state.status = PhoneValidationStatus.error
       â””â”€> Mostrar mensaje de error
```

#### Fase 3: ExpiraciÃ³n del cÃ³digo

```
_startCountdown() ejecuta cada segundo:
   â”‚
   â”œâ”€> Si remainingSeconds <= 0:
   â”‚   â”œâ”€> Detener timer
   â”‚   â”œâ”€> state.status = PhoneValidationStatus.expired
   â”‚   â”œâ”€> errorMessage = "El tiempo ha expirado"
   â”‚   â””â”€> Mostrar botÃ³n "Solicitar nuevo cÃ³digo"
   â”‚
   â””â”€> Si remainingSeconds > 0:
       â”œâ”€> Decrementar: remainingSeconds - 1
       â””â”€> Actualizar UI con nuevo tiempo
```

### ğŸ“Š Diagrama de Estados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PhoneValidationStatus States            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

unverified â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“                                              â”‚
[Usuario presiona "Validar"]                     â”‚
   â†“                                              â”‚
sending â”€â”€â”€â”€â”€â”€â”                                  â”‚
   â†“          â”‚ (API error)                      â”‚
   â†“          â”œâ”€â”€â†’ error                         â”‚
pendingVerification                              â”‚
   â†“ â†‘ â†‘                                         â”‚
   â”‚ â”‚ â””â”€â”€ [CÃ³digo incorrecto]                   â”‚
   â”‚ â”‚                                           â”‚
   â”‚ â””â”€â”€â”€â”€ [Reintentar]                         â”‚
   â”‚                                             â”‚
   â”œâ”€â”€â†’ expired (5 minutos sin cÃ³digo)           â”‚
   â”‚       â†“                                      â”‚
   â”‚       [Solicitar nuevo cÃ³digo]              â”‚
   â”‚       â†“                                      â”‚
   â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â†’ sending            â”‚       â”‚
   â”‚                                     â”‚       â”‚
   â””â”€â†’ verified (CÃ³digo correcto)       â”‚       â”‚
       â†“                                 â”‚       â”‚
   [Ã‰xito]                              â”‚       â”‚
                                         â”‚       â”‚
   cancelled â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   (Usuario cancela o se desmonta)
```

---

## Componentes

### ğŸ“¦ State Management

#### PhoneValidationState (Freezed)

Define el estado completo de la validaciÃ³n telefÃ³nica:

```dart
@freezed
abstract class PhoneValidationState with _$PhoneValidationState {
  const factory PhoneValidationState({
    @Default(PhoneValidationStatus.unverified)
    PhoneValidationStatus status,
    String? requestId,           // ID de la solicitud de validaciÃ³n
    String? phone,               // NÃºmero telefÃ³nico en validaciÃ³n
    String? errorMessage,        // Mensaje de error
    @Default(300) int remainingSeconds, // Contador de tiempo (5 min)
    @Default('') String verificationCode, // CÃ³digo ingresado
  }) = _PhoneValidationState;
}
```

**Propiedades:**

-   `status`: Estado actual del proceso
-   `requestId`: Identificador Ãºnico de la solicitud (generado por API)
-   `phone`: TelÃ©fono siendo validado (enmascarado en logs)
-   `errorMessage`: DescripciÃ³n de errores especÃ­ficos
-   `remainingSeconds`: Tiempo restante en segundos (5 min = 300 seg)
-   `verificationCode`: CÃ³digo OTP ingresado por el usuario

#### PhoneValidationStatus (Enum)

Estados posibles durante el proceso:

```dart
enum PhoneValidationStatus {
  unverified,          // No validado
  sending,             // Enviando SMS con cÃ³digo
  pendingVerification, // Esperando que usuario ingrese cÃ³digo
  verified,            // TelÃ©fono validado exitosamente âœ…
  error,               // Error en el proceso
  expired,             // CÃ³digo expirÃ³ (5 min)
  cancelled,           // Usuario cancelÃ³
}
```

#### PhoneValidationNotifier

Gestor de estado y lÃ³gica de validaciÃ³n:

```dart
@Riverpod(keepAlive: true)
class PhoneValidationNotifier extends _$PhoneValidationNotifier {
  Timer? _timer;

  @override
  PhoneValidationState build() {
    ref.onDispose(() {
      _timer?.cancel();
    });
    return const PhoneValidationState();
  }

  // MÃ©todos pÃºblicos
  Future<void> validatePhone(String phone) async { }
  Future<void> verifyCode(String code) async { }
  void onPhoneCodeChanged(String phoneCode) { }
  void cancelVerification() { }
  void reset() { }
}
```

**MÃ©todos principales:**

| MÃ©todo                 | ParÃ¡metro          | DescripciÃ³n                          |
| ---------------------- | ------------------ | ------------------------------------ |
| `validatePhone()`      | `String phone`     | EnvÃ­a SMS con cÃ³digo OTP             |
| `verifyCode()`         | `String code`      | Verifica cÃ³digo ingresado            |
| `onPhoneCodeChanged()` | `String phoneCode` | Actualiza cÃ³digo mientras se escribe |
| `cancelVerification()` | -                  | Cancela validaciÃ³n y limpia estado   |
| `reset()`              | -                  | Reinicia a estado inicial            |

**Getters de conveniencia:**

```dart
bool get isVerified => status == PhoneValidationStatus.verified;
bool get isPending => status == PhoneValidationStatus.pendingVerification;
bool get isLoading => status == PhoneValidationStatus.sending;
bool get hasError => status == PhoneValidationStatus.error;
bool get isExpired => status == PhoneValidationStatus.expired;
String get formattedTime => 'MM:SS';
```

### ğŸ”„ Repository Layer

#### PhoneValidationRepository

Encapsula toda la comunicaciÃ³n con API y manejo de errores:

```dart
class PhoneValidationRepository {
  final HttpClient _httpClient;

  PhoneValidationRepository(this._httpClient);

  /// Paso 1: Solicita envÃ­o de cÃ³digo OTP
  Future<PhoneValidationResponse> validatePhoneStep1(
    String phone
  ) async {
    try {
      final request = PhoneValidationRequest(phone: phone);
      final response = await _httpClient.post(
        '/client/validate-phone-step-1',
        data: request.toJson(),
      );
      return PhoneValidationResponse.fromJson(response.data);
    } on DioException catch (e) {
      throw _handleDioError(e);
    }
  }

  /// Paso 2: Verifica cÃ³digo OTP
  Future<void> validatePhoneStep2({
    required String requestId,
    required String phoneCode,
  }) async {
    try {
      final request = PhoneCodeVerificationRequest(
        requestId: requestId,
        phoneCode: phoneCode,
      );
      await _httpClient.post(
        '/client/validate-phone-step-2',
        data: request.toJson(),
      );
    } on DioException catch (e) {
      throw _handleDioError(e);
    }
  }
}
```

**Responsabilidades:**

-   Convertir datos a DTOs
-   Enviar peticiones HTTP
-   Capturar y transformar errores Dio
-   Enmascarar datos sensibles en logs

### ğŸ¨ UI Components

#### FirstLoanStepOneScreen

Pantalla que solicita informaciÃ³n personal, incluyendo validaciÃ³n del telÃ©fono:

**Secciones principales:**

1. Campo de entrada de telÃ©fono
2. ValidaciÃ³n en tiempo real del formato
3. BotÃ³n para iniciar validaciÃ³n
4. Indicador de estado de verificaciÃ³n

#### PhoneVerificationModal

Modal que captura el cÃ³digo OTP del usuario:

**CaracterÃ­sticas:**

-   Campo de entrada para 6 dÃ­gitos
-   Auto-detecciÃ³n de SMS entrantes
-   Contador regresivo visible
-   Mensaje de error si cÃ³digo es incorrecto
-   BotÃ³n para solicitar nuevo cÃ³digo
-   OpciÃ³n de cancelar

**CÃ³digo ejemplo:**

```dart
PinFieldAutoFill(
  controller: _otpController,
  codeLength: 6,
  autoFocus: true,
  onCodeChanged: (code) {
    if (code?.length == 6) {
      ref.read(phoneValidationProvider.notifier).verifyCode(code!);
    }
  },
)
```

---

## APIs Utilizadas

### Paso 1: Solicitar CÃ³digo OTP

#### `POST /client/validate-phone-step-1`

**DescripciÃ³n**: Solicita que se envÃ­e un cÃ³digo OTP por SMS al nÃºmero telefÃ³nico especificado.

**Headers Requeridos**:

```
Content-Type: application/json
Authorization: Bearer <token>
Language: es
```

**Request Body**:

```json
{
    "phone": "+503XXXXXXXX"
}
```

**Formatos aceptados:**

-   Local: `77771234` (8 dÃ­gitos)
-   Formato local con guiÃ³n: `7777-1234`
-   Internacional: `+503 7777 1234`
-   Internacional compacto: `+50377771234`
-   Con espacios: `+503 7777 1234`

**Response Exitosa (200 OK)**:

```json
{
    "data": {
        "requestId": "550e8400-e29b-41d4-a716-446655440000"
    }
}
```

**Respuestas de Error**:

| CÃ³digo | SituaciÃ³n           | Mensaje                       | AcciÃ³n                     |
| ------ | ------------------- | ----------------------------- | -------------------------- |
| 400    | Error general       | VarÃ­o segÃºn servidor          | Reintentar despuÃ©s         |
| 401    | No autenticado      | "Usuario no autenticado"      | Redirigir a login          |
| 422    | ValidaciÃ³n fallida  | EspecÃ­fico del campo          | Mostrar mensaje al usuario |
| 429    | Demasiados intentos | "LÃ­mite de intentos excedido" | Mostrar tiempo de espera   |
| 500    | Error del servidor  | "Error interno del servidor"  | Reintentar despuÃ©s         |

**Ejemplo respuesta 422 (validaciÃ³n):**

```json
{
    "errors": [
        {
            "code": "ValidationError",
            "message": "El nÃºmero de telÃ©fono no es vÃ¡lido"
        }
    ]
}
```

### Paso 2: Verificar CÃ³digo OTP

#### `POST /client/validate-phone-step-2`

**DescripciÃ³n**: Verifica que el cÃ³digo OTP ingresado por el usuario sea correcto.

**Headers Requeridos**:

```
Content-Type: application/json
Authorization: Bearer <token>
Language: es
```

**Request Body**:

```json
{
    "requestId": "550e8400-e29b-41d4-a716-446655440000",
    "phoneCode": "123456"
}
```

**Response Exitosa (200 OK)**:

```json
{
    "data": {
        "message": "TelÃ©fono verificado exitosamente"
    }
}
```

**Respuestas de Error**:

| CÃ³digo | SituaciÃ³n             | Mensaje                              | AcciÃ³n                 |
| ------ | --------------------- | ------------------------------------ | ---------------------- |
| 400    | CÃ³digo invÃ¡lido       | "CÃ³digo incorrecto"                  | Pedir reintentar       |
| 400    | requestId expirado    | "Solicitud de verificaciÃ³n expirada" | Solicitar nuevo cÃ³digo |
| 422    | ValidaciÃ³n del cÃ³digo | "CÃ³digo debe ser 6 dÃ­gitos"          | Corregir entrada       |
| 401    | No autenticado        | "Usuario no autenticado"             | Redirigir a login      |
| 500    | Error del servidor    | VarÃ­o                                | Reintentar despuÃ©s     |

---

## Manejo de Errores

### ğŸš¨ Estrategia de Errores

La aplicaciÃ³n maneja errores en mÃºltiples niveles para proporcionar feedback claro:

#### 1. Nivel Repository: PhoneValidationException

```dart
class PhoneValidationException implements Exception {
  final String message;
  final int? statusCode;
  final PhoneValidationExceptionType type;
  final Map<String, dynamic>? data;

  const PhoneValidationException({
    required this.message,
    this.statusCode,
    required this.type,
    this.data,
  });
}

enum PhoneValidationExceptionType {
  network,      // Errores HTTP
  validation,   // ValidaciÃ³n fallida
  unauthorized, // No autenticado
  unknown,      // Error inesperado
}
```

#### 2. Nivel Notifier: Captura y TransformaciÃ³n

```dart
Future<void> validatePhone(String phone) async {
  try {
    // ... lÃ³gica
  } on PhoneValidationException catch (e, stackTrace) {
    String errorMessage = 'Error al enviar cÃ³digo';

    // Extraer mensaje especÃ­fico segÃºn tipo de error
    if (e.statusCode == 422) {
      // Error de validaciÃ³n de datos
      if (e.data?['phone'] != null) {
        errorMessage = e.data!['phone']['message'];
      }
    } else if (e.statusCode == 401) {
      errorMessage = 'Usuario no autenticado';
    }

    // Registrar error con contexto
    LoggingService.error(
      'Phone validation failed',
      tag: 'PHONE_VALIDATION',
      error: e,
      stackTrace: stackTrace,
      data: {'status_code': e.statusCode},
    );

    state = state.copyWith(
      status: PhoneValidationStatus.error,
      errorMessage: errorMessage,
    );
  }
}
```

#### 3. Nivel UI: PresentaciÃ³n al Usuario

```dart
if (state.hasError) {
  return ErrorWidget(
    message: state.errorMessage,
    onRetry: () {
      ref.read(phoneValidationProvider.notifier).validatePhone(phone);
    },
  );
}
```

### ğŸ“Š Ãrbol de DecisiÃ³n de Errores

```
PhoneValidationException
â”‚
â”œâ”€> Tipo: NETWORK
â”‚   â”œâ”€> 400: Error general
â”‚   â”‚   â””â”€> Mostrar: "Error al procesar solicitud"
â”‚   â”‚
â”‚   â”œâ”€> 401: No autenticado
â”‚   â”‚   â””â”€> Mostrar: "Usuario no autenticado"
â”‚   â”‚   â””â”€> AcciÃ³n: Redirigir a login
â”‚   â”‚
â”‚   â”œâ”€> 408/Timeout
â”‚   â”‚   â””â”€> Mostrar: "Tiempo de conexiÃ³n agotado"
â”‚   â”‚   â””â”€> AcciÃ³n: BotÃ³n reintentar
â”‚   â”‚
â”‚   â”œâ”€> 422: ValidaciÃ³n
â”‚   â”‚   â”œâ”€> phone error
â”‚   â”‚   â”‚   â””â”€> Mostrar: Mensaje especÃ­fico del campo
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€> Otros
â”‚   â”‚       â””â”€> Mostrar: Mensaje de error del API
â”‚   â”‚
â”‚   â””â”€> 429: LÃ­mite de intentos
â”‚       â””â”€> Mostrar: "Demasiados intentos. Intenta despuÃ©s"
â”‚
â”œâ”€> Tipo: VALIDATION
â”‚   â””â”€> Mostrar: "Datos de validaciÃ³n invÃ¡lidos"
â”‚
â”œâ”€> Tipo: UNKNOWN
â”‚   â””â”€> Mostrar: "Error inesperado: [mensaje]"
â”‚
â””â”€> Exception genÃ©rica
    â””â”€> Mostrar: "Error inesperado. Intenta mÃ¡s tarde"
```

### â° Manejo de ExpiraciÃ³n

```dart
void _startCountdown() {
  _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
    if (!ref.mounted) {
      timer.cancel();
      return;
    }

    if (state.remainingSeconds <= 0) {
      timer.cancel();
      state = state.copyWith(
        status: PhoneValidationStatus.expired,
        errorMessage: 'El cÃ³digo ha expirado. Solicita uno nuevo',
      );
      // Mostrar botÃ³n "Solicitar nuevo cÃ³digo"
    } else {
      state = state.copyWith(
        remainingSeconds: state.remainingSeconds - 1,
      );
    }
  });
}
```

---

## ğŸ” Seguridad

### Consideraciones Importantes

#### 1. ProtecciÃ³n de Datos Sensibles

-   **NÃºmeros telefÃ³nicos**:

    -   Se enmascaran en logs: `****1234`
    -   No se guardan en cachÃ© local sin encriptaciÃ³n
    -   Se transmiten solo vÃ­a HTTPS

-   **CÃ³digos OTP**:

    -   Nunca se almacenan en localStorage sin encriptaciÃ³n
    -   Se limpian automÃ¡ticamente despuÃ©s de verificaciÃ³n
    -   Tiempo de expiraciÃ³n: 5 minutos

-   **Request ID**:
    -   Ãšnico por solicitud
    -   Generado por servidor
    -   Tied a usuario y sesiÃ³n

#### 2. ValidaciÃ³n Server-Side

```
CLIENTE                           SERVIDOR
   â”œâ”€ Validar formato
   â””â”€ Mostrar error           (Primera lÃ­nea)
                                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ VALIDACIÃ“N SERVER   â”‚
                        â”‚ (AUTORIDAD)         â”‚
                        â”‚                     â”‚
                        â”œâ”€ Validar formato   â”‚
                        â”œâ”€ Validar campo     â”‚
                        â”œâ”€ Verificar estado  â”‚
                        â””â”€ Generar OTP       â”‚
```

#### 3. Rate Limiting

El servidor implementa lÃ­mites para prevenir abuso:

-   **MÃ¡x 3 intentos** por telÃ©fono en 24 horas
-   **MÃ¡x 5 minutos** por cÃ³digo
-   **MÃ¡x 1 solicitud** por 2 minutos

#### 4. AutenticaciÃ³n

-   Todas las peticiones requieren token Bearer
-   Token se valida en cada paso
-   Se cancela todo si token expira

#### 5. PrevenciÃ³n de Ataques

**Ataques prevenidos:**

-   Brute force: Rate limiting + cÃ³digos Ãºnicos
-   Hijacking: ValidaciÃ³n server-side del telÃ©fono
-   MITM: HTTPS obligatorio
-   Replay: RequestId Ãºnico + tiempo limitado

---

## ğŸ“ Resumen de Capas

| Capa           | Componente                | Responsabilidad       |
| -------------- | ------------------------- | --------------------- |
| **UI**         | FirstLoanStepOneScreen    | Entrada de telÃ©fono   |
| **UI**         | PhoneVerificationModal    | Captura de cÃ³digo OTP |
| **State**      | PhoneValidationNotifier   | Orquestar flujo       |
| **State**      | PhoneValidationState      | Mantener estado       |
| **Repository** | PhoneValidationRepository | Acceso a API          |
| **Data**       | HttpClient                | ComunicaciÃ³n HTTP     |
| **Domain**     | DTOs                      | Modelos de datos      |

---

## ğŸš€ PrÃ³ximos Pasos

1. **BiometrÃ­a**: Agregar validaciÃ³n por huella dactilar
2. **Llamada verificadora**: Alternativa a SMS
3. **CachÃ© de validaciones**: Cachear validaciones previas
4. **Analytics**: Rastrear Ã©xito/fracaso de validaciones
5. **A/B Testing**: Optimizar mensajes y tiempos
6. **IntegraciÃ³n con backup codes**: Para usuarios sin acceso a SMS

---

## ğŸ“š Referencia de Archivos

```
ğŸ“ lib/features/first_loan/
â”œâ”€â”€ ğŸ“„ entities/first_loan_request.dart
â”œâ”€â”€ ğŸ“„ entities/first_loan_step.dart
â”œâ”€â”€ ğŸ“„ models/first_loan_request.dart
â”œâ”€â”€ ğŸ“„ providers/phone_validation_provider.dart
â”œâ”€â”€ ğŸ“„ providers/first_loan_step_one_provider.dart
â”œâ”€â”€ ğŸ“„ repositories/first_loan_repository.dart
â”œâ”€â”€ ğŸ“„ screens/first_loan_step_one_screen.dart
â”‚   â””â”€â”€ ğŸ“„ widgets/phone_verification_modal.dart
â”‚

ğŸ“ lib/shared/phone_validation/
â”œâ”€â”€ ğŸ“„ repositories/phone_validation_repository.dart
â””â”€â”€ ğŸ“„ models/
    â”œâ”€â”€ ğŸ“„ phone_validation_request.dart
    â”œâ”€â”€ ğŸ“„ phone_validation_response.dart
    â”œâ”€â”€ ğŸ“„ phone_code_verification_request.dart
    â””â”€â”€ ğŸ“„ phone_code_verification_response.dart
```

---

## ğŸ”— RelaciÃ³n con Otros Features

-   **Primer PrÃ©stamo**: Paso 1 requiere validaciÃ³n telefÃ³nica
-   **Perfil del Cliente**: Reutiliza lÃ³gica de validaciÃ³n en cambio de telÃ©fono
-   **AutenticaciÃ³n**: Comparte mecanismo de OTP

---

**VersiÃ³n**: 1.0
**Ãšltima actualizaciÃ³n**: Octubre 2024
**Autor**: Equipo de Desarrollo Pisto
**Estado**: ProducciÃ³n âœ…
