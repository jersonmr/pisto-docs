---
title: Flujo de Validaci√≥n de C√≥digo Promocional
slug: validacion-de-codigo-promocional
tags: [auth, promocodes, flutter, riverpod, dio, formz]
description: Flujo de validaci√≥n de c√≥digo promocional..
---

## Descripci√≥n General

La funcionalidad de **Validaci√≥n de C√≥digo Promocional** permite a los usuarios de Pisto gestionar y utilizar c√≥digos promocionales. Esta caracter√≠stica facilita el programa de referidos, donde los usuarios pueden compartir su c√≥digo promocional personal con otros usuarios para obtener descuentos en sus pr√©stamos.

### Caracter√≠sticas Principales

-   ‚úÖ **Ver c√≥digo promocional personal**: Cada usuario tiene un c√≥digo √∫nico que puede compartir
-   ‚úÖ **Copiar al portapapeles**: Facilita el compartir el c√≥digo con otros usuarios
-   ‚úÖ **Historial de uso**: Seguimiento de cu√°ntas veces ha sido utilizado el c√≥digo propio
-   ‚úÖ **Descuentos por referidos**: Visualizar descuentos disponibles por amigos referidos
-   ‚úÖ **Historial de c√≥digos usados**: Registro de c√≥digos promocionales de otros usuarios que ha utilizado
-   ‚úÖ **Validar c√≥digos**: Verificar la validez de c√≥digos antes de aplicarlos

---

## Gu√≠a del Usuario

### üéØ ¬øPara qu√© sirve?

El c√≥digo promocional es un beneficio del programa de referidos de Pisto:

1. **Para ti como usuario referidor**:

    - Tu c√≥digo promocional es √∫nico y personal
    - Puedes compartirlo con amigos
    - Cada vez que un amigo utiliza tu c√≥digo, acumulas descuentos

2. **Para el usuario que usa tu c√≥digo**:
    - Obtiene un descuento en la solicitud del pr√©stamo
    - Valida el c√≥digo antes de aplicarlo

### üì± Pasos para usar tu c√≥digo promocional

#### Paso 1: Acceder a la secci√≥n de C√≥digo Promocional

-   Navega a la pantalla "C√≥digo Promocional"
-   Ver√°s tu c√≥digo personal al inicio de la pantalla

#### Paso 2: Copiar tu c√≥digo

-   Presiona el bot√≥n **"Copiar"** junto a tu c√≥digo
-   Recibir√°s una confirmaci√≥n: "Copiado al portapapeles"
-   Tu c√≥digo ya est√° listo para compartir

#### Paso 3: Compartir el c√≥digo

-   Puedes usar cualquier medio: WhatsApp, email, SMS, etc.
-   Tu c√≥digo es: 7-12 caracteres alfanum√©ricos
-   Ejemplo: `NAG45RF`, `75YALMV`

#### Paso 4: Ver historial y descuentos

-   **Tabla de historial**: Muestra cada versi√≥n de tu c√≥digo, cu√°ntas veces ha sido utilizado y si est√° activo
-   **Descuentos disponibles**: Cantidad de descuentos acumulados por referidos
-   **C√≥digos que has usado**: Tabla con los c√≥digos de otros usuarios que has utilizado y la fecha

### ‚ö†Ô∏è Importante

-   **No puedes usar tu propio c√≥digo**: El sistema lo validar√° y rechazar√°
-   **Cada c√≥digo tiene validez limitada**: Algunos pueden estar inactivos
-   **Los descuentos se acumulan**: Cada referido exitoso suma un descuento
-   **Validaci√≥n obligatoria**: Antes de aplicar un c√≥digo, debe ser validado

---

## Arquitectura T√©cnica

### üèóÔ∏è Patr√≥n de Arquitectura

La funcionalidad sigue una arquitectura **Feature-Based** con capas claramente definidas:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Presentation Layer (UI)             ‚îÇ
‚îÇ    promo_code_history_screen.dart           ‚îÇ
‚îÇ         + Widgets reutilizables             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      State Management Layer                 ‚îÇ
‚îÇ    PromoCodeHistoryProvider (Riverpod)      ‚îÇ
‚îÇ    PromoCodeHistoryNotifier                 ‚îÇ
‚îÇ    PromoCodeHistoryState (Freezed)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Repository Layer                    ‚îÇ
‚îÇ    PromoCodeHistoryRepository               ‚îÇ
‚îÇ    (Interface + Implementaci√≥n)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Data Layer (API)                    ‚îÇ
‚îÇ    HttpClient provider                      ‚îÇ
‚îÇ    /client/promo-code endpoint              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üß© Estructura de Directorios

```
lib/features/promo_code/
‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ promo_code_history_entity.dart          # Entity principal
‚îÇ   ‚îú‚îÄ‚îÄ times_used_own_code_entity.dart         # Historial de uso propio
‚îÇ   ‚îî‚îÄ‚îÄ used_foreign_promo_code_entity.dart     # C√≥digos externos usados
‚îÇ
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ promo_code_history_response_dto.dart    # DTO respuesta API
‚îÇ   ‚îú‚îÄ‚îÄ times_used_own_code_dto.dart            # DTO historial propio
‚îÇ   ‚îî‚îÄ‚îÄ used_foreign_promo_code_dto.dart        # DTO c√≥digos externos
‚îÇ
‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îú‚îÄ‚îÄ promo_code_history_provider.dart        # Notifier + State
‚îÇ   ‚îî‚îÄ‚îÄ providers.dart                          # Barrel file
‚îÇ
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îú‚îÄ‚îÄ promo_code_history_repository.dart      # L√≥gica de acceso a datos
‚îÇ   ‚îî‚îÄ‚îÄ repositories.dart                       # Barrel file
‚îÇ
‚îú‚îÄ‚îÄ screens/
‚îÇ   ‚îú‚îÄ‚îÄ promo_code_history_screen.dart          # Pantalla principal
‚îÇ   ‚îî‚îÄ‚îÄ widgets/
‚îÇ       ‚îî‚îÄ‚îÄ (Widgets reutilizables)
‚îÇ
‚îî‚îÄ‚îÄ IMPLEMENTATION_PLAN.md
```

---

## Flujo de Datos

### üîÑ Flujo Principal: Carga de C√≥digo Promocional

```
1. Usuario accede a PromoCodeHistoryScreen
   ‚îÇ
   ‚îú‚îÄ> initState()
   ‚îÇ   ‚îî‚îÄ> loadPromoCodeHistory()
   ‚îÇ
2. PromoCodeHistoryNotifier.loadPromoCodeHistory()
   ‚îÇ
   ‚îú‚îÄ> state = loading
   ‚îÇ   ‚îî‚îÄ> PromoCodeHistoryStatus.loading
   ‚îÇ
3. PromoCodeHistoryRepository.getPromoCodeHistory()
   ‚îÇ
   ‚îú‚îÄ> HttpClient.get('/client/promo-code')
   ‚îÇ   ‚îî‚îÄ> API Response (200 OK)
   ‚îÇ
4. Response -> DTO -> Entity
   ‚îÇ
   ‚îú‚îÄ> PromoCodeHistoryResponseDto.fromJson()
   ‚îÇ   ‚îî‚îÄ> dto.toEntity() -> PromoCodeHistoryEntity
   ‚îÇ
5. Update State
   ‚îÇ
   ‚îú‚îÄ> state = loaded + data
   ‚îÇ   ‚îî‚îÄ> PromoCodeHistoryStatus.loaded
   ‚îÇ
6. UI Rebuild
   ‚îÇ
   ‚îî‚îÄ> Mostrar c√≥digo, tablas e informaci√≥n
```

### üîÑ Flujo de Copiar C√≥digo

```
1. Usuario presiona bot√≥n "Copiar"
   ‚îÇ
2. Clipboard.setData(ClipboardData(text: promoCode))
   ‚îÇ
3. ScaffoldMessenger.showSnackBar()
   ‚îÇ
‚îî‚îÄ> Mostrar feedback: "Copiado al portapapeles"
```

### üîÑ Flujo de Validaci√≥n de C√≥digo (Future)

```
1. Usuario ingresa c√≥digo en formulario
   ‚îÇ
2. Usuario presiona "Aplicar"
   ‚îÇ
3. PromoCodeValidator.validate(code)
   ‚îÇ
4. POST /client/validate-promo-code
   ‚îÇ
5. Respuesta:
   ‚îú‚îÄ> 200: V√°lido (aplicar descuento)
   ‚îú‚îÄ> 422: Errores espec√≠ficos
   ‚îÇ   ‚îú‚îÄ> C√≥digo ya utilizado
   ‚îÇ   ‚îú‚îÄ> C√≥digo propio
   ‚îÇ   ‚îî‚îÄ> C√≥digo err√≥neo
   ‚îî‚îÄ> 401: No autenticado
```

---

## Componentes

### üì¶ Entities (Domain Models)

#### PromoCodeHistoryEntity

Modelo principal que encapsula toda la informaci√≥n del c√≥digo promocional del usuario.

```dart
@freezed
abstract class PromoCodeHistoryEntity with _$PromoCodeHistoryEntity {
  const factory PromoCodeHistoryEntity({
    required String promoCode,                              // C√≥digo √∫nico
    required List<TimesUsedOwnCodeEntity> timesUsedOwnCode, // Historial propio
    required int referralDiscounts,                          // Descuentos acumulados
    required List<UsedForeignPromoCodeEntity> usedForeignPromoCodes, // C√≥digos usados
  }) = _PromoCodeHistoryEntity;
}
```

**Propiedades:**

-   `promoCode` (String): C√≥digo promocional √∫nico del usuario (ej: "NAG45RF")
-   `timesUsedOwnCode` (List\<TimesUsedOwnCodeEntity\>): Historial de todas las versiones del c√≥digo propio
-   `referralDiscounts` (int): Cantidad total de descuentos acumulados
-   `usedForeignPromoCodes` (List\<UsedForeignPromoCodeEntity\>): C√≥digos de otros usuarios que ha utilizado

#### TimesUsedOwnCodeEntity

Representa cada versi√≥n del c√≥digo propio y su uso.

```dart
@freezed
abstract class TimesUsedOwnCodeEntity with _$TimesUsedOwnCodeEntity {
  const factory TimesUsedOwnCodeEntity({
    required String code,        // C√≥digo (puede cambiar en el tiempo)
    required int quantity,       // Veces utilizado por referidos
    required bool active,        // ¬øEst√° activo?
  }) = _TimesUsedOwnCodeEntity;
}
```

#### UsedForeignPromoCodeEntity

Representa un c√≥digo de otro usuario que ha sido utilizado.

```dart
@freezed
abstract class UsedForeignPromoCodeEntity with _$UsedForeignPromoCodeEntity {
  const factory UsedForeignPromoCodeEntity({
    required String code,        // C√≥digo usado
    required DateTime date,      // Fecha de uso
  }) = _UsedForeignPromoCodeEntity;
}
```

### üé® Widgets

#### PromoCodeHistoryScreen

Pantalla principal que muestra toda la informaci√≥n.

**Secciones:**

1. **Instrucci√≥n**: "Tu c√≥digo de promoci√≥n personal es"
2. **C√≥digo Promocional**: Muestra el c√≥digo + bot√≥n Copiar
3. **Instrucciones de Uso**: Explicaci√≥n de c√≥mo usar el c√≥digo
4. **Historial de C√≥digos**: Tabla con c√≥digo, veces usado y estado
5. **Descuentos por Referidos**: Total de descuentos acumulados
6. **C√≥digos Usados**: Tabla con c√≥digos ajenos y fechas de uso

**Caracter√≠sticas:**

-   RefreshIndicator para recargar datos
-   Manejo de estados: loading, loaded, error
-   Mensajes de error con bot√≥n "Reintentar"
-   Formato de fechas en tabla: DD/MM/YYYY

### üîå State Management

#### PromoCodeHistoryState

Estado que Freezed mantiene durante toda la sesi√≥n.

```dart
@freezed
abstract class PromoCodeHistoryState with _$PromoCodeHistoryState {
  const factory PromoCodeHistoryState({
    @Default(PromoCodeHistoryStatus.initial)
    PromoCodeHistoryStatus status,
    @Default(null) PromoCodeHistoryEntity? data,
    @Default(null) String? errorMessage,
  }) = _PromoCodeHistoryState;

  // Getters de conveniencia
  bool get isLoading => status == PromoCodeHistoryStatus.loading;
  bool get isLoaded => status == PromoCodeHistoryStatus.loaded;
  bool get hasError => status == PromoCodeHistoryStatus.error;
  bool get hasData => data != null;
}
```

**Estados posibles:**

-   `initial`: Sin cargar a√∫n
-   `loading`: Solicitando datos a la API
-   `loaded`: Datos disponibles
-   `error`: Fall√≥ la carga

#### PromoCodeHistoryNotifier

Gestiona la l√≥gica y las transiciones de estado.

```dart
@Riverpod(keepAlive: true)
class PromoCodeHistoryNotifier extends _$PromoCodeHistoryNotifier {
  PromoCodeHistoryRepository get _repository =>
      ref.read(promoCodeHistoryRepositoryProvider);

  @override
  PromoCodeHistoryState build() {
    return const PromoCodeHistoryState();
  }

  // M√©todos p√∫blicos
  Future<void> loadPromoCodeHistory() async { }
  Future<void> refresh() async { }
  void clearError() { }
  void reset() { }
}
```

**M√©todos:**

-   `loadPromoCodeHistory()`: Carga inicial con protecci√≥n contra m√∫ltiples llamadas
-   `refresh()`: Recarga los datos (desde RefreshIndicator)
-   `clearError()`: Limpia el mensaje de error
-   `reset()`: Reinicia el estado a inicial

### üîÑ Repository

#### PromoCodeHistoryRepository

Encapsula la l√≥gica de acceso a datos y manejo de errores.

```dart
class PromoCodeHistoryRepository {
  final HttpClient _httpClient;

  PromoCodeHistoryRepository(this._httpClient);

  Future<PromoCodeHistoryEntity> getPromoCodeHistory() async {
    try {
      final response = await _httpClient.get('/client/promo-code');
      final dto = PromoCodeHistoryResponseDto.fromJson(response.data);
      return dto.toEntity();
    } on DioException catch (e) {
      throw _handleDioError(e);
    } catch (e) {
      throw PromoCodeHistoryException('Error inesperado: ${e.toString()}');
    }
  }

  PromoCodeHistoryException _handleDioError(DioException e) { }
}
```

**Funcionalidades:**

-   Convierte respuesta JSON a DTO y luego a Entity
-   Manejo espec√≠fico de errores Dio (timeouts, 401, etc.)
-   Extrae mensajes de error de respuestas de API

---

## APIs Utilizadas

### Endpoint Principal

#### `GET /client/promo-code`

**Descripci√≥n**: Obtiene la informaci√≥n completa del c√≥digo promocional del usuario autenticado.

**Headers Requeridos**:

```
Content-Type: application/json
Authorization: Bearer <token>
Language: es
```

**Respuesta Exitosa (200 OK)**:

```json
{
    "data": {
        "promoCode": "NAG45RF",
        "timesUsedOwnCode": [
            {
                "code": "NAG45RF",
                "quantity": 3,
                "active": true
            }
        ],
        "referralDiscounts": 3,
        "usedForeignPromoCodes": [
            {
                "code": "75YALMV",
                "date": "2024-10-15"
            },
            {
                "code": "ABC12XY",
                "date": "2024-09-20"
            }
        ]
    }
}
```

**Posibles Respuestas de Error**:

| C√≥digo | Escenario              | Acci√≥n                           |
| ------ | ---------------------- | -------------------------------- |
| 401    | Usuario no autenticado | Redirigir a login                |
| 408    | Timeout                | Mostrar error y bot√≥n reintentar |
| 422    | Datos inv√°lidos        | Mostrar mensaje espec√≠fico       |
| 500    | Error del servidor     | Mostrar error gen√©rico           |

---

## Manejo de Errores

### üö® Estrategia de Errores

La aplicaci√≥n maneja errores en m√∫ltiples niveles:

#### 1. Nivel Repository

```dart
class PromoCodeHistoryException implements Exception {
  final String message;
  final int? statusCode;

  PromoCodeHistoryException(this.message, {this.statusCode});
}
```

**Tipos de Errores Capturados**:

-   `DioException`: Errores de red
-   `SocketException`: Problemas de conexi√≥n
-   Excepciones gen√©ricas: Errores inesperados

#### 2. Nivel Notifier

```dart
Future<void> loadPromoCodeHistory() async {
  if (state.isLoading) return; // Protecci√≥n

  state = state.copyWith(status: PromoCodeHistoryStatus.loading);

  try {
    final data = await _repository.getPromoCodeHistory();
    state = state.copyWith(
      status: PromoCodeHistoryStatus.loaded,
      data: data,
    );
  } on PromoCodeHistoryException catch (e) {
    state = state.copyWith(
      status: PromoCodeHistoryStatus.error,
      errorMessage: e.message,
    );
  }
}
```

#### 3. Nivel UI

```dart
if (state.hasError) {
  return _buildErrorWidget(ref, state.errorMessage!);
}
```

### üìä √Årbol de Manejo de Errores

```
PromoCodeHistoryException
‚îú‚îÄ> 401: Usuario no autenticado
‚îú‚îÄ> 408: Timeout de conexi√≥n
‚îú‚îÄ> 422: Datos inv√°lidos
‚îî‚îÄ> Otros: Error inesperado

‚Üì

UI muestra:
‚îú‚îÄ> √çcono de error
‚îú‚îÄ> Mensaje espec√≠fico
‚îî‚îÄ> Bot√≥n "Reintentar"
```

---

## Testing

### üß™ Estrategia de Tests

#### 1. Unit Tests - Repository

```dart
group('PromoCodeHistoryRepository', () {
  late MockHttpClient mockHttpClient;
  late PromoCodeHistoryRepository repository;

  setUp(() {
    mockHttpClient = MockHttpClient();
    repository = PromoCodeHistoryRepository(mockHttpClient);
  });

  test('getPromoCodeHistory returns PromoCodeHistoryEntity when successful',
    () async {
      // Mock response
      when(mockHttpClient.get('/client/promo-code'))
          .thenAnswer((_) async => Response(
            data: {
              'data': {
                'promoCode': 'NAG45RF',
                'timesUsedOwnCode': [],
                'referralDiscounts': 0,
                'usedForeignPromoCodes': [],
              }
            },
            statusCode: 200,
          ));

      final result = await repository.getPromoCodeHistory();

      expect(result.promoCode, equals('NAG45RF'));
      verify(mockHttpClient.get('/client/promo-code')).called(1);
    },
  );

  test('getPromoCodeHistory throws on 401', () async {
    when(mockHttpClient.get('/client/promo-code'))
        .thenThrow(DioException(
          requestOptions: RequestOptions(path: ''),
          response: Response(
            statusCode: 401,
            data: {'errors': [{'message': 'Usuario no autenticado'}]}
          ),
        ));

    expect(
      () => repository.getPromoCodeHistory(),
      throwsA(isA<PromoCodeHistoryException>()),
    );
  });
});
```

#### 2. State Management Tests

```dart
group('PromoCodeHistoryNotifier', () {
  late ProviderContainer container;
  late MockPromoCodeHistoryRepository mockRepository;

  setUp(() {
    mockRepository = MockPromoCodeHistoryRepository();
    container = ProviderContainer(
      overrides: [
        promoCodeHistoryRepositoryProvider.overrideWithValue(mockRepository),
      ],
    );
  });

  test('initial state is correct', () {
    final state = container.read(promoCodeHistoryProvider);
    expect(state.status, equals(PromoCodeHistoryStatus.initial));
    expect(state.data, isNull);
  });

  test('loadPromoCodeHistory updates state correctly', () async {
    final entity = PromoCodeHistoryEntity(
      promoCode: 'TEST123',
      timesUsedOwnCode: [],
      referralDiscounts: 5,
      usedForeignPromoCodes: [],
    );

    when(mockRepository.getPromoCodeHistory())
        .thenAnswer((_) async => entity);

    final notifier = container.read(promoCodeHistoryProvider.notifier);
    await notifier.loadPromoCodeHistory();

    final state = container.read(promoCodeHistoryProvider);
    expect(state.status, equals(PromoCodeHistoryStatus.loaded));
    expect(state.data, equals(entity));
  });
});
```

#### 3. Widget Tests

```dart
group('PromoCodeHistoryScreen', () {
  testWidgets('displays promo code correctly', (WidgetTester tester) async {
    final mockRef = createMockRef();

    await tester.pumpWidget(
      ProviderScope(
        container: container,
        child: const MaterialApp(
          home: PromoCodeHistoryScreen(),
        ),
      ),
    );

    await tester.pumpAndSettle();

    expect(find.text('NAG45RF'), findsOneWidget);
    expect(find.byText('Copiar'), findsOneWidget);
  });

  testWidgets('copy button copies to clipboard', (WidgetTester tester) async {
    await tester.pumpWidget(/* ... */);

    await tester.tap(find.byText('Copiar'));
    await tester.pumpAndSettle();

    expect(find.byType(SnackBar), findsOneWidget);
  });
});
```

---

## üîê Seguridad

### Consideraciones Importantes

1. **Token de Autenticaci√≥n**:

    - Siempre se env√≠a en headers
    - Validado en cada petici√≥n
    - Se renueva autom√°ticamente si expira

2. **Validaci√≥n de C√≥digos**:

    - Servidor valida c√≥digos antes de aplicarlos
    - Cliente nunca modifica el descuento directamente
    - Validaci√≥n server-side es autoridad

3. **Datos Sensibles**:
    - C√≥digos personales no se guardan en cach√© local
    - Se cargan bajo demanda
    - Se limpian al logout

---

## üìù Resumen de Capas

| Capa           | Componente                   | Responsabilidad                         |
| -------------- | ---------------------------- | --------------------------------------- |
| **UI**         | `PromoCodeHistoryScreen`     | Mostrar datos, capturar interacciones   |
| **State**      | `PromoCodeHistoryNotifier`   | Gestionar estado, orquestar operaciones |
| **Repository** | `PromoCodeHistoryRepository` | Acceso a datos, manejo de errores       |
| **Data**       | `HttpClient`                 | Comunicaci√≥n con API                    |
| **Domain**     | `PromoCodeHistoryEntity`     | Modelo de dominio puro                  |

---

## üöÄ Pr√≥ximos Pasos

1. **Validaci√≥n de C√≥digos**: Implementar flujo de validaci√≥n al ingresar c√≥digo
2. **Cach√© Local**: Guardar √∫ltima respuesta conocida para modo offline
3. **Analytics**: Rastrear uso de c√≥digos promocionales
4. **Notificaciones**: Alertar cuando se logra un nuevo descuento
5. **Compartir Mejorado**: Integraci√≥n nativa con apps de mensajer√≠a

---

## üìö Referencia de Archivos

```
üìÅ lib/features/promo_code/
‚îú‚îÄ‚îÄ üìÑ entities/promo_code_history_entity.dart
‚îú‚îÄ‚îÄ üìÑ entities/times_used_own_code_entity.dart
‚îú‚îÄ‚îÄ üìÑ entities/used_foreign_promo_code_entity.dart
‚îú‚îÄ‚îÄ üìÑ models/promo_code_history_response_dto.dart
‚îú‚îÄ‚îÄ üìÑ models/times_used_own_code_dto.dart
‚îú‚îÄ‚îÄ üìÑ models/used_foreign_promo_code_dto.dart
‚îú‚îÄ‚îÄ üìÑ providers/promo_code_history_provider.dart
‚îú‚îÄ‚îÄ üìÑ repositories/promo_code_history_repository.dart
‚îú‚îÄ‚îÄ üìÑ screens/promo_code_history_screen.dart
‚îî‚îÄ‚îÄ üìÑ IMPLEMENTATION_PLAN.md
```

---

**Versi√≥n**: 1.0
**√öltima actualizaci√≥n**: Octubre 2024
**Autor**: Equipo de Desarrollo Pisto
**Estado**: Producci√≥n ‚úÖ
